# JSON格式自动修复功能说明

## 📋 概述

AICouncil 已集成了智能JSON格式自动修复功能，可以自动处理LLM输出中常见的JSON格式问题，提高系统的容错能力。

## 🔧 修复能力

### 后端修复（Python）

**位置**: `src/agents/langchain_agents.py`

**修复功能**:
1. ✅ **移除Markdown代码块标记**
   - 自动移除 ` ```json ` 和 ` ``` ` 标记
   - 示例：将 ` ```json\n{...}\n``` ` 清理为 `{...}`

2. ✅ **智能括号匹配提取**
   - 使用状态机进行括号匹配
   - 正确处理字符串内的括号
   - 自动提取完整的JSON对象/数组

3. ✅ **尾随逗号修复**
   - 修复对象末尾的逗号：`{"a": 1,}` → `{"a": 1}`
   - 修复数组末尾的逗号：`[1, 2, 3,]` → `[1, 2, 3]`

4. ✅ **注释移除**
   - 移除单行注释：`{"a": 1 // comment}` → `{"a": 1}`
   - 移除多行注释：`{"a": /* comment */ 1}` → `{"a": 1}`

5. ✅ **连续逗号修复**
   - 修复多余逗号：`{"a": 1,, "b": 2}` → `{"a": 1, "b": 2}`

6. ✅ **前后文本剥离**
   - 自动提取文本中的JSON部分
   - 忽略前导/尾随的说明文字

### 前端修复（JavaScript）

**位置**: `src/web/templates/index.html` - `formatContent()` 函数

**修复功能**:
- 与后端相同的修复逻辑
- 二级重试机制（先尝试直接解析，失败后尝试修复）
- 详细的控制台日志用于调试

## 📊 测试验证

运行测试脚本验证修复功能：

```bash
python tests/test_json_fix.py
```

**测试覆盖**:
- ✅ Markdown代码块包裹
- ✅ 尾随逗号（对象和数组）
- ✅ 单行注释
- ✅ 多行注释
- ✅ 前后额外文本
- ✅ 连续逗号
- ✅ 嵌套复杂结构

**测试结果**: 8/8 通过 ✅

## 🐛 调试支持

### 调试文件自动保存

当JSON解析失败时，系统会自动保存调试文件：

```
workspaces/{session_id}/
├── debug_leader_raw_attempt_1.txt      # 原始LLM输出
├── debug_leader_cleaned_attempt_1.json # 清理后的JSON
├── debug_leader_raw_attempt_2.txt      # 第2次尝试（如果有）
└── ...
```

### 日志级别

```python
# 启用详细日志
LOG_LEVEL=DEBUG python src/web/app.py
```

日志内容：
- JSON清理前后对比
- 解析错误详情
- 重试次数和结果
- Schema验证失败信息

## 🔄 重试机制

**后端重试策略**:
- 最大重试次数：3次
- 每次失败后保存调试文件
- 最后一次失败时打印完整错误堆栈

**前端处理**:
- 流式输出中的JSON可能不完整（正常现象）
- 完整输出后自动重新解析
- 修复失败时显示纯文本`<pre>`

## 📝 使用示例

### 示例1: 带Markdown标记的输出

**LLM输出**:
```
这是我的方案：

```json
{
    "core_idea": "核心思路",
    "steps": ["步骤1", "步骤2"],
}
```
```

**自动修复为**:
```json
{
    "core_idea": "核心思路",
    "steps": ["步骤1", "步骤2"]
}
```

### 示例2: 带注释的输出

**LLM输出**:
```json
{
    "name": "测试方案", // 这是方案名称
    "priority": 1, /* 优先级
                      最高优先级 */
    "status": "active",
}
```

**自动修复为**:
```json
{
    "name": "测试方案",
    "priority": 1,
    "status": "active"
}
```

## ⚠️ 限制和注意事项

1. **不支持修复的问题**:
   - 缺少引号的键名：`{name: "value"}` ❌
   - 单引号字符串：`{'name': 'value'}` ❌
   - 未闭合的括号：`{"a": 1` ❌（除非是流式输出）

2. **最佳实践**:
   - 在Prompt中强调"输出纯JSON，不要添加注释"
   - 使用Schema验证确保输出完整性
   - 检查调试文件定位问题根源

3. **性能考虑**:
   - 修复逻辑在解析失败时才执行
   - 对正常JSON没有额外开销
   - 正则表达式使用已优化

## 🚀 未来改进方向

1. 支持更多JSON变体（如JSONC、JSON5）
2. 智能补全未闭合的括号
3. 使用ML模型预测缺失的字段
4. 可视化修复过程（前端工具）

## 📞 问题反馈

如果遇到无法修复的JSON格式问题：
1. 检查 `workspaces/{session_id}/debug_*` 文件
2. 查看 `aicouncil.log` 日志
3. 提供失败的原始输出示例
4. 描述预期的JSON结构

---

**更新日期**: 2026-01-11  
**版本**: v1.0  
**测试状态**: ✅ 全部通过
