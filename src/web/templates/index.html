<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AICouncil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/vendor/html2canvas.min.js"></script>
    <script src="/static/vendor/jspdf.umd.min.js"></script>
    <style>
        .role-leader { border-left: 4px solid #3b82f6; }
        .role-planner { border-left: 4px solid #10b981; }
        .role-auditor { border-left: 4px solid #f59e0b; }
        .role-reporter { border-left: 4px solid #8b5cf6; }
        .role-devils_advocate { border-left: 4px solid #ef4444; background-color: #fef2f2; }
        .role-reference_refiner { border-left: 4px solid #06b6d4; background-color: #ecfeff; }
        .markdown-body h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .markdown-body h2 { font-size: 1.25rem; font-weight: bold; margin-top: 0.75rem; }
        .markdown-body p { margin-bottom: 0.5rem; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.875rem; }
        .markdown-body th, .markdown-body td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
        .markdown-body th { background-color: #f8fafc; font-weight: bold; }
        .markdown-body tr:nth-child(even) { background-color: #f8fafc; }
        .markdown-body {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        /* æ™ºèƒ½æ··åˆæ¸²æŸ“ç»„ä»¶æ ·å¼ */
        .smart-render-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }
        .smart-render-header {
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .smart-render-header-icon {
            font-size: 1rem;
        }
        .smart-render-header-title {
            color: #475569;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .smart-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .smart-card:last-child {
            margin-bottom: 0;
        }
        .smart-card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .smart-card-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        .smart-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .smart-card-title-icon {
            font-size: 0.875rem;
        }
        .smart-card-badge {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            background: #e2e8f0;
            color: #64748b;
        }
        .smart-card-content {
            padding: 0.75rem;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }
        .smart-card-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 0.75rem;
            overflow: hidden;
        }
        /* é€šç”¨æŠ˜å ç±» */
        .collapsed {
            display: none !important;
        }
        .smart-card-content.collapsed {
            display: block !important;
        }
        .smart-card-toggle {
            color: #94a3b8;
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        
        /* é”®å€¼å¯¹ç½‘æ ¼ */
        .smart-kv-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.375rem 0.75rem;
            align-items: start;
        }
        .smart-kv-key {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0;
        }
        .smart-kv-value {
            color: #1e293b;
            font-size: 0.8rem;
            padding: 0.25rem 0;
            word-break: break-word;
        }
        .smart-kv-value-long {
            background: #f8fafc;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .smart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .smart-table th {
            background: #f1f5f9;
            color: #475569;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .smart-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            vertical-align: top;
        }
        .smart-table tr:last-child td {
            border-bottom: none;
        }
        .smart-table tr:hover td {
            background: #f8fafc;
        }
        
        /* åˆ—è¡¨æ ·å¼ */
        .smart-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .smart-list-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.375rem 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.8rem;
            color: #334155;
        }
        .smart-list-item:last-child {
            border-bottom: none;
        }
        .smart-list-number {
            min-width: 1.25rem;
            height: 1.25rem;
            background: #e2e8f0;
            color: #64748b;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        .smart-list-bullet {
            width: 0.375rem;
            height: 0.375rem;
            background: #94a3b8;
            border-radius: 9999px;
            flex-shrink: 0;
            margin-top: 0.4rem;
        }
        
        /* Badgeæ ·å¼ */
        .smart-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .smart-badge-red { background: #fee2e2; color: #dc2626; }
        .smart-badge-green { background: #dcfce7; color: #16a34a; }
        .smart-badge-yellow { background: #fef9c3; color: #ca8a04; }
        .smart-badge-blue { background: #dbeafe; color: #2563eb; }
        .smart-badge-purple { background: #f3e8ff; color: #9333ea; }
        .smart-badge-gray { background: #f1f5f9; color: #64748b; }
        
        /* é«˜äº®æ ·å¼ */
        .smart-highlight-error .smart-card-header {
            border-left: 3px solid #ef4444;
        }
        .smart-highlight-success .smart-card-header {
            border-left: 3px solid #22c55e;
        }
        .smart-highlight-rating .smart-card-header {
            border-left: 3px solid #eab308;
        }
        
        .search-progress-card {
            margin: 0.75rem 0;
            transition: all 0.3s ease;
        }
        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.25rem 0.5rem;
            background-color: rgba(219, 234, 254, 0.5); /* bg-blue-100/50 */
            border-left: 2px solid #bfdbfe; /* border-blue-200 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-header:hover {
            background-color: rgba(191, 219, 254, 0.5); /* bg-blue-200/50 */
        }
        .search-header h5 {
            color: #1d4ed8; /* text-blue-700 */
            font-weight: 800;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
            display: flex;
            align-items: center;
        }
        .search-content {
            padding: 0.75rem;
            background-color: rgba(239, 246, 255, 0.4); /* bg-blue-50/40 */
            border-left: 2px solid #bfdbfe; /* border-blue-200 */
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            font-size: 13px;
            line-height: 1.6;
            color: #475569; /* text-slate-600 */
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin: 0;
            border-bottom: none;
            overflow: hidden;
        }
        .event-reasoning {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            max-height: 300px;
            overflow-y: auto;
        }
        .event-reasoning.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            opacity: 0;
            border: none;
            overflow: hidden;
        }

        .discussion-card {
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .event-content, .event-reasoning {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .event-reasoning::-webkit-scrollbar,
        .search-content::-webkit-scrollbar {
            width: 4px;
        }
        .event-reasoning::-webkit-scrollbar-track,
        .search-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .event-reasoning::-webkit-scrollbar-thumb,
        .search-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .event-reasoning::-webkit-scrollbar-thumb:hover,
        .search-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* æœ€å¤§åŒ–æ ·å¼ */
        .maximized {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1000 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            background: white;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 140px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0;
        }

        /* åŠ¨æ€å¸ƒå±€å®½åº¦ */
        #main-layout.discussion-wide #discussion-section {
            flex: 2;
        }
        #main-layout.discussion-wide #report-section {
            flex: 1;
        }
        #main-layout.report-wide #discussion-section {
            flex: 1;
        }
        #main-layout.report-wide #report-section {
            flex: 2;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 140px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 100;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-top: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .dropdown-content button {
            width: 100%;
            text-align: left;
            padding: 0.6rem 1rem;
            color: #475569;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .dropdown-content button:hover {
            background-color: #f8fafc;
            color: #2563eb;
        }
        .dropdown-content button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: transparent;
            color: #94a3b8;
        }
        .show { display: block; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <nav class="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="px-4 flex justify-between items-center">
            <h1 class="text-3xl font-black tracking-tighter">ğŸ›ï¸ <span data-i18n="nav_title">AI å…ƒè€é™¢</span> <span class="text-lg font-normal text-slate-400 ml-3 tracking-normal" data-i18n="nav_subtitle">å®æ—¶ç›‘æ§é¢æ¿</span></h1>
            <div class="flex items-center space-x-4">
                <!-- è¯­è¨€åˆ‡æ¢ -->
                <div class="flex bg-slate-700/50 rounded-lg p-1 border border-slate-600">
                    <button onclick="setLanguage('zh')" id="lang-zh" class="px-2 py-1 text-xs rounded transition-all duration-200 font-bold">ä¸­</button>
                    <button onclick="setLanguage('en')" id="lang-en" class="px-2 py-1 text-xs rounded transition-all duration-200 font-bold">EN</button>
                </div>
                <!-- Meta-Orchestrator æ¨¡å¼åˆ‡æ¢ -->
                <div class="flex items-center space-x-2 bg-slate-700/50 px-3 py-2 rounded-lg border border-slate-600">
                    <span class="text-xs font-semibold text-slate-300" data-i18n="nav_orchestrator_mode">æ™ºèƒ½ç¼–æ’</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="orchestrator-mode-toggle" class="sr-only peer" onchange="toggleOrchestratorMode()">
                        <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-500"></div>
                    </label>
                </div>
                <div id="status-indicator" class="flex items-center space-x-3 bg-slate-700/50 px-4 py-2 rounded-full border border-slate-600">
                    <span id="status-dot" class="w-3 h-3 bg-gray-500 rounded-full"></span>
                    <span id="status-text" class="text-base" data-i18n="status_ready">å°±ç»ª</span>
                    <span id="browser-warning" class="hidden text-amber-400 cursor-help" title="æœªæ‰¾åˆ°æµè§ˆå™¨ï¼Œæœç´¢åŠŸèƒ½å¯èƒ½å—é™" data-i18n-title="msg_browser_missing">âš ï¸</span>
                </div>
                <button onclick="toggleLogs()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 transition group" title="åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º" data-i18n-title="nav_toggle_logs">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
                <button onclick="toggleRolesModal()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 transition group" title="è§’è‰²ç®¡ç†" data-i18n-title="nav_roles">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </button>
                <button id="advanced-config-btn" onclick="toggleAdvancedConfigModal()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 transition group" title="é«˜çº§é…ç½®" data-i18n-title="btn_advanced">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <button id="history-btn" onclick="toggleHistoryModal()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 transition group" title="å†å²" data-i18n-title="btn_history">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                <!-- ç®¡ç†å‘˜å…¥å£ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
                <a id="admin-btn" href="/admin" class="hidden p-2 bg-purple-600 hover:bg-purple-700 rounded-lg border border-purple-500 transition group" title="ç®¡ç†å‘˜è®¾ç½®">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                </a>
                <button onclick="logout()" class="p-2 bg-red-600 hover:bg-red-700 rounded-lg border border-red-500 transition group" title="ç™»å‡º" data-i18n-title="btn_logout">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto py-4 px-4 max-w-[98vw] h-[calc(100vh-80px)] flex flex-col">
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4 border border-slate-200 flex-shrink-0">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1" data-i18n="input_issue_label">è®®é¢˜å†…å®¹</label>
                    <textarea id="issue-input" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦è®¨è®ºçš„è®®é¢˜ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰..." rows="1"
                           data-i18n-placeholder="input_issue_placeholder"
                           class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-base resize-none min-h-[42px] max-h-48 overflow-y-auto"
                           oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                </div>
                <div class="flex items-end space-x-2">
                    <!-- éšè—çš„é…ç½®å­—æ®µï¼ˆç”¨äºåç«¯é€»è¾‘ï¼Œå®é™…å€¼ä»modalåŒæ­¥ï¼‰ -->
                    <input type="hidden" id="backend-select">
                    <input type="hidden" id="global-model-input">
                    <input type="hidden" id="global-reasoning-input">
                    <input type="hidden" id="rounds-input" value="3">
                    <input type="hidden" id="planners-input" value="2">
                    <input type="hidden" id="auditors-input" value="2">
                    <div id="global-reasoning-container" class="hidden"></div>
                    
                    <button id="start-btn" onclick="startDiscussion()" 
                            class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg transition shadow-lg shadow-blue-200 disabled:bg-gray-400 disabled:shadow-none flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span data-i18n="btn_start">å¼€å§‹è®®äº‹</span>
                    </button>
                    <button id="stop-btn" onclick="stopDiscussion()" 
                            class="hidden w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-lg transition shadow-lg shadow-red-200" data-i18n="btn_stop">
                        åœæ­¢
                    </button>
                </div>
            </div>
            <!-- datalists for autocomplete -->
            <datalist id="openrouter-models-list"></datalist>
            <datalist id="deepseek-models-list"></datalist>
        </div>

        <div id="main-layout" class="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
            <!-- å·¦ä¾§è®¨è®ºæµ (å›ºå®š50%å®½åº¦) -->
            <div id="discussion-section" class="flex flex-col min-h-0 transition-all duration-300 w-full lg:w-1/2">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col flex-1 min-h-0 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700 flex items-center text-base">
                                <span class="mr-2">ğŸ’¬</span> <span data-i18n="discussion_flow_title">è®®äº‹è¿‡ç¨‹</span>
                                <span id="round-info" class="ml-2 text-xs font-normal text-slate-400 hidden">Round 1 / 3</span>
                            </h3>
                            <div class="flex items-center space-x-2">
                                <span id="progress-percentage" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">0%</span>
                                <button onclick="toggleMaximize('discussion-section')" class="p-1 hover:bg-slate-200 rounded transition text-slate-400 hover:text-slate-600" title="æœ€å¤§åŒ–/è¿˜åŸ" data-i18n-title="btn_maximize">
                                    <svg id="discussion-maximize-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-1.5 overflow-hidden">
                            <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all duration-500 ease-out"></div>
                        </div>
                    </div>
                    <div id="discussion-container" class="p-4 overflow-y-auto flex-1 space-y-4 bg-gray-50/50">
                        <div id="discussion-flow" class="space-y-4">
                            <!-- åŠ¨æ€æ’å…¥å†…å®¹ -->
                        </div>
                    </div>
                    <!-- ç”¨æˆ·å¹²é¢„è¾“å…¥åŒº -->
                    <div id="intervention-area" class="hidden p-3 border-t border-slate-200 bg-white">
                        <div class="flex space-x-2">
                            <input type="text" id="intervention-input" 
                                   placeholder="è¾“å…¥å¹²é¢„æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼šè¯·æ›´å¤šå…³æ³¨æˆæœ¬é—®é¢˜ï¼‰..." 
                                   data-i18n-placeholder="intervention_placeholder"
                                   class="flex-1 px-3 py-2 border border-slate-300 rounded-lg outline-none text-sm focus:border-blue-500 transition"
                                   onkeyup="if(event.keyCode===13) sendIntervention()">
                            <button onclick="sendIntervention()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm" data-i18n="btn_send_intervention">
                                å‘é€å¹²é¢„
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æœ€ç»ˆæŠ¥å‘Š (å›ºå®š50%å®½åº¦) -->
            <div id="report-section" class="flex flex-col min-h-0 transition-all duration-300 w-full lg:w-1/2">
                <div class="bg-white rounded-xl shadow-lg border border-purple-200 flex flex-col flex-1 min-h-0 overflow-hidden">
                    <div class="bg-purple-600 text-white px-4 py-3 flex justify-between items-center">
                        <h3 class="font-bold flex items-center text-base">
                            <span class="mr-2">ğŸ“œ</span> <span data-i18n="final_report_title">æœ€ç»ˆè®®äº‹æŠ¥å‘Š</span>
                            <!-- ç‰ˆæœ¬é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                            <select id="report-version-select" class="hidden ml-3 text-xs bg-purple-500 border border-purple-400 rounded px-2 py-1 text-white cursor-pointer hover:bg-purple-400 transition" onchange="loadReportVersion(this.value)">
                            </select>
                        </h3>
                        <div id="report-actions" class="flex items-center space-x-2">
                            <button onclick="openReportInNewTab()" class="text-xs bg-emerald-500/90 hover:bg-emerald-600 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed" data-i18n="btn_open_editor" title="åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æŠ¥å‘Šï¼ˆæ”¯æŒç¼–è¾‘å™¨ï¼‰">ğŸ“ ç¼–è¾‘å™¨</button>
                            <button onclick="reReport()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed" data-i18n="btn_re_report">é‡æ–°ç”ŸæˆæŠ¥å‘Š</button>
                            <button onclick="copyReport()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed" data-i18n="btn_copy">å¤åˆ¶</button>
                            
                            <!-- ä¸‹è½½ä¸‹æ‹‰èœå• -->
                            <div class="relative inline-block text-left">
                                <button onclick="toggleDownloadDropdown()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition flex items-center space-x-1 disabled:opacity-50 disabled:cursor-not-allowed" id="download-dropdown-btn">
                                    <span data-i18n="btn_download">ä¸‹è½½</span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="download-dropdown" class="dropdown-content">
                                    <button onclick="downloadReport(); toggleDownloadDropdown()" class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        <span data-i18n="btn_download_html">HTML æ ¼å¼</span>
                                    </button>
                                    <button onclick="downloadPDF(event); toggleDownloadDropdown()" class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        <span data-i18n="btn_download_pdf">PDF æ ¼å¼</span>
                                    </button>
                                    <button onclick="downloadImage(event); toggleDownloadDropdown()" class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span data-i18n="btn_download_image">å›¾ç‰‡æ ¼å¼</span>
                                    </button>
                                    <button onclick="downloadMarkdown(event); toggleDownloadDropdown()" class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                        <span data-i18n="btn_download_md">Markdown æ ¼å¼</span>
                                    </button>
                                </div>
                            </div>

                            <button onclick="toggleMaximize('report-section')" class="p-1 hover:bg-white/20 rounded transition text-white/70 hover:text-white" title="æœ€å¤§åŒ–/è¿˜åŸ" data-i18n-title="btn_maximize">
                                <svg id="report-maximize-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="report-container" class="relative flex-1 min-h-0 overflow-hidden">
                        <iframe id="report-iframe" class="w-full h-full border-none" srcdoc="<div style='color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;'></div>"></iframe>
                        <!-- æŠ¥å‘Šç”Ÿæˆé®ç½©å±‚ -->
                        <div id="report-loader" class="hidden absolute inset-0 bg-white/70 backdrop-blur-[1px] flex flex-col items-center justify-center z-10">
                            <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
                            <p id="loader-text" class="text-purple-700 font-bold animate-pulse text-base" data-i18n="loader_text">æ­£åœ¨è¿›è¡Œè®®äº‹è®¨è®º...</p>
                            <p id="loader-subtext" class="text-slate-400 text-sm mt-2" data-i18n="loader_subtext">å…ƒè€ä»¬æ­£åœ¨æ¿€çƒˆè¾©è®ºä¸­</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ—¥å¿—çª—å£ -->
            <div id="log-section" class="hidden flex flex-col min-h-0 transition-all duration-300 flex-1">
                <div class="bg-slate-900 rounded-xl shadow-lg overflow-hidden flex flex-col flex-1 min-h-0">
                    <div class="bg-slate-800 px-4 py-3 flex justify-between items-center border-b border-slate-700">
                        <h3 class="text-slate-300 text-sm font-bold flex items-center">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                            <span data-i18n="log_title">ç³»ç»Ÿæ‰§è¡Œæ—¥å¿—</span>
                        </h3>
                        <button onclick="clearLogs()" class="text-xs text-slate-500 hover:text-slate-300" data-i18n="btn_clear">æ¸…é™¤</button>
                    </div>
                    <div id="log-container" class="p-3 font-mono text-[13px] text-slate-400 overflow-y-auto flex-1 space-y-1">
                        <!-- æ—¥å¿—å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
        <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[120] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full mx-4 flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800" data-i18n="history_modal_title">è®®äº‹å†å²è®°å½•</h3>
                    <button onclick="toggleHistoryModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="history-list" class="overflow-y-auto flex-1 space-y-2 pr-2">
                    <!-- å†å²é¡¹åŠ¨æ€æ’å…¥ -->
                    <div class="text-center py-8 text-slate-400 italic" data-i18n="history_loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>
                </div>
                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                    <button onclick="toggleHistoryModal()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition" data-i18n="btn_close">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- é€šç”¨ç¡®è®¤æ¨¡æ€æ¡† -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                <div class="text-center">
                    <div id="confirm-icon" class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-2" data-i18n="confirm_title">ç¡®è®¤</h3>
                    <p id="confirm-message" class="text-slate-600 mb-8 text-base"></p>
                    <div class="flex space-x-4">
                        <button id="confirm-cancel-btn" class="flex-1 px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition" data-i18n="btn_cancel">
                            å–æ¶ˆ
                        </button>
                        <button id="confirm-ok-btn" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200" data-i18n="btn_confirm">
                            ç¡®è®¤
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æç¤ºæ¨¡æ€æ¡† -->
        <div id="alert-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                <div class="text-center">
                    <div id="alert-icon" class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 id="alert-title" class="text-xl font-bold text-slate-800 mb-2" data-i18n="alert_title">æç¤º</h3>
                    <p id="alert-message" class="text-slate-600 mb-8 text-base"></p>
                    <div class="flex">
                        <button onclick="closeAlertModal()" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200" data-i18n="btn_ok">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯†ç è¾“å…¥æ¨¡æ€æ¡† -->
        <div id="password-input-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                <div class="text-center">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h3 id="password-input-title" class="text-xl font-bold text-slate-800 mb-2">å®‰å…¨éªŒè¯</h3>
                    <p id="password-input-message" class="text-slate-600 mb-4 text-sm">ä¸ºäº†å®‰å…¨ï¼Œè¯·è¾“å…¥æ‚¨çš„å½“å‰å¯†ç ï¼š</p>
                    <div class="mb-6">
                        <input type="password" id="password-input-field" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="flex space-x-4">
                        <button id="password-input-cancel-btn" class="flex-1 px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                            å–æ¶ˆ
                        </button>
                        <button id="password-input-ok-btn" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition shadow-lg shadow-red-200">
                            ç¡®è®¤
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿè®¾ç½®æ¨¡æ€æ¡† -->
        <!-- é«˜çº§é…ç½®æ¨¡æ€æ¡† -->
        <div id="advanced-config-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 flex flex-col max-h-[85vh]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="mr-2 text-2xl">âš™ï¸</span> <span data-i18n="advanced_config_title">é«˜çº§é…ç½®</span>
                    </h3>
                    <button onclick="toggleAdvancedConfigModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Tab å¯¼èˆª -->
                <div class="flex border-b border-slate-200 mb-6">
                    <button onclick="switchAdvancedTab('basic')" id="tab-basic-btn" 
                            class="px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600 transition" 
                            data-i18n="tab_basic_config">åŸºç¡€é…ç½®</button>
                    <button onclick="switchAdvancedTab('agents')" id="tab-agents-btn" 
                            class="px-6 py-3 font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition" 
                            data-i18n="tab_agent_config">å¸­ä½ä¸“å®¶é…ç½®</button>
                    <button onclick="switchAdvancedTab('presets')" id="tab-presets-btn" 
                            class="px-6 py-3 font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition" 
                            data-i18n="tab_presets">å…ƒè€é™¢ç¼–åˆ¶</button>
                    <button onclick="switchAdvancedTab('settings')" id="tab-settings-btn" 
                            class="px-6 py-3 font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition" 
                            data-i18n="tab_settings">ç³»ç»Ÿè®¾ç½®</button>
                    <button onclick="switchAdvancedTab('user')" id="tab-user-btn" 
                            class="px-6 py-3 font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition" 
                            data-i18n="tab_user">ç”¨æˆ·è®¾ç½®</button>
                </div>

                <!-- Tab å†…å®¹å®¹å™¨ -->
                <div class="overflow-y-auto flex-1 pr-2">
                    <!-- åŸºç¡€é…ç½® Tab -->
                    <div id="tab-basic-content" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-2" data-i18n="input_backend_label">åç«¯</label>
                                <select id="modal-backend-select" 
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base bg-white">
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="azure">Azure OpenAI</option>
                                    <option value="anthropic">Anthropic (Claude)</option>
                                    <option value="gemini">Google Gemini</option>
                                    <option value="openrouter">OpenRouter</option>
                                    <option value="aliyun">Aliyun</option>
                                    <option value="ollama">Ollama</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-2" data-i18n="input_model_label">å…¨å±€æ¨¡å‹ (å¯é€‰)</label>
                                <input type="text" id="modal-global-model-input" placeholder="é»˜è®¤æ¨¡å‹" data-i18n-placeholder="input_model_placeholder"
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                            </div>
                            <div id="modal-global-reasoning-container" class="hidden">
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-2" data-i18n="input_reasoning_label">æ¨ç†å¼ºåº¦</label>
                                <select id="modal-global-reasoning-input" 
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base bg-white">
                                    <option value="" data-i18n="reasoning_off">å…³é—­</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-2" data-i18n="input_rounds_label">è®¨è®ºè½®æ•°</label>
                                <input type="number" id="modal-rounds-input" value="3" min="1" max="10" 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-2" data-i18n="input_planners_label">ç­–è®ºå®¶æ•°é‡</label>
                                <input type="number" id="modal-planners-input" value="2" min="1" max="5" 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-500 uppercase mb-2" data-i18n="input_auditors_label">ç›‘å¯Ÿå®˜æ•°é‡</label>
                                <input type="number" id="modal-auditors-input" value="2" min="1" max="5" 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                            </div>
                        </div>
                    </div>

                    <!-- å¸­ä½ä¸“å®¶é…ç½® Tab -->
                    <div id="tab-agents-content" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm text-slate-600" data-i18n="agent_config_desc">ä¸ºä¸åŒå¸­ä½çš„ä¸“å®¶æŒ‡å®šç‰¹å®šçš„æ¨¡å‹åç«¯å’Œå‚æ•°</p>
                            <button onclick="resetAgentConfigs()" class="text-xs text-blue-600 hover:text-blue-800 font-medium" data-i18n="advanced_reset">é‡ç½®ä¸ºé»˜è®¤</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="modal-agent-configs-container">
                            <!-- å›ºå®šçš„ Leader å’Œ Reporter -->
                            <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span><span data-i18n="role_leader">è®®é•¿ (Leader)</span>
                                </h4>
                                <div class="flex gap-2">
                                    <select class="agent-backend flex-1 text-xs p-1 border rounded" data-agent="leader">
                                        <option value="default" data-i18n="backend_default">é»˜è®¤åç«¯</option>
                                        <option value="deepseek">DeepSeek</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="openrouter">OpenRouter</option>
                                        <option value="aliyun">Aliyun</option>
                                        <option value="ollama">Ollama</option>
                                    </select>
                                    <input type="text" class="agent-model flex-1 text-xs p-1 border rounded" placeholder="æ¨¡å‹åç§° (å¯é€‰)" data-i18n-placeholder="agent_model_placeholder" data-agent="leader">
                                </div>
                                <select class="agent-reasoning hidden text-[10px] p-1 border rounded mt-1 w-full" data-agent="leader">
                                    <option value="" data-i18n="reasoning_off">æ¨ç†: å…³é—­</option>
                                    <option value="low">æ¨ç†: Low</option>
                                    <option value="medium">æ¨ç†: Medium</option>
                                    <option value="high">æ¨ç†: High</option>
                                </select>
                            </div>
                            <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center">
                                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span><span data-i18n="role_reporter">è®°å½•å‘˜ (Reporter)</span>
                                </h4>
                                <div class="flex gap-2">
                                    <select class="agent-backend flex-1 text-xs p-1 border rounded" data-agent="reporter">
                                        <option value="default" data-i18n="backend_default">é»˜è®¤åç«¯</option>
                                        <option value="deepseek">DeepSeek</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="openrouter">OpenRouter</option>
                                        <option value="aliyun">Aliyun</option>
                                        <option value="ollama">Ollama</option>
                                    </select>
                                    <input type="text" class="agent-model flex-1 text-xs p-1 border rounded" placeholder="æ¨¡å‹åç§° (å¯é€‰)" data-i18n-placeholder="agent_model_placeholder" data-agent="reporter">
                                </div>
                                <select class="agent-reasoning hidden text-[10px] p-1 border rounded mt-1 w-full" data-agent="reporter">
                                    <option value="" data-i18n="reasoning_off">æ¨ç†: å…³é—­</option>
                                    <option value="low">æ¨ç†: Low</option>
                                    <option value="medium">æ¨ç†: Medium</option>
                                    <option value="high">æ¨ç†: High</option>
                                </select>
                            </div>
                            <!-- åŠ¨æ€ç”Ÿæˆçš„ Planners å’Œ Auditors å°†æ’å…¥åˆ°è¿™é‡Œ -->
                        </div>
                    </div>

                    <!-- å…ƒè€é™¢ç¼–åˆ¶ Tab -->
                    <div id="tab-presets-content" class="hidden space-y-6">
                        <!-- ä¿å­˜å½“å‰é…ç½® -->
                        <section class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> <span data-i18n="presets_save_new">ä¿å­˜å½“å‰é…ç½®ä¸ºæ–°ç¼–åˆ¶</span>
                            </h3>
                            <div class="flex gap-2">
                                <input type="text" id="modal-new-preset-name" placeholder="è¾“å…¥ç¼–åˆ¶åç§° (ä¾‹å¦‚: 3äºº-DeepSeek-é«˜å¼ºåº¦)" 
                                       data-i18n-placeholder="presets_name_placeholder"
                                       class="flex-1 px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition">
                                <button onclick="saveModalPreset()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg transition shadow-sm" data-i18n="btn_save">
                                    ä¿å­˜
                                </button>
                            </div>
                        </section>

                        <!-- ç¼–åˆ¶åˆ—è¡¨ -->
                        <section>
                            <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> <span data-i18n="presets_list">å·²ä¿å­˜çš„ç¼–åˆ¶</span>
                            </h3>
                            <div id="modal-presets-list" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                                <!-- åŠ¨æ€æ’å…¥ -->
                                <div class="text-center text-gray-400 py-4">åŠ è½½ä¸­...</div>
                            </div>
                        </section>
                    </div>

                    <!-- ç³»ç»Ÿè®¾ç½® Tab -->
                    <div id="tab-settings-content" class="hidden space-y-6">
                        <!-- æ¨¡å‹APIå¯†é’¥é…ç½®åŒºåŸŸ -->
                        <section class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                            <h4 class="text-sm font-bold text-blue-800 mb-4 flex items-center">
                                <span class="w-1.5 h-4 bg-blue-500 rounded-full mr-2"></span> 
                                <span class="mr-1">ğŸ¤–</span>
                                <span data-i18n="settings_api_keys">æ¨¡å‹ API å¯†é’¥é…ç½®</span>
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">DeepSeek API Key</label>
                                    <input type="password" id="settings-key-deepseek" placeholder="sk-..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">OpenAI API Key</label>
                                    <input type="password" id="settings-key-openai" placeholder="sk-..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Azure OpenAI API Key</label>
                                    <input type="password" id="settings-key-azure" placeholder="your-azure-key..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Azure OpenAI Endpoint</label>
                                    <input type="text" id="settings-azure-endpoint" placeholder="https://your-resource.openai.azure.cn" 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                    <p class="text-xs text-slate-500 mt-1">ä¸­å›½åŒº: .openai.azure.cn | å…¨çƒåŒº: .openai.azure.com</p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Azure Deployment Name</label>
                                    <input type="text" id="settings-azure-deployment" placeholder="gpt-4o" 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                    <p class="text-xs text-slate-500 mt-1">æ‚¨åœ¨Azureåˆ›å»ºçš„éƒ¨ç½²åç§°ï¼ˆä¸æ˜¯æ¨¡å‹åï¼‰</p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Anthropic API Key</label>
                                    <input type="password" id="settings-key-anthropic" placeholder="sk-ant-..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                    <p class="text-xs text-slate-500 mt-1">Claude APIå¯†é’¥ï¼ˆè·å–åœ°å€: console.anthropic.comï¼‰</p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Google Gemini API Key</label>
                                    <input type="password" id="settings-key-gemini" placeholder="AIza..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                    <p class="text-xs text-slate-500 mt-1">Gemini APIå¯†é’¥ï¼ˆè·å–åœ°å€: aistudio.google.comï¼‰</p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">OpenRouter API Key</label>
                                    <input type="password" id="settings-key-openrouter" placeholder="sk-or-..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Aliyun API Key</label>
                                    <input type="password" id="settings-key-aliyun" placeholder="sk-..." 
                                           class="w-full px-3 py-2 border border-blue-200 rounded-lg outline-none focus:border-blue-500 transition bg-white">
                                </div>
                            </div>
                        </section>

                        <!-- æœç´¢å¼•æ“é…ç½®åŒºåŸŸ -->
                        <section class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100">
                            <h4 class="text-sm font-bold text-green-800 mb-4 flex items-center">
                                <span class="w-1.5 h-4 bg-green-500 rounded-full mr-2"></span>
                                <span class="mr-1">ğŸ”</span>
                                <span data-i18n="settings_search_engines">æœç´¢å¼•æ“é…ç½®</span>
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-600 uppercase" data-i18n="settings_search_engines">æœç´¢å¢å¼ºå¼•æ“ (å¯å¤šé€‰)</label>
                                    <div id="settings-search-providers" class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="bing" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">Bing (<span data-i18n="search_stable">ä¸ç¨³å®š</span>)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="baidu" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">Baidu (<span data-i18n="search_chinese">ä¸­æ–‡</span>)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="duckduckgo" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">DuckDuckGo</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="yahoo" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">Yahoo (<span data-i18n="search_stable_good">ç¨³å®š</span>)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="mojeek" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">Mojeek (<span data-i18n="search_english">è‹±æ–‡</span>)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="google" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">Google (<span class="text-green-600 font-bold">API</span>)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 p-2 border border-green-200 rounded-lg hover:bg-white cursor-pointer transition bg-white/50">
                                            <input type="checkbox" value="tavily" class="search-provider-checkbox w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm text-slate-700">Tavily (Key)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">Tavily API Key</label>
                                    <input type="password" id="settings-key-tavily" placeholder="tvly-..." 
                                           class="w-full px-3 py-2 border border-green-200 rounded-lg outline-none focus:border-green-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase flex items-center">
                                        <span class="mr-2">Google API Key</span>
                                        <a href="https://developers.google.com/custom-search/v1/overview" target="_blank" class="text-green-500 hover:text-green-700 text-xs">
                                            (è·å– â†—ï¸)
                                        </a>
                                    </label>
                                    <input type="password" id="settings-key-google" placeholder="AIzaSy..." 
                                           class="w-full px-3 py-2 border border-green-200 rounded-lg outline-none focus:border-green-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase flex items-center">
                                        <span class="mr-2">Google Search Engine ID</span>
                                        <a href="https://programmablesearchengine.google.com/" target="_blank" class="text-green-500 hover:text-green-700 text-xs">
                                            (è·å– â†—ï¸)
                                        </a>
                                    </label>
                                    <input type="text" id="settings-google-cx" placeholder="003ac4d2..." 
                                           class="w-full px-3 py-2 border border-green-200 rounded-lg outline-none focus:border-green-500 transition bg-white">
                                    <p class="text-xs text-slate-500 mt-1">
                                        ğŸ’¡ å…è´¹é…é¢ï¼š100æ¬¡/å¤© | ä»˜è´¹ï¼š$5/1000æ¬¡ | å›½å†…å¯è®¿é—®
                                    </p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase" data-i18n="settings_browser_path">æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ (Baidu/Bing æœç´¢)</label>
                                    <input type="text" id="settings-browser-path" placeholder="ä¾‹å¦‚: C:\Program Files\Google\Chrome\Application\chrome.exe" 
                                           data-i18n-placeholder="settings_browser_path_placeholder"
                                           class="w-full px-3 py-2 border border-green-200 rounded-lg outline-none focus:border-green-500 transition bg-white">
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- ç”¨æˆ·è®¾ç½® Tab -->
                    <div id="tab-user-content" class="hidden space-y-6">
                        <!-- ç”¨æˆ·ä¿¡æ¯å±•ç¤º -->
                        <section class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-xl border border-purple-100">
                            <h4 class="text-sm font-bold text-purple-800 mb-4 flex items-center">
                                <span class="w-1.5 h-4 bg-purple-500 rounded-full mr-2"></span> 
                                <span class="mr-1">ğŸ‘¤</span>
                                <span data-i18n="user_info">ç”¨æˆ·ä¿¡æ¯</span>
                            </h4>
                            <div class="grid grid-cols-1 gap-3">
                                <div class="bg-white p-3 rounded-lg border border-purple-100">
                                    <label class="text-xs font-bold text-slate-500 uppercase">ç”¨æˆ·å</label>
                                    <p id="user-display-username" class="text-base text-slate-800 mt-1">åŠ è½½ä¸­...</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-purple-100">
                                    <label class="text-xs font-bold text-slate-500 uppercase">é‚®ç®±</label>
                                    <p id="user-display-email" class="text-base text-slate-800 mt-1">åŠ è½½ä¸­...</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-purple-100">
                                    <label class="text-xs font-bold text-slate-500 uppercase">åŒå› ç´ è®¤è¯</label>
                                    <p id="user-display-mfa" class="text-base text-slate-800 mt-1">
                                        <span class="inline-flex items-center">åŠ è½½ä¸­...</span>
                                    </p>
                                </div>
                            </div>
                        </section>

                        <!-- ä¿®æ”¹å¯†ç  -->
                        <section class="bg-gradient-to-br from-orange-50 to-red-50 p-4 rounded-xl border border-orange-100">
                            <h4 class="text-sm font-bold text-orange-800 mb-4 flex items-center">
                                <span class="w-1.5 h-4 bg-orange-500 rounded-full mr-2"></span> 
                                <span class="mr-1">ğŸ”’</span>
                                <span data-i18n="change_password">ä¿®æ”¹å¯†ç </span>
                            </h4>
                            <div class="space-y-3">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">å½“å‰å¯†ç </label>
                                    <input type="password" id="user-current-password" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " 
                                           class="w-full px-3 py-2 border border-orange-200 rounded-lg outline-none focus:border-orange-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">æ–°å¯†ç </label>
                                    <input type="password" id="user-new-password" placeholder="è‡³å°‘8ä½ï¼Œå«å¤§å°å†™å­—æ¯å’Œæ•°å­—" 
                                           class="w-full px-3 py-2 border border-orange-200 rounded-lg outline-none focus:border-orange-500 transition bg-white">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-600 uppercase">ç¡®è®¤æ–°å¯†ç </label>
                                    <input type="password" id="user-confirm-password" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " 
                                           class="w-full px-3 py-2 border border-orange-200 rounded-lg outline-none focus:border-orange-500 transition bg-white">
                                </div>
                                <div class="text-xs text-slate-500 bg-white p-2 rounded border border-orange-100">
                                    âš ï¸ å¯†ç è¦æ±‚ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
                                </div>
                                <button onclick="changePassword()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg font-bold transition shadow-lg">
                                    ä¿®æ”¹å¯†ç 
                                </button>
                            </div>
                        </section>

                        <!-- MFA ç®¡ç† -->
                        <section class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-100">
                            <h4 class="text-sm font-bold text-blue-800 mb-4 flex items-center">
                                <span class="w-1.5 h-4 bg-blue-500 rounded-full mr-2"></span> 
                                <span class="mr-1">ğŸ”</span>
                                <span data-i18n="mfa_management">åŒå› ç´ è®¤è¯ç®¡ç†</span>
                            </h4>
                            <div id="mfa-status-container" class="space-y-3">
                                <!-- MFAçŠ¶æ€å°†åŠ¨æ€åŠ è½½ -->
                                <div class="text-center py-4 text-slate-500">åŠ è½½ä¸­...</div>
                            </div>
                        </section>

                        <!-- è´¦æˆ·æ“ä½œ -->
                        <section class="bg-gradient-to-br from-red-50 to-rose-50 p-4 rounded-xl border border-red-100">
                            <h4 class="text-sm font-bold text-red-800 mb-4 flex items-center">
                                <span class="w-1.5 h-4 bg-red-500 rounded-full mr-2"></span> 
                                <span class="mr-1">âš¡</span>
                                <span data-i18n="account_actions">è´¦æˆ·æ“ä½œ</span>
                            </h4>
                            <div class="space-y-3">
                                <button onclick="handleLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-bold transition shadow-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    é€€å‡ºç™»å½•
                                </button>
                                <div class="text-xs text-slate-500 bg-white p-2 rounded border border-red-100">
                                    ğŸ’¡ æç¤ºï¼šä¿®æ”¹å¯†ç åï¼Œæ‰€æœ‰å…¶ä»–è®¾å¤‡å°†è‡ªåŠ¨ç™»å‡º
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end space-x-3">
                    <button onclick="toggleAdvancedConfigModal()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition" data-i18n="btn_cancel">
                        å–æ¶ˆ
                    </button>
                    <button onclick="applyAdvancedConfig()" class="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200" data-i18n="btn_apply">
                        åº”ç”¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¼–åˆ¶ç®¡ç†æ¨¡æ€æ¡† (å·²åºŸå¼ƒï¼ŒåŠŸèƒ½ç§»è‡³é«˜çº§é…ç½®modal) -->

        <!-- è§’è‰²ç®¡ç†æ¨¡æ€æ¡† -->
        <div id="roles-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center">
            <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-8 m-4 max-h-[90vh] flex flex-col transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800 flex items-center">
                        <span class="mr-3 text-3xl">ğŸ‘¥</span> <span data-i18n="roles_title">è§’è‰²ç®¡ç†</span>
                    </h2>
                    <div class="flex items-center space-x-3">
                        <button onclick="openRoleDesigner()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold rounded-lg transition shadow-lg flex items-center space-x-2">
                            <span>âœ¨</span>
                            <span>åˆ›å»ºæ–°è§’è‰²</span>
                        </button>
                        <button onclick="toggleRolesModal()" class="text-slate-400 hover:text-slate-600 transition">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- è§’è‰²åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto pr-2">
                    <div id="roles-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- åŠ¨æ€æ’å…¥è§’è‰²å¡ç‰‡ -->
                        <div class="text-center text-gray-400 py-8">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                    <button onclick="toggleRolesModal()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition" data-i18n="btn_close">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- è§’è‰²è®¾è®¡å¸ˆæ¨¡æ€æ¡† (3æ­¥å‘å¯¼) -->
        <div id="role-designer-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[160] flex items-center justify-center">
            <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-8 m-4 max-h-[90vh] flex flex-col">
                <!-- æ ‡é¢˜ -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800 flex items-center">
                        <span class="mr-3 text-3xl">âœ¨</span> 
                        <span>AIè§’è‰²è®¾è®¡å¸ˆ</span>
                    </h2>
                    <button onclick="closeRoleDesigner()" class="text-slate-400 hover:text-slate-600 transition">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="flex items-center justify-center mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div id="step-indicator-1" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">1</div>
                            <span id="step-label-1" class="ml-2 font-bold text-blue-600">éœ€æ±‚æè¿°</span>
                        </div>
                        <div class="w-16 h-1 bg-slate-200">
                            <div id="step-progress-1" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step-indicator-2" class="w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-bold">2</div>
                            <span id="step-label-2" class="ml-2 text-slate-400">AIç”Ÿæˆ</span>
                        </div>
                        <div class="w-16 h-1 bg-slate-200">
                            <div id="step-progress-2" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step-indicator-3" class="w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-bold">3</div>
                            <span id="step-label-3" class="ml-2 text-slate-400">é¢„è§ˆä¿å­˜</span>
                        </div>
                    </div>
                </div>

                <!-- æ­¥éª¤å†…å®¹ -->
                <div class="flex-1 overflow-y-auto pr-2">
                    <!-- Step 1: éœ€æ±‚è¾“å…¥ -->
                    <div id="designer-step-1" class="space-y-4">
                        <p class="text-slate-600 mb-4">
                            æè¿°æ‚¨éœ€è¦çš„è§’è‰²åŠŸèƒ½å’Œç‰¹ç‚¹ï¼ŒAIå°†è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„è§’è‰²é…ç½®ã€‚
                        </p>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">è§’è‰²éœ€æ±‚ *</label>
                            <textarea id="role-requirement-input" 
                                      rows="8"
                                      class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition text-base"
                                      placeholder="ä¾‹å¦‚ï¼šæˆ‘éœ€è¦ä¸€ä¸ªæ“…é•¿æ•°æ®åˆ†æçš„è§’è‰²ï¼Œèƒ½å¤Ÿå¤„ç†ç»Ÿè®¡åˆ†æã€æ•°æ®å¯è§†åŒ–å’Œè¶‹åŠ¿é¢„æµ‹ä»»åŠ¡ã€‚è¿™ä¸ªè§’è‰²åº”è¯¥å…·å¤‡æ‰¹åˆ¤æ€§æ€ç»´ï¼Œè¾“å‡ºç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Š..."></textarea>
                            <p class="text-xs text-slate-500 mt-2">ğŸ’¡ æç¤ºï¼šè¯¦ç»†æè¿°è§’è‰²çš„ä¸“ä¸šé¢†åŸŸã€å·¥ä½œæ–¹å¼å’Œè¾“å‡ºè¦æ±‚</p>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 mb-2">ğŸ“‹ ç¤ºä¾‹éœ€æ±‚</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>â€¢ å¸‚åœºè°ƒç ”å‘˜ï¼šæ”¶é›†è¡Œä¸šæ•°æ®ã€åˆ†æç«å“ç­–ç•¥ã€ç”ŸæˆSWOTæŠ¥å‘Š</li>
                                <li>â€¢ åˆ›æ„æ¿€å‘å®˜ï¼šå¤´è„‘é£æš´ã€è·¨é¢†åŸŸè”æƒ³ã€æ‰“ç ´å¸¸è§„æ€ç»´</li>
                                <li>â€¢ é£é™©è¯„ä¼°å¸ˆï¼šè¯†åˆ«æ½œåœ¨é£é™©ã€è¯„ä¼°å½±å“ç¨‹åº¦ã€æå‡ºç¼“è§£æªæ–½</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Step 2: ç”Ÿæˆä¸­ -->
                    <div id="designer-step-2" class="hidden space-y-4">
                        <div class="flex items-center justify-center space-x-3 mb-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <span class="text-lg text-slate-600">AIæ­£åœ¨ç”Ÿæˆè§’è‰²è®¾è®¡...</span>
                        </div>
                        
                        <!-- Reasoningæ˜¾ç¤ºåŒº -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 text-amber-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                                </svg>
                                <h4 class="font-bold text-amber-800">AIæ€è€ƒè¿‡ç¨‹</h4>
                            </div>
                            <div id="reasoning-display" class="text-sm text-amber-900 whitespace-pre-wrap max-h-48 overflow-y-auto font-mono bg-white rounded p-3 border border-amber-100"></div>
                        </div>
                        
                        <!-- Contentæ˜¾ç¤ºåŒº -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                                </svg>
                                <h4 class="font-bold text-blue-800">ç”Ÿæˆå†…å®¹</h4>
                            </div>
                            <div id="content-display" class="text-sm text-blue-900 whitespace-pre-wrap max-h-48 overflow-y-auto font-mono bg-white rounded p-3 border border-blue-100"></div>
                        </div>
                    </div>

                    <!-- Step 3: é¢„è§ˆå’Œç¼–è¾‘ -->
                    <div id="designer-step-3" class="hidden space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <p class="text-green-800 font-bold">âœ… è§’è‰²è®¾è®¡å®Œæˆï¼æ‚¨å¯ä»¥é¢„è§ˆå¹¶è°ƒæ•´åä¿å­˜ã€‚</p>
                        </div>

                        <!-- è§’è‰²åŸºæœ¬ä¿¡æ¯ -->
                        <section class="bg-slate-50 rounded-lg p-4">
                            <h4 class="font-bold text-slate-700 mb-3">åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">æŠ€æœ¯åç§°</label>
                                    <input type="text" id="preview-role-name" readonly
                                           class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">æ˜¾ç¤ºåç§°</label>
                                    <input type="text" id="preview-display-name" 
                                           class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-bold text-slate-500 mb-1">è§’è‰²æè¿°</label>
                                <textarea id="preview-description" rows="3"
                                          class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm"></textarea>
                            </div>
                        </section>

                        <!-- é˜¶æ®µå®šä¹‰ -->
                        <section class="bg-slate-50 rounded-lg p-4">
                            <h4 class="font-bold text-slate-700 mb-3">å·¥ä½œé˜¶æ®µ</h4>
                            <div id="preview-stages-container" class="space-y-3">
                                <!-- åŠ¨æ€æ’å…¥é˜¶æ®µå¡ç‰‡ -->
                            </div>
                        </section>

                        <!-- æ¨èäººç‰© -->
                        <section class="bg-slate-50 rounded-lg p-4">
                            <h4 class="font-bold text-slate-700 mb-3">æ¨èäººç‰©åŸå‹</h4>
                            <div id="preview-personas-container" class="space-y-2">
                                <!-- åŠ¨æ€æ’å…¥äººç‰©å¡ç‰‡ -->
                            </div>
                        </section>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰é’® -->
                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-between">
                    <button id="designer-back-btn" onclick="designerGoBack()" class="hidden px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                        â† è¿”å›
                    </button>
                    <div></div> <!-- å ä½ -->
                    <div class="space-x-3">
                        <button onclick="closeRoleDesigner()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                            å–æ¶ˆ
                        </button>
                        <button id="designer-next-btn" onclick="designerNextStep()" class="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200">
                            å¼€å§‹ç”Ÿæˆ â†’
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="role-detail-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[160] flex items-center justify-center">
            <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-8 m-4 max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 id="detail-role-name" class="text-2xl font-bold text-slate-800"></h3>
                        <p id="detail-role-desc" class="text-sm text-slate-600 mt-1"></p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="closeRoleDetail()" class="text-slate-400 hover:text-slate-600 transition">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div id="detail-role-content" class="flex-1 overflow-y-auto pr-2 space-y-4">
                    <!-- åŠ¨æ€æ’å…¥è§’è‰²è¯¦æƒ… -->
                </div>
                
                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                    <button onclick="closeRoleDetail()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- è§’è‰²ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="role-edit-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[160] flex items-center justify-center">
            <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl p-8 m-4 max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800 flex items-center">
                        <span class="mr-3 text-3xl">âœï¸</span> <span>ç¼–è¾‘è§’è‰²: <span id="edit-role-name" class="text-blue-600"></span></span>
                    </h2>
                    <button onclick="closeRoleEditor()" class="text-slate-400 hover:text-slate-600 transition">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto pr-2 space-y-6">
                    <!-- YAMLé…ç½®ç¼–è¾‘ -->
                    <section>
                        <label class="block text-sm font-bold text-slate-700 mb-2">è§’è‰²é…ç½® (YAML)</label>
                        <textarea id="role-yaml-editor" 
                                  class="w-full h-64 px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm outline-none focus:border-blue-500 transition"
                                  placeholder="åŠ è½½ä¸­..."></textarea>
                        <p class="text-xs text-slate-500 mt-1">âš ï¸ è¯·ç¡®ä¿YAMLæ ¼å¼æ­£ç¡®ï¼Œä¿®æ”¹nameã€stagesç­‰å­—æ®µè¯·è°¨æ…</p>
                    </section>

                    <!-- Promptç¼–è¾‘åŒº -->
                    <section>
                        <label class="block text-sm font-bold text-slate-700 mb-2">æç¤ºè¯å†…å®¹</label>
                        <div id="prompt-editors" class="space-y-4">
                            <!-- åŠ¨æ€æ’å…¥å„é˜¶æ®µçš„promptç¼–è¾‘å™¨ -->
                        </div>
                    </section>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-between">
                    <button onclick="validateRoleConfig()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                        éªŒè¯é…ç½®
                    </button>
                    <div class="space-x-3">
                        <button onclick="closeRoleEditor()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                            å–æ¶ˆ
                        </button>
                        <button onclick="saveRoleConfig()" class="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const translations = {
                zh: {
                    nav_title: "AI Council",
                    nav_subtitle: "å…ƒè€é™¢è®®äº‹å…",
                    nav_toggle_logs: "åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º",
                    nav_orchestrator_mode: "æ™ºèƒ½ç¼–æ’",
                    nav_settings: "ç³»ç»Ÿè®¾ç½®",
                    nav_roles: "è§’è‰²ç®¡ç†",
                    nav_presets: "å…ƒè€é™¢ç¼–åˆ¶",
                    input_issue_label: "è®®é¢˜å†…å®¹",
                    input_issue_placeholder: "è¯·è¾“å…¥æ‚¨æƒ³è¦è®¨è®ºçš„è®®é¢˜ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰...",
                    input_backend_label: "åç«¯",
                    input_model_label: "å…¨å±€æ¨¡å‹ (å¯é€‰)",
                    input_model_placeholder: "é»˜è®¤æ¨¡å‹",
                    input_reasoning_label: "æ¨ç†å¼ºåº¦",
                    reasoning_off: "å…³é—­",
                    reasoning_low: "æ¨ç†: Low",
                    reasoning_medium: "æ¨ç†: Medium",
                    reasoning_high: "æ¨ç†: High",
                    input_rounds_label: "è½®æ•°",
                    input_planners_label: "ç­–è®ºå®¶",
                    input_auditors_label: "ç›‘å¯Ÿå®˜",
                    btn_start: "å¼€å§‹è®®äº‹",
                    btn_advanced: "é«˜çº§é…ç½®",
                    advanced_config_title: "é«˜çº§é…ç½®",
                    tab_basic_config: "åŸºç¡€é…ç½®",
                    tab_agent_config: "å¸­ä½ä¸“å®¶é…ç½®",
                    tab_presets: "å…ƒè€é™¢ç¼–åˆ¶",
                    tab_settings: "ç³»ç»Ÿè®¾ç½®",
                    agent_config_desc: "ä¸ºä¸åŒå¸­ä½çš„ä¸“å®¶æŒ‡å®šç‰¹å®šçš„æ¨¡å‹åç«¯å’Œå‚æ•°",
                    presets_name_placeholder: "è¾“å…¥ç¼–åˆ¶åç§° (ä¾‹å¦‚: 3äºº-DeepSeek-é«˜å¼ºåº¦)",
                    btn_load: "åŠ è½½",
                    btn_delete: "åˆ é™¤",
                    btn_apply: "åº”ç”¨",
                    btn_load_preset: "åŠ è½½ç¼–åˆ¶",
                    btn_save_current: "ä¿å­˜å½“å‰é…ç½®",
                    btn_history: "å†å²",
                    btn_stop: "åœæ­¢",
                    advanced_title: "å¸­ä½ä¸“å®¶é…ç½®",
                    advanced_reset: "é‡ç½®ä¸ºé»˜è®¤",
                    role_leader: "è®®é•¿ (Leader)",
                    role_reporter: "è®°å½•å‘˜ (Reporter)",
                    role_planner: "ç­–è®ºå®¶ (Planner)",
                    role_auditor: "ç›‘å¯Ÿå®˜ (Auditor)",
                    backend_default: "é»˜è®¤åç«¯",
                    agent_model_placeholder: "æ¨¡å‹åç§° (å¯é€‰)",
                    discussion_flow_title: "è®®äº‹è¿‡ç¨‹",
                    intervention_placeholder: "è¾“å…¥å¹²é¢„æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼šè¯·æ›´å¤šå…³æ³¨æˆæœ¬é—®é¢˜ï¼‰...",
                    btn_send_intervention: "å‘é€å¹²é¢„",
                    final_report_title: "æœ€ç»ˆè®®äº‹æŠ¥å‘Š",
                    btn_re_report: "é‡æ–°ç”ŸæˆæŠ¥å‘Š",
                    btn_copy: "å¤åˆ¶",
                    btn_download: "ä¸‹è½½æŠ¥å‘Š",
                    btn_download_html: "HTML æ ¼å¼",
                    btn_download_pdf: "PDF æ ¼å¼",
                    btn_download_image: "å›¾ç‰‡æ ¼å¼",
                    btn_download_md: "Markdown æ ¼å¼",
                    btn_maximize: "æœ€å¤§åŒ–",
                    btn_restore: "è¿˜åŸ",
                    loader_text: "æ­£åœ¨è¿›è¡Œè®®äº‹è®¨è®º...",
                    loader_subtext: "å…ƒè€ä»¬æ­£åœ¨æ¿€çƒˆè¾©è®ºä¸­",
                    log_title: "ç³»ç»Ÿæ‰§è¡Œæ—¥å¿—",
                    btn_clear: "æ¸…é™¤",
                    presets_title: "å…ƒè€é™¢ç¼–åˆ¶ç®¡ç†",
                    presets_save_new: "ä¿å­˜å½“å‰é…ç½®ä¸ºæ–°ç¼–åˆ¶",
                    presets_list: "å·²ä¿å­˜çš„ç¼–åˆ¶",
                    btn_save: "ä¿å­˜",
                    btn_close: "å…³é—­",
                    msg_preset_saved: "ç¼–åˆ¶å·²ä¿å­˜",
                    msg_preset_deleted: "ç¼–åˆ¶å·²åˆ é™¤",
                    msg_preset_loaded: "ç¼–åˆ¶å·²åŠ è½½",
                    msg_preset_name_empty: "è¯·è¾“å…¥ç¼–åˆ¶åç§°",
                    confirm_delete_preset: "ç¡®å®šè¦åˆ é™¤è¯¥ç¼–åˆ¶å—ï¼Ÿ",
                    history_modal_title: "è®®äº‹å†å²è®°å½•",
                    history_loading: "æ­£åœ¨åŠ è½½å†å²è®°å½•...",
                    btn_close: "å…³é—­",
                    confirm_title: "ç¡®è®¤",
                    btn_cancel: "å–æ¶ˆ",
                    btn_confirm: "ç¡®è®¤",
                    alert_title: "æç¤º",
                    btn_ok: "ç¡®å®š",
                    settings_modal_title: "ç³»ç»Ÿå…¨å±€è®¾ç½®",
                    roles_title: "è§’è‰²ç®¡ç†",
                    role_tag_core: "æ ¸å¿ƒè§’è‰²",
                    role_tag_advanced: "é«˜çº§è§’è‰²",
                    role_version: "ç‰ˆæœ¬",
                    role_stages: "é˜¶æ®µ",
                    role_parameters: "å‚æ•°",
                    role_btn_detail: "æŸ¥çœ‹è¯¦æƒ…",
                    role_btn_reload: "é‡æ–°åŠ è½½",
                    role_reload_success: "è§’è‰²é…ç½®å·²é‡æ–°åŠ è½½",
                    role_reload_failed: "é‡æ–°åŠ è½½å¤±è´¥",
                    role_prompt_preview: "æç¤ºè¯é¢„è§ˆ",
                    settings_api_keys: "API å¯†é’¥é…ç½®",
                    settings_search_engines: "æœç´¢å¢å¼ºå¼•æ“ (å¯å¤šé€‰)",
                    settings_browser_path: "æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ (Baidu/Bing æœç´¢)",
                    settings_browser_path_placeholder: "ä¾‹å¦‚: C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
                    search_stable: "ä¸ç¨³å®š",
                    search_stable_good: "ç¨³å®š",
                    search_chinese: "ä¸­æ–‡",
                    search_english: "è‹±æ–‡",
                    btn_save_apply: "ä¿å­˜å¹¶åº”ç”¨",
                    status_processing: "æ­£åœ¨è®®äº‹...",
                    empty_discussion_hint: "è¯·è¾“å…¥è®®é¢˜å¹¶å¼€å§‹è®®äº‹",
                    empty_report_hint: "è®®äº‹å®Œæˆåå°†åœ¨æ­¤ç”ŸæˆæŠ¥å‘Š",
                    msg_input_issue: "è¯·è¾“å…¥è®®é¢˜å†…å®¹",
                    msg_stop_confirm: "åœæ­¢åï¼Œå½“å‰çš„è®¨è®ºè¿›åº¦å°†ä¼šä¸¢å¤±ï¼Œä¸”æ— æ³•ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚",
                    msg_stop_title: "ç¡®è®¤åœæ­¢è®®äº‹ï¼Ÿ",
                    msg_save_success: "è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨",
                    msg_save_failed: "ä¿å­˜å¤±è´¥",
                    msg_copy_success: "æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿",
                    msg_copy_failed: "å¤åˆ¶å¤±è´¥",
                    msg_download_failed: "ä¸‹è½½å¤±è´¥",
                    msg_pdf_failed: "PDF å¯¼å‡ºå¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½ HTML æˆ–å›¾ç‰‡",
                    msg_history_empty: "æš‚æ— å†å²è®°å½•",
                    msg_intervention_sent: "å¹²é¢„æŒ‡ä»¤å·²å‘é€",
                    msg_intervention_failed: "å‘é€å¤±è´¥",
                    msg_start_failed: "å¯åŠ¨å¤±è´¥",
                    msg_request_failed: "è¯·æ±‚å‘é€å¤±è´¥",
                    msg_report_not_ready: "æŠ¥å‘Šå°šæœªç”Ÿæˆï¼Œæ— æ³•ä¸‹è½½",
                    msg_image_failed: "å›¾ç‰‡è½¬æ¢å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½ HTML æ ¼å¼",
                    msg_delete_success: "å†å²è®°å½•å·²æˆåŠŸåˆ é™¤",
                    msg_delete_failed: "åˆ é™¤å¤±è´¥",
                    msg_load_success: "å†å²è®°å½•åŠ è½½æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥è®¨è®ºæµ...",
                    msg_load_failed: "åŠ è½½å¤±è´¥",
                    msg_confirm_delete: "ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•åŠå…¶ç›¸å…³æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚",
                    msg_confirm_load: "åŠ è½½å†å²è®°å½•å°†æ¸…é™¤å½“å‰è®¨è®ºå†…å®¹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ",
                    title_success: "æˆåŠŸ",
                    title_error: "é”™è¯¯",
                    title_hint: "æç¤º",
                    title_confirm_delete: "ç¡®è®¤åˆ é™¤",
                    title_confirm_load: "ç¡®è®¤åŠ è½½",
                    msg_initializing_hall: "æ­£åœ¨åˆå§‹åŒ–è®®äº‹å…...",
                    msg_connecting_backend: "æ­£åœ¨è¿æ¥åç«¯å¼•æ“...",
                    status_running: "æ­£åœ¨è®¨è®º",
                    status_ready: "å°±ç»ª",
                    msg_restoring_progress: "æ­£åœ¨æ¢å¤è®®äº‹è¿›åº¦...",
                    msg_consensus_reached: "ğŸ“œ è®®äº‹è¾¾æˆå…±è¯†ï¼Œæ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...",
                    msg_writing_report: "æ­£åœ¨æ’°å†™æœ€ç»ˆè®®äº‹æŠ¥å‘Š...",
                    msg_thinking_process: "æ€è€ƒè¿‡ç¨‹",
                    msg_search_progress: "æœç´¢è¿›åº¦",
                    msg_details: "è¯¦æƒ…",
                    msg_auditor_review: "å®¡è®¡æ€»ç»“",
                    msg_target: "é’ˆå¯¹",
                    msg_issues: "âš ï¸ è´¨ç–‘ç‚¹",
                    msg_suggestions: "ğŸ’¡ æ”¹è¿›å»ºè®®",
                    msg_audit_summary: "ğŸ“ å®¡è®¡æ€»ç»“",
                    msg_core_goal: "ğŸ¯ æ ¸å¿ƒç›®æ ‡",
                    msg_key_questions: "â“ å…³é”®é—®é¢˜",
                    msg_boundaries: "ğŸš§ è®¨è®ºè¾¹ç•Œ",
                    msg_report_outline: "ğŸ“‹ æŠ¥å‘Šå¤§çº²è®¾è®¡",
                    msg_instructions: "ğŸ“¢ æœ¬è½®æŒ‡ä»¤",
                    msg_core_idea: "ğŸ’¡ æ ¸å¿ƒæ€è·¯",
                    msg_execution_steps: "ğŸš€ æ‰§è¡Œæ­¥éª¤",
                    msg_advantages: "âœ… ä¼˜åŠ¿",
                    msg_resource_requirements: "ğŸ› ï¸ èµ„æºéœ€æ±‚",
                    msg_converting: "è½¬æ¢ä¸­...",
                    msg_re_reporting: "æ­£åœ¨é‡æ–°ç”ŸæˆæŠ¥å‘Š...",
                    msg_re_reporting_sub: "æ­£åœ¨ä½¿ç”¨ {backend} é‡æ–°æ’°å†™æŠ¥å‘Š",
                    msg_writing_report_sub: "è¯·è€å¿ƒç­‰å¾…å…ƒè€é™¢è¾¾æˆå…±è¯†",
                    msg_consensus_reached_sub: "è¯·ç¨å€™ï¼Œæ­£åœ¨æ•´ç†å…ƒè€ä»¬çš„æ™ºæ…§ç»“æ™¶",
                    msg_untitled_issue: "æœªå‘½åè®®é¢˜",
                    btn_delete_record: "åˆ é™¤è®°å½•",
                    msg_unknown_plan: "æœªçŸ¥æ–¹æ¡ˆ",
                    msg_unrated: "æœªè¯„çº§",
                    msg_undefined: "æœªå®šä¹‰",
                    msg_none: "æ— ",
                    msg_browser_missing: "æœªæ‰¾åˆ°æµè§ˆå™¨å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè”ç½‘æœç´¢ï¼ˆBaidu/Bingï¼‰å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨é…ç½®æµè§ˆå™¨è·¯å¾„ã€‚"
                },
                en: {
                    nav_title: "AI Council",
                    nav_subtitle: "Senate Discussion Hall",
                    nav_toggle_logs: "Toggle Logs",
                    nav_orchestrator_mode: "Orchestrator",
                    nav_settings: "System Settings",
                    input_issue_label: "Issue Content",
                    input_issue_placeholder: "Enter the issue you want to discuss (supports multi-line, Enter to send, Shift+Enter for new line)...",
                    input_backend_label: "Backend",
                    input_model_label: "Global Model (Optional)",
                    input_model_placeholder: "Default Model",
                    input_reasoning_label: "Reasoning",
                    reasoning_off: "Off",
                    reasoning_low: "Reasoning: Low",
                    reasoning_medium: "Reasoning: Medium",
                    reasoning_high: "Reasoning: High",
                    input_rounds_label: "Rounds",
                    input_planners_label: "Planners",
                    input_auditors_label: "Auditors",
                    btn_start: "Start Discussion",
                    btn_advanced: "Advanced",
                    advanced_config_title: "Advanced Configuration",
                    tab_basic_config: "Basic Configuration",
                    tab_agent_config: "Seat Expert Configuration",
                    tab_presets: "Council Presets",
                    tab_settings: "System Settings",
                    agent_config_desc: "Specify specific model backends and parameters for different seat experts",
                    presets_name_placeholder: "Enter preset name (e.g., 3-member-DeepSeek-high)",
                    btn_load: "Load",
                    btn_delete: "Delete",
                    btn_apply: "Apply",
                    btn_history: "History",
                    btn_stop: "Stop",
                    advanced_title: "Seat Expert Configuration",
                    advanced_reset: "Reset to Default",
                    role_leader: "Leader",
                    role_reporter: "Reporter",
                    role_planner: "Planner",
                    role_auditor: "Auditor",
                    backend_default: "Default Backend",
                    agent_model_placeholder: "Model Name (Optional)",
                    discussion_flow_title: "Discussion Process",
                    intervention_placeholder: "Enter intervention (e.g., focus more on costs)...",
                    btn_send_intervention: "Send",
                    final_report_title: "Final Report",
                    btn_re_report: "Regenerate",
                    btn_copy: "Copy",
                    btn_download: "Download",
                    btn_download_html: "HTML Format",
                    btn_download_pdf: "PDF Format",
                    btn_download_image: "Image Format",
                    btn_download_md: "Markdown Format",
                    btn_maximize: "Maximize",
                    btn_restore: "Restore",
                    loader_text: "Discussion in progress...",
                    loader_subtext: "The elders are debating fiercely",
                    log_title: "System Logs",
                    btn_clear: "Clear",
                    history_modal_title: "Discussion History",
                    history_loading: "Loading history...",
                    btn_close: "Close",
                    confirm_title: "Confirm",
                    btn_cancel: "Cancel",
                    btn_confirm: "Confirm",
                    alert_title: "Alert",
                    btn_ok: "OK",
                    settings_modal_title: "Global Settings",
                    roles_title: "Role Management",
                    role_tag_core: "Core Role",
                    role_tag_advanced: "Advanced Role",
                    role_version: "Version",
                    role_stages: "Stages",
                    role_parameters: "Parameters",
                    role_btn_detail: "View Details",
                    role_btn_reload: "Reload",
                    role_reload_success: "Role configuration reloaded",
                    role_reload_failed: "Reload failed",
                    role_prompt_preview: "Prompt Preview",
                    settings_api_keys: "API Key Configuration",
                    settings_search_engines: "Search Engines (Multi-select)",
                    settings_browser_path: "Browser Executable Path (Baidu/Bing Search)",
                    settings_browser_path_placeholder: "e.g., C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
                    search_stable: "Not Stable",
                    search_stable_good: "Stable",
                    search_chinese: "Chinese",
                    search_english: "English",
                    btn_save_apply: "Save & Apply",
                    status_processing: "Processing...",
                    empty_discussion_hint: "Enter an issue to start the discussion",
                    empty_report_hint: "Report will be generated here after discussion",
                    msg_input_issue: "Please enter the issue content",
                    msg_stop_confirm: "Stopping will lose current progress and no report will be generated.",
                    msg_stop_title: "Confirm Stop?",
                    msg_save_success: "Settings saved and applied",
                    msg_save_failed: "Save failed",
                    msg_copy_success: "Report copied to clipboard",
                    msg_copy_failed: "Copy failed",
                    msg_download_failed: "Download failed",
                    msg_pdf_failed: "PDF export failed, please try HTML or Image",
                    msg_history_empty: "No history records",
                    msg_intervention_sent: "Intervention sent",
                    msg_intervention_failed: "Send failed",
                    msg_start_failed: "Start failed",
                    msg_request_failed: "Request failed",
                    msg_report_not_ready: "Report not ready, cannot download",
                    msg_image_failed: "Image conversion failed, please try HTML",
                    msg_delete_success: "History deleted successfully",
                    msg_delete_failed: "Delete failed",
                    msg_load_success: "History loaded successfully, syncing flow...",
                    msg_load_failed: "Load failed",
                    msg_confirm_delete: "Are you sure you want to delete this record? This cannot be undone.",
                    msg_confirm_load: "Loading history will clear current discussion. Continue?",
                    title_success: "Success",
                    title_error: "Error",
                    title_hint: "Hint",
                    title_confirm_delete: "Confirm Delete",
                    title_confirm_load: "Confirm Load",
                    msg_initializing_hall: "Initializing discussion hall...",
                    msg_connecting_backend: "Connecting to backend engine...",
                    status_running: "Running",
                    status_ready: "Ready",
                    msg_restoring_progress: "Restoring progress...",
                    msg_consensus_reached: "ğŸ“œ Consensus reached, generating final report...",
                    msg_writing_report: "Writing final report...",
                    msg_thinking_process: "Thinking Process",
                    msg_search_progress: "SEARCH PROGRESS",
                    msg_details: "Details",
                    msg_auditor_review: "Auditor Review",
                    msg_target: "Target",
                    msg_issues: "âš ï¸ Issues",
                    msg_suggestions: "ğŸ’¡ Suggestions",
                    msg_audit_summary: "ğŸ“ Audit Summary",
                    msg_core_goal: "ğŸ¯ Core Goal",
                    msg_key_questions: "â“ Key Questions",
                    msg_boundaries: "ğŸš§ Boundaries",
                    msg_report_outline: "ğŸ“‹ Report Outline",
                    msg_instructions: "ğŸ“¢ Instructions",
                    msg_core_idea: "ğŸ’¡ Core Idea",
                    msg_execution_steps: "ğŸš€ Execution Steps",
                    msg_advantages: "âœ… Advantages",
                    msg_resource_requirements: "ğŸ› ï¸ Requirements",
                    msg_converting: "Converting...",
                    msg_re_reporting: "Regenerating report...",
                    msg_re_reporting_sub: "Rewriting report using {backend}",
                    msg_writing_report_sub: "Please wait for the Senate to reach a consensus",
                    msg_consensus_reached_sub: "Please wait, gathering the wisdom of the elders",
                    msg_untitled_issue: "Untitled Issue",
                    btn_delete_record: "Delete Record",
                    msg_unknown_plan: "Unknown Plan",
                    msg_unrated: "Unrated",
                    msg_undefined: "Undefined",
                    msg_none: "None",
                    msg_browser_missing: "Browser executable not found. Web search (Baidu/Bing) may not work. Please configure the browser path in settings.",
                    nav_presets: "Council Formations",
                    btn_load_preset: "Load Formation",
                    btn_save_current: "Save Current",
                    presets_title: "Council Formations",
                    presets_save_new: "Save Current as New Formation",
                    presets_list: "Saved Formations",
                    btn_save: "Save",
                    msg_preset_saved: "Formation saved",
                    msg_preset_deleted: "Formation deleted",
                    msg_preset_loaded: "Formation loaded",
                    msg_preset_name_empty: "Please enter a formation name",
                    confirm_delete_preset: "Are you sure you want to delete this formation?"
                }
            };

            let currentLang = localStorage.getItem('language') || 'zh';

            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('language', lang);
                
                // æ›´æ–°æ–‡æ¡£æ ‡é¢˜
                document.title = lang === 'zh' ? 'AI Council - å®æ—¶è®¨è®ºè§†å›¾' : 'AI Council - Real-time Discussion';

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const zhBtn = document.getElementById('lang-zh');
                const enBtn = document.getElementById('lang-en');
                if (zhBtn && enBtn) {
                    zhBtn.className = lang === 'zh' 
                        ? 'px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded-md shadow-sm transition-all'
                        : 'px-3 py-1 text-xs font-medium text-slate-400 hover:text-slate-200 transition-all';
                    enBtn.className = lang === 'en'
                        ? 'px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded-md shadow-sm transition-all'
                        : 'px-3 py-1 text-xs font-medium text-slate-400 hover:text-slate-200 transition-all';
                }

                // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n çš„å…ƒç´ 
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        // å¦‚æœå…ƒç´ åŒ…å«å›¾æ ‡ï¼ˆå¦‚ âš™ï¸ï¼‰ï¼Œä¿ç•™å›¾æ ‡
                        const iconMatch = el.innerHTML.match(/^([\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF]|ğŸ’¬|ğŸ“œ|âš™ï¸|âš ï¸|ğŸ’¡|ğŸ“|ğŸ¯|â“|ğŸš§|ğŸ“‹|ğŸ“¢|ğŸš€|âœ…|ğŸ› ï¸)\s*/);
                        if (iconMatch) {
                            const translatedText = translations[lang][key];
                            // å¦‚æœç¿»è¯‘åçš„æ–‡æœ¬å·²ç»åŒ…å«äº†ç›¸åŒçš„å›¾æ ‡ï¼Œåˆ™ä¸å†é‡å¤æ·»åŠ 
                            if (translatedText.startsWith(iconMatch[0].trim())) {
                                el.innerHTML = translatedText;
                            } else {
                                el.innerHTML = iconMatch[0] + translatedText;
                            }
                        } else {
                            el.innerText = translations[lang][key];
                        }
                    }
                });

                // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n-placeholder çš„å…ƒç´ 
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });

                // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n-title çš„å…ƒç´ 
                document.querySelectorAll('[data-i18n-title]').forEach(el => {
                    const key = el.getAttribute('data-i18n-title');
                    if (translations[lang][key]) {
                        el.title = translations[lang][key];
                    }
                });

                // é‡æ–°æ¸²æŸ“åŠ¨æ€ç”Ÿæˆçš„ Agent é…ç½®
                updateAgentConfigsUI();
            }

            // Meta-Orchestrator æ¨¡å¼åˆ‡æ¢
            function toggleOrchestratorMode() {
                const toggle = document.getElementById('orchestrator-mode-toggle');
                isOrchestratorMode = toggle.checked;
                
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('orchestrator_mode', isOrchestratorMode ? 'true' : 'false');
                
                // æ˜¾ç¤ºæç¤º
                const modeText = isOrchestratorMode 
                    ? (currentLang === 'zh' ? 'æ™ºèƒ½ç¼–æ’æ¨¡å¼å·²å¯ç”¨' : 'Orchestrator Mode Enabled')
                    : (currentLang === 'zh' ? 'ä¼ ç»Ÿæ¨¡å¼å·²å¯ç”¨' : 'Traditional Mode Enabled');
                
                console.log(modeText, isOrchestratorMode);
                
                // å¯é€‰ï¼šæ˜¾ç¤ºæç¤ºæ°”æ³¡
                showToast(modeText);
            }

            // ç®€å•çš„æç¤ºæ°”æ³¡
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
                toast.innerText = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }

            function t(key) {
                return translations[currentLang][key] || key;
            }

            // é€šç”¨æç¤ºæ¡†
            function showAlert(message, title = '', type = 'info') {
                const modal = document.getElementById('alert-modal');
                const titleEl = document.getElementById('alert-title');
                const messageEl = document.getElementById('alert-message');
                const iconEl = document.getElementById('alert-icon');
                
                titleEl.innerText = title || t('alert_title');
                messageEl.innerText = message;
                
                if (type === 'error') {
                    iconEl.className = 'w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4';
                    iconEl.innerHTML = '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                } else if (type === 'warning') {
                    iconEl.className = 'w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4';
                    iconEl.innerHTML = '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                } else {
                    iconEl.className = 'w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4';
                    iconEl.innerHTML = '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }
                
                modal.classList.remove('hidden');
            }

            function closeAlertModal() {
                document.getElementById('alert-modal').classList.add('hidden');
            }

            // é€šç”¨ç¡®è®¤æ¡†
            function showConfirm(message, title = '') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirm-modal');
                    const titleEl = document.getElementById('confirm-title');
                    const messageEl = document.getElementById('confirm-message');
                    const okBtn = document.getElementById('confirm-ok-btn');
                    const cancelBtn = document.getElementById('confirm-cancel-btn');
                    
                    titleEl.innerText = title || t('confirm_title');
                    messageEl.innerText = message;
                    
                    const handleOk = () => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(true);
                    };
                    
                    const handleCancel = () => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        okBtn.removeEventListener('click', handleOk);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    okBtn.addEventListener('click', handleOk);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    modal.classList.remove('hidden');
                });
            }

            // å¯†ç è¾“å…¥æ¡†
            function showPasswordInput(message, title = 'å®‰å…¨éªŒè¯') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('password-input-modal');
                    const titleEl = document.getElementById('password-input-title');
                    const messageEl = document.getElementById('password-input-message');
                    const inputField = document.getElementById('password-input-field');
                    const okBtn = document.getElementById('password-input-ok-btn');
                    const cancelBtn = document.getElementById('password-input-cancel-btn');
                    
                    titleEl.innerText = title;
                    messageEl.innerText = message;
                    inputField.value = '';
                    
                    const handleOk = () => {
                        const password = inputField.value;
                        if (!password) {
                            inputField.focus();
                            return;
                        }
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(password);
                    };
                    
                    const handleCancel = () => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(null);
                    };
                    
                    const handleEnter = (e) => {
                        if (e.key === 'Enter') {
                            handleOk();
                        }
                    };
                    
                    const cleanup = () => {
                        okBtn.removeEventListener('click', handleOk);
                        cancelBtn.removeEventListener('click', handleCancel);
                        inputField.removeEventListener('keypress', handleEnter);
                    };
                    
                    okBtn.addEventListener('click', handleOk);
                    cancelBtn.addEventListener('click', handleCancel);
                    inputField.addEventListener('keypress', handleEnter);
                    
                    modal.classList.remove('hidden');
                    setTimeout(() => inputField.focus(), 100);
                });
            }

            async function fetchUpdates() {
                try {
                    const statusResponse = await fetch('/api/status');
                    const statusData = await statusResponse.json();
                    updateStatusUI(statusData);

                    const eventsResponse = await fetch('/api/events');
                    const eventsData = await eventsResponse.json();

                    if (eventsData.events && eventsData.events.length > lastEventCount) {
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨ï¼ˆå…è®¸ 100px çš„è¯¯å·®ï¼‰
                        const isAtBottom = discussionContainer.scrollHeight - discussionContainer.scrollTop <= discussionContainer.clientHeight + 100;
                        
                        const newEvents = eventsData.events.slice(lastEventCount);
                        newEvents.forEach(event => {
                            appendEvent(event);
                            updateProgress(event);
                        });
                        lastEventCount = eventsData.events.length;
                        
                        if (isAtBottom) {
                            discussionContainer.scrollTo({
                                top: discussionContainer.scrollHeight,
                                behavior: 'smooth'
                            });
                        }
                    }

                    if (eventsData.logs && eventsData.logs.length > lastLogCount) {
                        // æ£€æŸ¥æ—¥å¿—æ˜¯å¦åœ¨åº•éƒ¨
                        const isLogAtBottom = logContainer.scrollHeight - logContainer.scrollTop <= logContainer.clientHeight + 50;
                        
                        const newLogs = eventsData.logs.slice(lastLogCount);
                        newLogs.forEach(log => appendLog(log));
                        lastLogCount = eventsData.logs.length;
                        
                        if (isLogAtBottom) {
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }

                    if (eventsData.final_report) {
                        handleFinalReport(eventsData.final_report);
                    }
                } catch (error) {
                    console.error('Fetch updates error:', error);
                }
            }

            // æ³¨å…¥ä¿®è®¢é¢æ¿åˆ°æŠ¥å‘ŠHTMLä¸­
            function injectRevisionPanel(html) {
                // è·å–å½“å‰workspace_id
                const workspaceId = currentSessionId || 'unknown';
                
                const revisionPanelHtml = `
<!-- æŠ¥å‘Šä¿®è®¢é¢æ¿ -->
<div id="revision-panel" style="
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    z-index: 10000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
">
    <!-- æŠ˜å /å±•å¼€æŒ‰é’® -->
    <button id="revision-toggle" onclick="toggleRevisionPanel()" style="
        position: absolute;
        top: -40px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    ">
        ğŸ’¬ ä¿®è®¢åé¦ˆ
    </button>
    
    <div id="revision-content" style="display: none; padding: 20px; max-width: 1200px; margin: 0 auto;">
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div style="flex: 1;">
                <h3 style="color: white; margin: 0 0 10px 0; font-size: 16px;">ğŸ“ è¯·è¾“å…¥æ‚¨çš„ä¿®æ”¹è¦æ±‚</h3>
                <textarea id="revision-feedback" placeholder="ä¾‹å¦‚ï¼š&#10;â€¢ ç¬¬äºŒç« èŠ‚éœ€è¦è¡¥å……æ›´å¤šå®æ–½ç»†èŠ‚&#10;â€¢ é£é™©åˆ†æéƒ¨åˆ†è¿‡äºä¹è§‚ï¼Œè¯·å¢åŠ æ½œåœ¨é£é™©&#10;â€¢ è¯·å°†ç»“è®ºéƒ¨åˆ†ç²¾ç®€ä¸º3ä¸ªè¦ç‚¹" style="
                    width: 100%;
                    height: 80px;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    resize: vertical;
                    font-family: inherit;
                    box-sizing: border-box;
                "></textarea>
            </div>
            
            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div style="display: flex; flex-direction: column; gap: 10px; min-width: 150px;">
                <button onclick="submitRevision()" id="btn-submit-revision" style="
                    background: white;
                    color: #667eea;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                ">
                    ğŸ“¤ æäº¤ä¿®è®¢
                </button>
                <button onclick="confirmSatisfied()" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 2px solid white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    âœ… æ»¡æ„
                </button>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="revision-status" style="display: none; margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white;">
            <span id="revision-status-text">å¤„ç†ä¸­...</span>
        </div>
        
        <!-- ä¿®è®¢ç»“æœæ˜¾ç¤º -->
        <div id="revision-result" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.95); border-radius: 8px; color: #333; max-height: 200px; overflow-y: auto;">
        </div>
    </div>
</div>

<script>
const WORKSPACE_ID = "${workspaceId}";
let panelCollapsed = true;

function toggleRevisionPanel() {
    const content = document.getElementById('revision-content');
    const toggle = document.getElementById('revision-toggle');
    
    if (panelCollapsed) {
        content.style.display = 'block';
        toggle.innerHTML = 'âœ• å…³é—­';
        panelCollapsed = false;
    } else {
        content.style.display = 'none';
        toggle.innerHTML = 'ğŸ’¬ ä¿®è®¢åé¦ˆ';
        panelCollapsed = true;
    }
}

async function submitRevision() {
    const feedback = document.getElementById('revision-feedback').value.trim();
    if (!feedback) {
        alert('è¯·è¾“å…¥ä¿®æ”¹è¦æ±‚');
        return;
    }
    
    const statusDiv = document.getElementById('revision-status');
    const statusText = document.getElementById('revision-status-text');
    const resultDiv = document.getElementById('revision-result');
    const submitBtn = document.getElementById('btn-submit-revision');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    statusDiv.style.display = 'block';
    statusText.innerHTML = 'â³ æŠ¥å‘Šå®¡æ ¸å®˜æ­£åœ¨å¤„ç†æ‚¨çš„ä¿®è®¢è¦æ±‚...';
    resultDiv.style.display = 'none';
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'â³ å¤„ç†ä¸­...';
    
    try {
        // è·å–å½“å‰æŠ¥å‘ŠHTMLï¼ˆä¸åŒ…å«ä¿®è®¢é¢æ¿ï¼‰
        const panelEl = document.getElementById('revision-panel');
        if (panelEl) panelEl.remove();
        const reportContent = document.documentElement.outerHTML;
        
        const response = await fetch('/api/revise_report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                workspace_id: WORKSPACE_ID,
                user_feedback: feedback,
                current_html: reportContent
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // æ˜¾ç¤ºä¿®è®¢ç»“æœ
            statusDiv.style.display = 'none';
            resultDiv.style.display = 'block';
            
            let changesHtml = '<h4 style="margin:0 0 10px 0;color:#667eea;">âœ… ä¿®è®¢å®Œæˆï¼ˆç‰ˆæœ¬ ' + data.version + 'ï¼‰</h4>';
            changesHtml += '<p style="margin:0 0 10px 0;"><strong>æ¦‚è¦ï¼š</strong>' + data.revision_summary + '</p>';
            
            if (data.changes_made && data.changes_made.length > 0) {
                changesHtml += '<p style="margin:0 0 5px 0;"><strong>ä¿®æ”¹å†…å®¹ï¼š</strong></p><ul style="margin:0;padding-left:20px;">';
                data.changes_made.forEach(function(c) {
                    changesHtml += '<li>' + c + '</li>';
                });
                changesHtml += '</ul>';
            }
            
            if (data.warnings && data.warnings.length > 0) {
                changesHtml += '<p style="margin:10px 0 5px 0;color:#f59e0b;"><strong>âš ï¸ æ³¨æ„ï¼š</strong></p><ul style="margin:0;padding-left:20px;color:#f59e0b;">';
                data.warnings.forEach(function(w) {
                    changesHtml += '<li>' + w + '</li>';
                });
                changesHtml += '</ul>';
            }
            
            changesHtml += '<p style="margin:15px 0 0 0;"><button onclick="applyRevision()" style="background:#667eea;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">ğŸ”„ åº”ç”¨ä¿®è®¢</button></p>';
            
            resultDiv.innerHTML = changesHtml;
            
            // ä¿å­˜ä¿®è®¢åçš„HTML
            window._revisedHtml = data.revised_html;
            
        } else {
            statusText.innerHTML = 'âŒ ä¿®è®¢å¤±è´¥ï¼š' + data.message;
        }
        
    } catch (error) {
        statusText.innerHTML = 'âŒ è¯·æ±‚å¤±è´¥ï¼š' + error.message;
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ“¤ æäº¤ä¿®è®¢';
    }
}

function applyRevision() {
    if (window._revisedHtml) {
        // é€šçŸ¥çˆ¶çª—å£æ›´æ–°æŠ¥å‘Š
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'revision_applied', html: window._revisedHtml }, '*');
        }
    }
}

function confirmSatisfied() {
    if (confirm('ç¡®è®¤å¯¹å½“å‰æŠ¥å‘Šæ»¡æ„ï¼Ÿ')) {
        document.getElementById('revision-panel').style.display = 'none';
    }
}
<\/script>
`;
                
                // åœ¨</body>ä¹‹å‰æ³¨å…¥
                if (html.includes('</body>')) {
                    return html.replace('</body>', revisionPanelHtml + '</body>');
                }
                return html + revisionPanelHtml;
            }

            function handleFinalReport(reportHtml) {
                // **æ–¹æ¡ˆAä¿®å¤**: ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤æ›¿æ¢å¯¼è‡´çš„é—ªçƒ
                // å¦‚æœç¼“å­˜ä¸æ–°å†…å®¹ç›¸åŒï¼Œç›´æ¥è¿”å›ï¼ˆé¿å…æ— é™å¾ªç¯ï¼‰
                if (cachedReportHtml === reportHtml) {
                    // å³ä½¿å†…å®¹ç›¸åŒï¼Œä¹Ÿè¦æ£€æŸ¥ç‰ˆæœ¬ï¼ˆé¦–æ¬¡åŠ è½½æ—¶ï¼‰
                    fetchReportVersions();
                    return;
                }
                
                if (reportIframe) {
                    if (reportHtml && !reportHtml.includes('italic') && !reportHtml.includes('text-align:center')) {
                        // ä¿®å¤ srcdoc ä¸­çš„é™æ€èµ„æºè·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ -> ç»å¯¹URLï¼‰
                        const baseUrl = window.location.origin;
                        
                        // æ‰§è¡Œè·¯å¾„æ›¿æ¢ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
                        let processedHtml = reportHtml
                            .replace(
                                /src=["']\/static\/vendor\/echarts\.min\.js["']/g,
                                `src="${baseUrl}/static/vendor/echarts.min.js"`
                            )
                            .replace(
                                /src=["']\/static\/vendor\/mermaid\.min\.js["']/g,
                                `src="${baseUrl}/static/vendor/mermaid.min.js"`
                            )
                            .replace(
                                /href=["']\/static\/css\/editor\.css["']/g,
                                `href="${baseUrl}/static/css/editor.css"`
                            )
                            .replace(
                                /src=["']\/static\/js\/report-editor\.js["']/g,
                                `src="${baseUrl}/static/js/report-editor.js"`
                            );
                        
                        // æ³¨å…¥ä¿®è®¢é¢æ¿ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                        if (!processedHtml.includes('revision-panel')) {
                            processedHtml = injectRevisionPanel(processedHtml);
                        }
                        
                        // åªåœ¨å¤„ç†åçš„å†…å®¹ä¸å½“å‰ srcdoc ä¸åŒæ—¶æ‰æ›´æ–°
                        if (reportIframe.srcdoc !== processedHtml) {
                            reportIframe.srcdoc = processedHtml;
                            // ç¼“å­˜åŸå§‹ HTMLï¼ˆç”¨äºæ¯”è¾ƒï¼‰
                            cachedReportHtml = reportHtml;
                            // ä¸åœ¨è¿™é‡Œéšè— loadingï¼Œç”± updateStatusUI æ ¹æ® is_running çŠ¶æ€ç»Ÿä¸€å¤„ç†
                            setLayoutMode('report');
                            // æ£€æŸ¥å¹¶æ›´æ–°ç‰ˆæœ¬é€‰æ‹©ä¸‹æ‹‰æ¡†
                            fetchReportVersions();
                        }
                    } else {
                        // å¤„ç†ç©ºç™½æˆ–åŠ è½½ä¸­çš„çŠ¶æ€
                        if (reportIframe.srcdoc !== reportHtml) {
                            reportIframe.srcdoc = reportHtml;
                            cachedReportHtml = reportHtml;
                        }
                    }
                }
            }

            function resetAgentConfigs() {
                document.querySelectorAll('.agent-backend').forEach(select => select.value = 'default');
                document.querySelectorAll('.agent-model').forEach(input => input.value = '');
                document.querySelectorAll('.agent-reasoning').forEach(select => select.value = '');
                document.querySelectorAll('.agent-reasoning').forEach(select => select.classList.add('hidden'));
                showAlert(t('msg_save_success'), t('title_success'));
            }

            function toggleReportLoading(isLoading, text = '', subtext = '') {
                const loader = document.getElementById('report-loader');
                const loaderText = document.getElementById('loader-text');
                const loaderSubtext = document.getElementById('loader-subtext');
                const actionButtons = document.querySelectorAll('#report-actions button');

                if (isLoading) {
                    loader.classList.remove('hidden');
                    if (text) loaderText.innerText = text;
                    if (subtext) loaderSubtext.innerText = subtext;
                    actionButtons.forEach(btn => btn.disabled = true);
                } else {
                    loader.classList.add('hidden');
                    actionButtons.forEach(btn => btn.disabled = false);
                }
            }

            // æœ€å¤§åŒ–/è¿˜åŸåŠŸèƒ½
            function toggleMaximize(sectionId) {
                const section = document.getElementById(sectionId);
                const btn = section.querySelector('button[onclick^="toggleMaximize"]');
                const icon = document.getElementById(sectionId === 'discussion-section' ? 'discussion-maximize-icon' : 'report-maximize-icon');
                const isMaximized = section.classList.toggle('maximized');
                
                if (isMaximized) {
                    // åˆ‡æ¢ä¸ºè¿˜åŸå›¾æ ‡ (4ä¸ªç®­å¤´æŒ‡å‘ä¸­å¿ƒ)
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 14h6v6M20 10h-6V4M3 21l7-7M21 3l-7 7"></path>';
                    btn.setAttribute('data-i18n-title', 'btn_restore');
                    btn.title = t('btn_restore');
                    document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
                } else {
                    // åˆ‡æ¢ä¸ºæœ€å¤§åŒ–å›¾æ ‡ (4ä¸ªç®­å¤´æŒ‡å‘å¤–)
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>';
                    btn.setAttribute('data-i18n-title', 'btn_maximize');
                    btn.title = t('btn_maximize');
                    document.body.style.overflow = '';
                }
            }

            // ä¸‹è½½ä¸‹æ‹‰èœå•åˆ‡æ¢
            function toggleDownloadDropdown() {
                const dropdown = document.getElementById('download-dropdown');
                dropdown.classList.toggle('show');
            }

            function setLayoutMode(mode) {
                const layout = document.getElementById('main-layout');
                if (mode === 'discussion') {
                    layout.classList.remove('report-wide');
                    layout.classList.add('discussion-wide');
                } else if (mode === 'report') {
                    layout.classList.remove('discussion-wide');
                    layout.classList.add('report-wide');
                }
            }

            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
            window.onclick = function(event) {
                // å¤„ç†ä¸‹è½½ä¸‹æ‹‰èœå•
                if (!event.target.closest('#download-dropdown-btn') && 
                    !event.target.closest('#download-dropdown')) {
                    const dd = document.getElementById('download-dropdown');
                    if (dd && dd.classList.contains('show')) {
                        dd.classList.remove('show');
                    }
                }

                // å¤„ç†ç¼–åˆ¶ä¸‹æ‹‰èœå•
                if (!event.target.closest('#presets-dropdown-btn') && 
                    !event.target.closest('#presets-dropdown')) {
                    const pd = document.getElementById('presets-dropdown');
                    if (pd && pd.classList.contains('show')) {
                        pd.classList.remove('show');
                    }
                }
            }

            // é…ç½® marked
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            let lastEventCount = 0;
            let lastLogCount = 0;
            let currentProgress = 0;
            let currentRound = 1;
            let currentSessionId = null;
            let isRunning = false;
            let isReportingPhase = false;
            let openRouterModelsFetched = false;
            let isFetchingModels = false;
            let cachedReportHtml = null;  // ç¼“å­˜å¤„ç†åçš„æŠ¥å‘ŠHTMLï¼Œé¿å…é‡å¤æ›¿æ¢å¯¼è‡´é—ªçƒ
            let isOrchestratorMode = false;  // Meta-Orchestrator æ¨¡å¼æ ‡å¿—
            const flowContainer = document.getElementById('discussion-flow');
            const discussionContainer = document.getElementById('discussion-container');
            const logContainer = document.getElementById('log-container');
            const reportIframe = document.getElementById('report-iframe');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            async function startDiscussion() {
                if (isRunning) return;
                
                const issue = document.getElementById('issue-input').value.trim();
                const backend = document.getElementById('backend-select').value;
                const model = document.getElementById('global-model-input').value;
                const reasoningEffort = document.getElementById('global-reasoning-input').value;
                const rounds = document.getElementById('rounds-input').value;
                const planners = document.getElementById('planners-input').value;
                const auditors = document.getElementById('auditors-input').value;

                // æ”¶é›† Agent é…ç½®
                const agentConfigs = {};
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    const agentBackend = select.value;
                    const modelEl = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    const reasoningEl = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                    
                    const agentModel = modelEl ? modelEl.value.trim() : '';
                    const agentReasoning = reasoningEl ? reasoningEl.value : '';
                    
                    if (agentBackend !== 'default' || agentModel !== '' || agentReasoning !== '') {
                        agentConfigs[agentId] = {
                            type: agentBackend === 'default' ? backend : agentBackend,
                            model: agentModel || undefined,
                            reasoning: agentReasoning ? { effort: agentReasoning } : undefined
                        };
                    }
                });

                if (!issue) {
                    showAlert(t('msg_input_issue'), t('title_hint'));
                    return;
                }

                // è®¾ç½®è¿è¡ŒçŠ¶æ€
                isRunning = true;
                
                // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
                const issueInput = document.getElementById('issue-input');
                issueInput.style.height = 'auto';

                // æ¸…ç©ºæ—§å†…å®¹å¹¶æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
                flowContainer.innerHTML = `<div class="flex justify-center my-4 animate-pulse"><span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-medium">${t('msg_initializing_hall')}</span></div>`;
                logContainer.innerHTML = `<div class="text-slate-500 italic">${t('msg_connecting_backend')}</div>`;
                if (reportIframe) {
                    reportIframe.srcdoc = '<div style="color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;"></div>';
                }
                setLayoutMode('discussion');
                isReportingPhase = false;
                lastEventCount = 0;
                lastLogCount = 0;
                currentProgress = 0;
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-percentage').innerText = '0%';
                
                // åˆ‡æ¢åˆ°è®¨è®ºæ¨¡å¼å¸ƒå±€
                setLayoutMode('discussion');

                try {
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            issue, 
                            backend, 
                            model: model || undefined,
                            reasoning: reasoningEffort ? { effort: reasoningEffort } : undefined,
                            rounds, 
                            planners, 
                            auditors,
                            agent_configs: Object.keys(agentConfigs).length > 0 ? agentConfigs : null,
                            use_meta_orchestrator: isOrchestratorMode
                        })
                    });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        console.log('è®¨è®ºå·²å¯åŠ¨');
                    } else {
                        isRunning = false;
                        updateStatusUI({ is_running: false });
                        showAlert(t('msg_start_failed') + ': ' + data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Start error:', error);
                    isRunning = false;
                    updateStatusUI({ is_running: false });
                    showAlert(t('msg_request_failed'), t('title_error'), 'error');
                }
            }

            async function stopDiscussion() {
                if (!isRunning) return;
                
                const confirmed = await showConfirm(t('msg_stop_confirm'), t('msg_stop_title'));
                if (!confirmed) return;
                
                try {
                    const response = await fetch('/api/stop', { method: 'POST' });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        isRunning = false;
                        updateStatusUI({ is_running: false });
                    }
                } catch (error) {
                    console.error('Stop error:', error);
                }
            }

            async function reReport() {
                if (isRunning) return;
                
                const backend = document.getElementById('backend-select').value;
                const model = document.getElementById('global-model-input').value;
                const reasoningEffort = document.getElementById('global-reasoning-input').value;
                
                // æ”¶é›† Agent é…ç½®
                const agentConfigs = {};
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    const agentBackend = select.value;
                    const modelEl = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    const reasoningEl = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                    
                    const agentModel = modelEl ? modelEl.value.trim() : '';
                    const agentReasoning = reasoningEl ? reasoningEl.value : '';
                    
                    if (agentBackend !== 'default' || agentModel !== '' || agentReasoning !== '') {
                        agentConfigs[agentId] = {
                            type: agentBackend === 'default' ? backend : agentBackend,
                            model: agentModel || undefined,
                            reasoning: agentReasoning ? { effort: agentReasoning } : undefined
                        };
                    }
                });
                
                // æ¸…ç©ºæ—§æŠ¥å‘Šå†…å®¹å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (reportIframe) {
                    reportIframe.srcdoc = '<div style="color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;"></div>';
                }
                isReportingPhase = true;
                toggleReportLoading(true, t('msg_re_reporting'), t('msg_re_reporting_sub').replace('{backend}', backend));
                
                try {
                    const response = await fetch('/api/rereport', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            backend: backend,
                            model: model || undefined,
                            reasoning: reasoningEffort ? { effort: reasoningEffort } : undefined,
                            agent_configs: Object.keys(agentConfigs).length > 0 ? agentConfigs : null
                        })
                    });
                    const data = await response.json();
                    if (data.status !== 'ok') {
                        const errorMsg = data.message || t('msg_request_failed');
                        showAlert(errorMsg, t('title_error'), 'error');
                        toggleReportLoading(false);
                        isReportingPhase = false;
                    }
                } catch (error) {
                    console.error('Re-report error:', error);
                    showAlert(t('msg_request_failed'), t('title_error'), 'error');
                    toggleReportLoading(false);
                    isReportingPhase = false;
                }
            }

            async function sendIntervention() {
                const input = document.getElementById('intervention-input');
                const content = input.value.trim();
                if (!content) return;

                try {
                    const response = await fetch('/api/intervention', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        input.value = '';
                        showAlert(t('msg_intervention_sent'), t('title_success'));
                    } else {
                        showAlert(t('msg_intervention_failed') + ': ' + data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Intervention error:', error);
                    showAlert(t('msg_intervention_failed'), t('title_error'), 'error');
                }
            }

            function updateStatusUI(statusData) {
                const running = statusData.is_running;
                const config = statusData.config;
                isRunning = running;
                const reportLoader = document.getElementById('report-loader');
                const loaderText = document.getElementById('loader-text');
                const loaderSubtext = document.getElementById('loader-subtext');
                const interventionArea = document.getElementById('intervention-area');
                const browserWarning = document.getElementById('browser-warning');
                
                // æ›´æ–°æµè§ˆå™¨çŠ¶æ€è­¦å‘Š
                if (statusData.browser_found === false) {
                    browserWarning.classList.remove('hidden');
                } else {
                    browserWarning.classList.add('hidden');
                }
                
                // å¦‚æœæ­£åœ¨è¿è¡Œä¸”è¾“å…¥æ¡†ä¸ºç©ºï¼ˆè¯´æ˜æ˜¯åˆ·æ–°é¡µé¢ï¼‰ï¼Œåˆ™å¡«å……é…ç½®
                if (running && config) {
                    const issueInput = document.getElementById('issue-input');
                    if (!issueInput.value.trim()) {
                        issueInput.value = config.issue || '';
                        document.getElementById('backend-select').value = config.backend || 'deepseek';
                        document.getElementById('rounds-input').value = config.rounds || 3;
                        document.getElementById('planners-input').value = config.planners || 2;
                        document.getElementById('auditors-input').value = config.auditors || 2;
                        // è§¦å‘é«˜åº¦è‡ªé€‚åº”
                        issueInput.style.height = '';
                        issueInput.style.height = issueInput.scrollHeight + 'px';
                    }
                }

                if (running) {
                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”ŸæˆæŠ¥å‘Š
                    const currentText = loaderText ? loaderText.innerText.toLowerCase() : '';
                    const isReporting = isReportingPhase || (
                        currentText.includes('æŠ¥å‘Š') || 
                        currentText.includes('æ’°å†™') || 
                        currentText.includes('report') || 
                        currentText.includes('writing') ||
                        currentText.includes('è¾¾æˆå…±è¯†') ||
                        currentText.includes('consensus')
                    );

                    // åªæœ‰åœ¨è¿˜æ²¡æœ‰æŠ¥å‘Šå†…å®¹ä¸”ä¸åœ¨æŠ¥å‘Šç”Ÿæˆé˜¶æ®µæ—¶ï¼Œæ‰åœ¨è¿è¡ŒçŠ¶æ€ä¸‹å¼ºåˆ¶åˆ‡æ¢åˆ°è®¨è®ºæ¨¡å¼
                    // è¿™æ ·å¯ä»¥é˜²æ­¢æŠ¥å‘Šç”Ÿæˆè¿‡ç¨‹ä¸­å¸ƒå±€å¿½å¤§å¿½å°
                    if (!isReporting && (!reportIframe.srcdoc || reportIframe.srcdoc.includes('italic'))) {
                        setLayoutMode('discussion');
                    } else if (isReporting) {
                        setLayoutMode('report');
                    }
                    
                    startBtn.disabled = true;
                    startBtn.innerText = t('status_processing');
                    stopBtn.classList.remove('hidden');
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    statusText.innerText = t('status_running');
                    interventionArea.classList.remove('hidden');

                    // å¦‚æœæ˜¯åˆ·æ–°é¡µé¢ä¸”è¿˜æ²¡æœ‰åŠ è½½å‡ºäº‹ä»¶ï¼Œæ˜¾ç¤ºæ¢å¤çŠ¶æ€
                    if (lastEventCount === 0 && flowContainer.innerHTML.trim() === '') {
                        flowContainer.innerHTML = `<div class="flex justify-center my-4 animate-pulse"><span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-medium">${t('msg_restoring_progress')}</span></div>`;
                    }

                    // æ˜¾ç¤ºæŠ¥å‘ŠåŠ è½½é®ç½©
                    // å¦‚æœæ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œæˆ–è€…è¿˜æ²¡æœ‰æŠ¥å‘Šå†…å®¹ï¼Œåˆ™æ˜¾ç¤ºé®ç½©
                    if (reportLoader && (isReporting || !reportIframe.srcdoc || reportIframe.srcdoc.includes('italic'))) {
                        let targetText = t('loader_text');
                        let targetSub = t('loader_subtext');
                        
                        if (isReporting) {
                            // å¦‚æœæ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œä¼˜å…ˆä½¿ç”¨å½“å‰ DOM ä¸­çš„æ–‡å­—ï¼ˆå¦‚æœä¸æ˜¯é»˜è®¤æ–‡å­—ï¼‰
                            // å¦åˆ™ä½¿ç”¨â€œæ­£åœ¨æ’°å†™æŠ¥å‘Šâ€çš„æç¤º
                            if (loaderText.innerText && !loaderText.innerText.includes(t('loader_text'))) {
                                targetText = loaderText.innerText;
                                targetSub = loaderSubtext.innerText;
                            } else {
                                targetText = t('msg_writing_report');
                                targetSub = t('msg_writing_report_sub');
                            }
                        }
                        toggleReportLoading(true, targetText, targetSub);
                    }
                } else {
                    isReportingPhase = false;
                    startBtn.disabled = false;
                    startBtn.innerText = t('btn_start');
                    stopBtn.classList.add('hidden');
                    statusDot.className = 'w-3 h-3 bg-blue-500 rounded-full';
                    statusText.innerText = t('status_ready');
                    interventionArea.classList.add('hidden');
                    // éšè—æŠ¥å‘ŠåŠ è½½é®ç½©å¹¶å¯ç”¨æŒ‰é’®
                    toggleReportLoading(false);

                    // å¦‚æœä¸è¿è¡Œï¼Œä¸”å·²ç»æœ‰æŠ¥å‘Šå†…å®¹ï¼Œåˆ™åˆ‡æ¢åˆ°æŠ¥å‘Šæ¨¡å¼
                    if (reportIframe && reportIframe.srcdoc && reportIframe.srcdoc.length > 200 && !reportIframe.srcdoc.includes('italic')) {
                        setLayoutMode('report');
                    }
                }
                updateRoundUI();
            }

            function updateRoundUI() {
                const roundInfo = document.getElementById('round-info');
                const maxRounds = parseInt(document.getElementById('rounds-input').value) || 3;
                if (isRunning) {
                    roundInfo.innerText = `Round ${currentRound} / ${maxRounds}`;
                    roundInfo.classList.remove('hidden');
                } else {
                    roundInfo.classList.add('hidden');
                }
            }

            function updateProgress(event) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-percentage');
                const maxRounds = parseInt(document.getElementById('rounds-input').value) || 3;
                
                let targetProgress = currentProgress;

                if (event.type === 'system_start') {
                    targetProgress = 0;
                    currentRound = 1;
                } else if (event.type === 'round_start') {
                    currentRound = event.round;
                    // æ¯ä¸€è½®ç»“æŸæ—¶ï¼ˆå³ä¸‹ä¸€è½®å¼€å§‹æ—¶ï¼‰å¢åŠ æ•°å€¼
                    // è¿›åº¦ = (å½“å‰è½®æ•° - 1) / æ€»è½®æ•° * 100
                    targetProgress = ((currentRound - 1) / maxRounds) * 100;
                } else if (event.type === 'agent_action') {
                    // ä»…å½“è®°å½•å‘˜å‡ºç°æ—¶ï¼Œè¡¨ç¤ºè¿›å…¥æŠ¥å‘Šç”Ÿæˆé˜¶æ®µï¼Œè¿›åº¦è®¾ä¸º 95% (ç•™ 5% ç»™æœ€ç»ˆæŠ¥å‘Š)
                    if (event.role_type === 'Reporter') {
                        targetProgress = 95;
                        setLayoutMode('report');
                    }
                } else if (event.type === 'role_designer_reasoning' || event.type === 'role_designer_content') {
                    // å¤„ç†è§’è‰²è®¾è®¡å¸ˆçš„å®æ—¶æ›´æ–°
                    handleRoleDesignerEvent(event);
                } else if (event.type === 'discussion_complete' || event.type === 'final_report') {
                    targetProgress = 100;
                    // åˆ‡æ¢åˆ°æŠ¥å‘Šæ¨¡å¼å¸ƒå±€
                    setLayoutMode('report');
                }

                // ç¡®ä¿è¿›åº¦ä¸ä¼šè¶…è¿‡ 100% æˆ–å‡ºç°å¼‚å¸¸å€¼
                targetProgress = Math.min(100, Math.max(0, targetProgress));

                if (targetProgress > currentProgress || event.type === 'system_start') {
                    currentProgress = targetProgress;
                    progressBar.style.width = `${currentProgress}%`;
                    progressText.innerText = `${Math.round(currentProgress)}%`;
                }
                updateRoundUI();
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function appendEvent(event) {
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªäº‹ä»¶ï¼Œä¸”å®¹å™¨å†…åªæœ‰åˆå§‹åŒ–æ¶ˆæ¯ï¼Œåˆ™æ¸…ç©º
                if (lastEventCount === 0 && flowContainer.querySelector('.animate-pulse')) {
                    flowContainer.innerHTML = '';
                }

                if (event.chunk_id) {
                    let existing = document.getElementById(`event-${event.chunk_id}`);
                    if (existing) {
                        const contentDiv = existing.querySelector('.event-content');
                        const reasoningDiv = existing.querySelector('.event-reasoning');
                        
                        if (event.reasoning && reasoningDiv) {
                            reasoningDiv.textContent += event.reasoning;
                            // å®æ—¶æ¸…ç†å¼€å¤´çš„ç©ºè¡Œå’Œç©ºæ ¼
                            const trimmed = reasoningDiv.textContent.replace(/^\s+/, '');
                            if (reasoningDiv.textContent !== trimmed) {
                                reasoningDiv.textContent = trimmed;
                            }
                            reasoningDiv.closest('.reasoning-wrapper').classList.remove('hidden');
                        }
                        if (event.content && contentDiv) {
                            const oldRaw = contentDiv.dataset.raw || "";
                            const newRaw = oldRaw + event.content;
                            
                            // 1. è‡ªåŠ¨æ”¶ç¼©æ¨ç† (Reasoning)
                            // å¦‚æœæ¨ç†éƒ¨åˆ†è¿˜æ²¡æ”¶ç¼©ï¼Œä¸”ç°åœ¨å¼€å§‹è¾“å‡ºæ­£å¼å†…å®¹ï¼ˆéç©ºä¸”ä¸æ˜¯æœç´¢æ ‡è®°ï¼‰ï¼Œåˆ™æ”¶ç¼©å®ƒ
                            if (reasoningDiv && !reasoningDiv.classList.contains('collapsed')) {
                                if (event.content.trim() && !event.content.includes('SEARCH PROGRESS')) {
                                    const header = reasoningDiv.closest('.reasoning-wrapper').querySelector('.cursor-pointer');
                                    if (header) toggleReasoning(header);
                                }
                            }

                            // 2. è‡ªåŠ¨æ”¶ç¼©æœç´¢ (Search)
                            // å¦‚æœå½“å‰å†…å®¹åŒ…å« SEARCH PROGRESSï¼Œä¸”å·²ç»æ˜¾ç¤ºäº†ç»“æŸæ ‡è®°ï¼Œåˆ™æ”¶ç¼©
                            if (newRaw.includes('é‡æ–°ç”Ÿæˆæœ€ç»ˆæ–¹æ¡ˆ') || newRaw.includes('Regenerating final plan')) {
                                const hasEndMarker = newRaw.includes('æœç´¢å®Œæˆ') || 
                                                   newRaw.includes('æœç´¢å·²å®Œæˆ') || 
                                                   newRaw.includes('é‡æ–°ç”Ÿæˆæœ€ç»ˆæ–¹æ¡ˆ') ||
                                                   newRaw.includes('Search completed') ||
                                                   newRaw.includes('Search finished') ||
                                                   newRaw.includes('Regenerating final plan');
                                
                                if (hasEndMarker) {
                                    const searchCard = existing.querySelector('.search-progress-card');
                                    if (searchCard) {
                                        const searchContent = searchCard.querySelector('.search-content');
                                        // åªæœ‰å½“æ–°å†…å®¹ä¸æ˜¯æœç´¢æ ‡è®°æœ¬èº«æ—¶ï¼ˆå³å¼€å§‹è¾“å‡ºçœŸæ­£çš„æ–¹æ¡ˆæ—¶ï¼‰ï¼Œæ‰æ”¶ç¼©
                                        // æˆ–è€…å¦‚æœå·²ç»æœ‰äº†ç»“æŸæ ‡è®°ä¸”å½“å‰å¡ç‰‡è¿˜æ˜¯å±•å¼€çŠ¶æ€
                                        if (!searchContent.classList.contains('collapsed')) {
                                            const header = searchCard.querySelector('.cursor-pointer');
                                            if (header) toggleSearchCard(header);
                                        }
                                    }
                                }
                            }

                            contentDiv.dataset.raw = newRaw;
                            
                            let text = contentDiv.dataset.raw;
                            // å®æ—¶æ¸…ç† Markdown æ ‡ç­¾ (é’ˆå¯¹ JSON è¾“å‡º)
                            if (text.includes('```')) {
                                text = text.replace(/^(\s*```json\s*|\s*```\s*)/, '');
                                text = text.replace(/(\s*```\s*)$/, '');
                            }
                            
                            contentDiv.innerHTML = formatContent(text);
                        }
                        return;
                    }
                }

                const div = document.createElement('div');
                if (event.chunk_id) div.id = `event-${event.chunk_id}`;
                
                if (event.type === 'system_start') {
                    // æ•è·å¹¶ä¿å­˜å½“å‰ä¼šè¯ID
                    if (event.session_id) {
                        currentSessionId = event.session_id;
                        console.log('[Editor] Session ID captured:', currentSessionId);
                    }
                    
                    div.className = 'space-y-4 my-6';
                    div.innerHTML = `
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-5 shadow-xl border border-slate-700 text-white">
                            <div class="flex items-center mb-3">
                                <span class="text-xl mr-2">ğŸ¯</span>
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">${t('input_issue_label')}</h4>
                            </div>
                            <p class="text-lg font-medium leading-relaxed">${event.issue || t('msg_history_empty')}</p>
                            <div class="mt-4 pt-4 border-t border-slate-700/50 flex justify-between items-center text-[10px] text-slate-500 uppercase tracking-widest">
                                <span>AI Council Protocol v1.0</span>
                                <span>${new Date().toLocaleTimeString()}</span>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <span class="bg-slate-800 text-white px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-slate-200 border border-slate-700">System Startup</span>
                        </div>
                    `;
                } else if (event.type === 'framework_start') {
                    // Meta-Orchestratoræ¡†æ¶å¯åŠ¨
                    div.className = 'space-y-4 my-6';
                    div.innerHTML = `
                        <div class="bg-gradient-to-br from-purple-700 to-indigo-800 rounded-xl p-5 shadow-xl border border-purple-600 text-white">
                            <div class="flex items-center mb-3">
                                <span class="text-xl mr-2">ğŸ§­</span>
                                <h4 class="text-xs font-bold text-purple-200 uppercase tracking-wider">æ¡†æ¶æ‰§è¡Œ</h4>
                            </div>
                            <p class="text-lg font-medium leading-relaxed">${event.framework_name || 'æœªçŸ¥æ¡†æ¶'}</p>
                            <div class="mt-3 text-sm text-purple-200">
                                <span>æ€»é˜¶æ®µ: ${event.total_stages || '?'}</span>
                            </div>
                        </div>
                    `;
                } else if (event.type === 'stage_start') {
                    // Stageå¼€å§‹
                    const stageId = `stage-${event.stage_index || 'unknown'}`;
                    div.id = stageId;
                    div.className = 'space-y-3 my-4';
                    div.innerHTML = `
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">ğŸ“</span>
                                    <h4 class="text-sm font-bold text-indigo-800">Stage ${event.stage_index || '?'}: ${event.stage_name || 'æœªçŸ¥é˜¶æ®µ'}</h4>
                                </div>
                                <button onclick="toggleStage('${stageId}')" class="text-indigo-600 hover:text-indigo-800 p-1">
                                    <svg class="w-4 h-4 transition-transform" id="${stageId}-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="text-xs text-indigo-600 mb-2">${event.stage_description || ''}</div>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded">è§’è‰²: ${(event.roles || []).join(', ')}</span>
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded">è½®æ¬¡: ${event.rounds || 1}</span>
                            </div>
                            <div id="${stageId}-content" class="mt-3 space-y-2">
                                <!-- Stageå†…å®¹å°†æ·»åŠ åˆ°è¿™é‡Œ -->
                            </div>
                        </div>
                    `;
                } else if (event.type === 'stage_complete') {
                    // Stageå®Œæˆ
                    const stageId = `stage-${event.stage_index || 'unknown'}`;
                    const stageEl = document.getElementById(stageId);
                    if (stageEl) {
                        const summary = stageEl.querySelector('.text-xs.text-indigo-600');
                        if (summary) {
                            summary.innerHTML = `âœ… ${event.output_summary || 'å®Œæˆ'}`;
                            summary.classList.remove('text-indigo-600');
                            summary.classList.add('text-green-600', 'font-semibold');
                        }
                    }
                    return; // ä¸æ·»åŠ æ–°å…ƒç´ 
                } else if (event.type === 'framework_complete') {
                    // æ¡†æ¶å®Œæˆ
                    div.className = 'flex justify-center my-6';
                    div.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">âœ…</span>
                                <span class="text-sm font-bold text-green-700">æ¡†æ¶æ‰§è¡Œå®Œæˆ</span>
                            </div>
                            <div class="text-xs text-green-600 mt-1">${event.message || ''}</div>
                        </div>
                    `;
                } else if (event.type === 'round_start') {
                    div.className = 'flex justify-center my-4';
                    div.innerHTML = `<span class="bg-slate-200 text-slate-600 px-3 py-0.5 rounded-full text-xs font-bold uppercase">Round ${event.round}</span>`;
                } else if (event.type === 'user_intervention') {
                    div.className = 'flex justify-end my-4';
                    div.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 max-w-[80%] shadow-sm">
                            <div class="flex items-center mb-1">
                                <span class="text-sm mr-1">ğŸ‘¤</span>
                                <h4 class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">${t('btn_send_intervention')}</h4>
                            </div>
                            <p class="text-sm text-blue-800 leading-relaxed">${event.content}</p>
                            <div class="text-[9px] text-blue-400 mt-1 text-right">${event.timestamp || ''}</div>
                        </div>
                    `;
                } else if (event.type === 'final_report') {
                    // è¿›å…¥æŠ¥å‘Šç”Ÿæˆé˜¶æ®µï¼Œæ›´æ–°çŠ¶æ€æ–‡å­—
                    isReportingPhase = true;
                    // åªæœ‰åœ¨è¿˜æ²¡æœ‰æ˜¾ç¤ºâ€œæ­£åœ¨æ’°å†™â€æ—¶æ‰æ›´æ–°æ–‡å­—ï¼Œé¿å…æµå¼è¾“å‡ºæ—¶æ–‡å­—é—ªçƒ
                    const loaderText = document.getElementById('loader-text');
                    if (loaderText && !loaderText.innerText.includes('æ’°å†™') && !loaderText.innerText.includes('Writing')) {
                        toggleReportLoading(true, t('msg_consensus_reached'), t('msg_consensus_reached_sub'));
                    }
                    setLayoutMode('report');
                    return; // æŠ¥å‘Šå†…å®¹ç”± handleFinalReport å¤„ç†
                } else if (event.type === 'agent_action') {
                    const roleClass = `role-${event.role_type.toLowerCase()}`;
                    const roleIcon = getIcon(event.role_type);
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨Stageå†…éƒ¨
                    if (event.stage_index !== undefined) {
                        const stageId = `stage-${event.stage_index}`;
                        const stageContent = document.getElementById(`${stageId}-content`);
                        if (stageContent) {
                            // åœ¨Stageå†…æ˜¾ç¤ºAgentè¾“å‡ºï¼ˆç®€åŒ–ç‰ˆï¼‰
                            const agentDiv = document.createElement('div');
                            if (event.chunk_id) {
                                agentDiv.id = `event-${event.chunk_id}`;
                                const existing = document.getElementById(`event-${event.chunk_id}`);
                                if (existing) {
                                    // æµå¼æ›´æ–°å†…å®¹
                                    const contentEl = existing.querySelector('.event-content');
                                    if (contentEl) {
                                        const rawContent = contentEl.getAttribute('data-raw') || '';
                                        const newContent = rawContent + (event.content || '');
                                        contentEl.setAttribute('data-raw', newContent);
                                        contentEl.innerHTML = formatContent(newContent);
                                    }
                                    return;
                                }
                            }
                            agentDiv.className = `bg-white rounded-lg shadow-sm p-3 border-l-4 ${roleClass}`;
                            agentDiv.innerHTML = `
                                <div class="flex items-center mb-1">
                                    <span class="text-sm mr-1">${roleIcon}</span>
                                    <span class="text-xs font-bold text-slate-700">${event.agent_name || 'æœªçŸ¥Agent'}</span>
                                </div>
                                <div class="text-sm text-slate-600 event-content" data-raw="${event.content || ''}">
                                    ${formatContent(event.content || '')}
                                </div>
                            `;
                            stageContent.appendChild(agentDiv);
                            return;
                        }
                    }
                    
                    // å¦‚æœæ˜¯è®°å½•å‘˜ï¼ˆReporterï¼‰å¼€å§‹è¡ŒåŠ¨ï¼Œæ›´æ–°æŠ¥å‘Šçª—å£çš„åŠ è½½æ–‡å­—
                    if (event.role_type === 'Reporter') {
                        isReportingPhase = true;
                        toggleReportLoading(true, t('msg_writing_report'), t('msg_writing_report_sub'));
                        setLayoutMode('report');
                    }

                    const hasReasoning = !!event.reasoning;
                    const reasoningContent = (event.reasoning || '').replace(/^\s+/, '');
                    const content = event.content || '';

                    div.className = `bg-white rounded-lg shadow-sm p-4 border-l-4 ${roleClass} text-base discussion-card`;
                    div.innerHTML = `
                        <div class="flex items-center mb-2">
                            <span class="text-xl mr-2">${roleIcon}</span>
                            <div>
                                <h4 class="font-bold text-slate-800 text-base">${event.agent_name}</h4>
                            </div>
                        </div>
                        <div class="reasoning-wrapper mb-2 ${hasReasoning ? '' : 'hidden'}">
                            <div class="flex items-center justify-between px-2 py-1 bg-amber-100/50 rounded-t-lg border-l-2 border-amber-200 cursor-pointer hover:bg-amber-200/50 transition-colors" onclick="toggleReasoning(this)">
                                <span class="text-[10px] text-amber-700 font-bold uppercase tracking-wider flex items-center">
                                    <span class="toggle-icon mr-1">â–¼</span> ${t('msg_thinking_process')}
                                </span>
                            </div>
                            <div class="event-reasoning p-3 bg-amber-50/40 border-l-2 border-amber-200 text-[13px] leading-relaxed text-slate-600 italic whitespace-pre-wrap relative rounded-b-lg">
                                ${reasoningContent}
                            </div>
                        </div>
                        <div class="text-slate-600 leading-relaxed text-base event-content markdown-body">${formatContent(content, event.role_type)}</div>
                    `;
                }
                
                flowContainer.appendChild(div);
            }

            function toggleReasoning(header) {
                const wrapper = header.closest('.reasoning-wrapper');
                const content = wrapper.querySelector('.event-reasoning');
                const icon = header.querySelector('.toggle-icon');
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }

            function toggleSearchCard(header) {
                const card = header.closest('.search-progress-card');
                const content = card.querySelector('.search-content');
                const icon = header.querySelector('.toggle-icon');
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }

            function toggleStage(stageId) {
                const stage = document.getElementById(stageId);
                if (!stage) return;
                const content = stage.querySelector(`#${stageId}-content`);
                const icon = document.getElementById(`${stageId}-icon`);
                if (!content || !icon) return;
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('hidden');
                    icon.style.transform = 'rotate(-90deg)';
                }
            }

            function getIcon(role) {
                const icons = {
                    'Leader': 'ğŸ‘¨â€âš–ï¸',
                    'Planner': 'ğŸ’¡',
                    'Auditor': 'ğŸ”',
                    'Reporter': 'ğŸ“',
                    'devils_advocate': 'âš ï¸',
                    'reference_refiner': 'ğŸ“š'
                };
                return icons[role] || 'ğŸ‘¤';
            }

            function formatContent(content, roleType) {
                if (!content) return '';
                
                let text = content.trim();
                let prefix = '';
                let jsonData = null;

                // 1. å¯»æ‰¾ JSON çš„èµ·å§‹ä½ç½®
                // é€»è¾‘ï¼šä¼˜å…ˆå¯»æ‰¾ { (JSONå¯¹è±¡)ï¼Œæˆ–è€…å¯»æ‰¾ä¸å¸¦ SEARCH å…³é”®å­—çš„ [ (JSONæ•°ç»„)
                let jsonStartIndex = -1;
                
                // å¯»æ‰¾æœ€åä¸€ä¸ªæœç´¢ç›¸å…³çš„æ ‡è®°ï¼ŒJSON é€šå¸¸åœ¨è¿™äº›æ ‡è®°ä¹‹å
                const searchMarkers = ["é‡æ–°ç”Ÿæˆ", "æœç´¢å®Œæˆ", "æœç´¢å·²å®Œæˆ", "ç³»ç»Ÿæ­£åœ¨æœç´¢", "SEARCH PROGRESS", "Regenerating", "Search completed", "Search finished", "System searching"];
                let lastMarkerIndex = -1;
                searchMarkers.forEach(marker => {
                    const idx = text.lastIndexOf(marker);
                    if (idx !== -1 && idx + marker.length > lastMarkerIndex) {
                        lastMarkerIndex = idx + marker.length;
                    }
                });

                if (lastMarkerIndex !== -1) {
                    // åœ¨æœç´¢æ ‡è®°ä¹‹åå¯»æ‰¾ JSON
                    const afterMarker = text.substring(lastMarkerIndex);
                    const match = afterMarker.match(/\{|\[(?!\s*SEARCH)/);
                    if (match) {
                        jsonStartIndex = lastMarkerIndex + match.index;
                    }
                } else {
                    // æ²¡æœ‰æœç´¢æ ‡è®°ï¼Œç›´æ¥å¯»æ‰¾èµ·å§‹ç¬¦å·ï¼Œæ’é™¤ [SEARCH:
                    const match = text.match(/\{|\[(?!\s*SEARCH)/);
                    if (match) {
                        jsonStartIndex = match.index;
                    }
                }

                // 2. æå–å‰ç¼€å’Œå°è¯•è§£æ JSON
                if (jsonStartIndex !== -1) {
                    prefix = text.substring(0, jsonStartIndex).trim();
                    let potentialJson = text.substring(jsonStartIndex).trim();
                    
                    // æ¸…ç†æœ«å°¾çš„ Markdown é—­åˆæ ‡ç­¾
                    potentialJson = potentialJson.replace(/(\s*```\s*)$/, '');
                    
                    try {
                        jsonData = JSON.parse(potentialJson);
                    } catch (e) {
                        // æµå¼è¾“å‡ºä¸­ JSON å¯èƒ½ä¸å®Œæ•´ï¼Œè§£æå¤±è´¥æ˜¯æ­£å¸¸çš„
                    }
                } else if (text.includes('SEARCH PROGRESS')) {
                    // å¦‚æœæ²¡æœ‰ JSON ä½†æœ‰ SEARCH PROGRESSï¼Œæ•´ä¸ªå†…å®¹éƒ½è§†ä¸ºå‰ç¼€ï¼Œä»¥ä¾¿è§¦å‘å¡ç‰‡æ¸²æŸ“
                    prefix = text;
                }

                let html = '';
                if (prefix) {
                    // æ¸…ç† prefixï¼šç§»é™¤ [SEARCH: ...] æ ‡ç­¾ã€é‡å¤çš„ SEARCH PROGRESS æ ‡é¢˜ä»¥åŠæœ«å°¾çš„ Markdown ä»£ç å—èµ·å§‹æ ‡ç­¾
                    let cleanPrefix = prefix.replace(/\[SEARCH:.*?\]/g, '')
                                            .replace(/```(json)?\s*$/, '')
                                            .trim();
                    
                    // åªæœ‰å½“æ¸…ç†åçš„ prefix ä¸ä¸ºç©ºï¼Œæˆ–è€…åŒ…å«æœç´¢è¿›åº¦æ—¶æ‰æ¸²æŸ“
                    if (cleanPrefix || prefix.includes('SEARCH PROGRESS')) {
                        let prefixHtml = marked.parse(cleanPrefix);
                        // æ£€æŸ¥æ˜¯å¦åŒ…å« SEARCH PROGRESSï¼Œå¦‚æœæ˜¯åˆ™åŒ…è£…æˆå¯æŠ˜å å¡ç‰‡
                        if (prefix.includes('SEARCH PROGRESS')) {
                            // ç§»é™¤æ‰€æœ‰ç”Ÿæˆçš„ <h3>SEARCH PROGRESS</h3> æ ‡ç­¾
                            prefixHtml = prefixHtml.replace(/<h3[^>]*>SEARCH PROGRESS<\/h3>/gi, '');
                            
                            // æ£€æŸ¥æœç´¢æ˜¯å¦å·²å®Œæˆ
                            const hasEndMarker = text.includes('æœç´¢å®Œæˆ') || 
                                               text.includes('æœç´¢å·²å®Œæˆ') || 
                                               text.includes('é‡æ–°ç”Ÿæˆæœ€ç»ˆæ–¹æ¡ˆ') ||
                                               text.includes('Search completed') ||
                                               text.includes('Search finished') ||
                                               text.includes('Regenerating final plan');
                            
                            const collapsedClass = hasEndMarker ? 'collapsed' : '';
                            const iconChar = hasEndMarker ? 'â–¶' : 'â–¼';

                            html += `
                                <div class="search-progress-card mb-2">
                                    <div class="search-header" onclick="toggleSearchCard(this)">
                                        <h5>
                                            <span class="toggle-icon mr-1">${iconChar}</span>
                                            <span class="mr-1">ğŸŒ</span> ${t('msg_search_progress')}
                                        </h5>
                                        <span class="text-[10px] text-blue-400 uppercase font-bold tracking-widest">${t('msg_details')}</span>
                                    </div>
                                    <div class="search-content markdown-body ${collapsedClass}">
                                        ${prefixHtml}
                                    </div>
                                </div>
                            `;
                        } else {
                            html += `<div class="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 italic shadow-sm">${prefixHtml}</div>`;
                        }
                    }
                }

                if (jsonData) {
                    html += renderStructuredData(jsonData);
                } else {
                    // å¦‚æœæ²¡æœ‰è§£æå‡º JSONï¼Œæ¸²æŸ“å‰©ä½™éƒ¨åˆ†
                    const remainingText = jsonStartIndex !== -1 ? text.substring(jsonStartIndex) : text;
                    
                    if (jsonStartIndex !== -1) {
                        // å¦‚æœçœ‹èµ·æ¥åƒ JSON ä½†è§£æå¤±è´¥ï¼ˆå¯èƒ½æ˜¯æµå¼è¾“å‡ºæœªå®Œæˆï¼‰ï¼Œä½¿ç”¨ pre æ ‡ç­¾åŒ…è£¹ä»¥ä¿æŒæ ¼å¼ï¼Œé¿å… marked è¯¯ä¼¤ï¼ˆå¦‚å°†ä¸‹åˆ’çº¿è§£æä¸ºæ–œä½“ï¼‰
                        // ç§»é™¤æœ«å°¾çš„ Markdown ä»£ç å—èµ·å§‹/ç»“æŸæ ‡è®°
                        let rawJson = remainingText.replace(/^```(json)?\s*/, '').replace(/```\s*$/, '');
                        html += `<pre class="whitespace-pre-wrap font-mono text-sm bg-slate-50 p-3 rounded-lg border border-slate-200 text-slate-600">${escapeHtml(rawJson)}</pre>`;
                    } else if (!text.includes('SEARCH PROGRESS')) {
                        html += marked.parse(remainingText);
                    }
                }

                return html;
            }

            function renderStructuredData(data) {
                let html = '<div class="space-y-4 mt-2">';

                try {
                // 1. ç›‘å¯Ÿå®˜è¯„è®º (Auditor Review)
                if (data.reviews && Array.isArray(data.reviews)) {
                    data.reviews.forEach(review => {
                        const ratingClass = {
                            'ä¼˜ç§€': 'bg-green-100 text-green-700',
                            'åˆæ ¼': 'bg-blue-100 text-blue-700',
                            'éœ€é‡æ„': 'bg-amber-100 text-amber-700',
                            'ä¸å¯è¡Œ': 'bg-red-100 text-red-700',
                            'Excellent': 'bg-green-100 text-green-700',
                            'Pass': 'bg-blue-100 text-blue-700',
                            'Needs Refactor': 'bg-amber-100 text-amber-700',
                            'Infeasible': 'bg-red-100 text-red-700'
                        }[review.rating] || 'bg-slate-100 text-slate-700';

                        html += `
                            <div class="border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm">
                                <div class="bg-slate-50 px-3 py-2 border-b border-slate-200 flex justify-between items-center">
                                    <span class="font-bold text-slate-700 text-sm">ğŸ¯ ${t('msg_target')}: ${review.plan_id || t('msg_unknown_plan')}</span>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${ratingClass}">${review.rating || t('msg_unrated')}</span>
                                </div>
                                <div class="p-3 space-y-3">
                                    <div>
                                        <div class="text-[11px] font-bold text-red-500 uppercase mb-1">${t('msg_issues')}</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600 space-y-1">
                                            ${(review.issues || []).map(i => `<li>${i}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <div class="text-[11px] font-bold text-green-600 uppercase mb-1">${t('msg_suggestions')}</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600 space-y-1">
                                            ${(review.suggestions || []).map(s => `<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (data.summary) {
                        html += `
                            <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <div class="text-[11px] font-bold text-indigo-600 uppercase mb-1">${t('msg_audit_summary')}</div>
                                <div class="text-sm text-slate-700 leading-relaxed">${data.summary}</div>
                            </div>
                        `;
                    }
                }
                // 2. è®®é•¿æ‹†è§£ (Leader Decomposition)
                else if (data.decomposition) {
                    const d = data.decomposition;
                    html += `
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4">
                            <div>
                                <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">${t('msg_core_goal')}</div>
                                <div class="text-base font-bold text-slate-800">${d.core_goal || t('msg_undefined')}</div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">${t('msg_key_questions')}</div>
                                    <ul class="list-decimal ml-4 text-sm text-slate-700 space-y-1">
                                        ${(d.key_questions || []).map(q => `<li>${q}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">${t('msg_boundaries')}</div>
                                    <div class="text-sm text-slate-700">${d.boundaries || t('msg_none')}</div>
                                </div>
                            </div>
                            ${d.report_design ? `
                                <div>
                                    <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">${t('msg_report_outline')}</div>
                                    <div class="grid grid-cols-1 gap-2 mt-2">
                                        ${Object.entries(d.report_design).map(([name, desc]) => `
                                            <div class="bg-white/60 p-2 rounded border border-blue-200/50">
                                                <span class="font-bold text-slate-800 text-sm">${name}:</span>
                                                <span class="text-sm text-slate-600">${desc}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    if (data.instructions) {
                        html += `
                            <div class="bg-amber-50 p-3 rounded-lg border border-amber-100">
                                <div class="text-[11px] font-bold text-amber-600 uppercase mb-1">${t('msg_instructions')}</div>
                                <div class="text-sm text-slate-700 font-medium">${data.instructions}</div>
                            </div>
                        `;
                    }
                }
                // 3. ç­–è®ºå®¶æ–¹æ¡ˆ (Planner Plan)
                else if (data.core_idea || data.steps) {
                    html += `
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 space-y-4">
                            <div>
                                <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">${t('msg_core_idea')}</div>
                                <div class="text-base font-bold text-slate-800">${data.core_idea || t('msg_undefined')}</div>
                            </div>
                            <div>
                                <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">${t('msg_execution_steps')}</div>
                                <div class="space-y-2 mt-2">
                                    ${(data.steps || []).map((step, i) => `
                                        <div class="flex items-start">
                                            <span class="bg-emerald-200 text-emerald-700 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold mr-2 mt-0.5 flex-shrink-0">${i+1}</span>
                                            <span class="text-sm text-slate-700">${step}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ${data.feasibility ? `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2 border-t border-emerald-200/50">
                                    <div>
                                        <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">${t('msg_advantages')}</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600">
                                            ${(data.feasibility.advantages || []).map(a => `<li>${a}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">${t('msg_resource_requirements')}</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600">
                                            ${(data.feasibility.requirements || []).map(r => `<li>${r}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            ` : ''}
                            ${data.limitations && data.limitations.length > 0 ? `
                                <div class="pt-2 border-t border-emerald-200/50">
                                    <div class="text-[11px] font-bold text-amber-600 uppercase mb-1">âš ï¸ ${t('msg_limitations') || 'å±€é™æ€§'}</div>
                                    <ul class="list-disc ml-4 text-sm text-slate-600 space-y-1">
                                        ${data.limitations.map(l => `<li>${l}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                // 4. Devil's Advocate è´¨ç–‘å®˜è¾“å‡º
                else if (data.stage && (data.decomposition_challenge || data.summary_challenge)) {
                    const stageText = data.stage === 'decomposition' ? 'é—®é¢˜æ‹†è§£éªŒè¯' : 'æ€»ç»“éªŒè¯';
                    const stageIcon = data.stage === 'decomposition' ? 'ğŸ¯' : 'ğŸ“‹';
                    
                    // ç¡®å®šä¸¥é‡ç¨‹åº¦ç­‰çº§
                    const hasCritical = data.critical_issues && data.critical_issues.length > 0;
                    const severityClass = hasCritical ? 'border-red-300 bg-red-50' : 'border-amber-200 bg-amber-50';
                    const headerClass = hasCritical ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700';
                    
                    html += `
                        <div class="${severityClass} p-4 rounded-xl border-2 space-y-4 shadow-lg">
                            <!-- æ ‡é¢˜æ  -->
                            <div class="${headerClass} -m-4 mb-3 p-3 rounded-t-xl border-b-2 ${hasCritical ? 'border-red-300' : 'border-amber-300'}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">${stageIcon}</span>
                                        <span class="font-bold text-sm uppercase tracking-wide">${stageText}</span>
                                        ${data.round !== undefined ? `<span class="text-xs opacity-75">Round ${data.round}</span>` : ''}
                                    </div>
                                    ${hasCritical ? `<span class="px-2 py-1 bg-red-200 text-red-800 rounded-full text-[10px] font-bold uppercase">âš ï¸ Critical</span>` : ''}
                                </div>
                            </div>
                            
                            <!-- æ•´ä½“è¯„ä»· -->
                            ${data.overall_assessment ? `
                                <div class="bg-white/60 p-3 rounded-lg border ${hasCritical ? 'border-red-200' : 'border-amber-200'}">
                                    <div class="text-[11px] font-bold ${hasCritical ? 'text-red-600' : 'text-amber-600'} uppercase mb-2 flex items-center">
                                        <span class="mr-1">ğŸ’­</span> æ•´ä½“è¯„ä»·
                                    </div>
                                    <div class="text-sm text-slate-700 leading-relaxed">${data.overall_assessment}</div>
                                </div>
                            ` : ''}
                            
                            <!-- é—®é¢˜æ‹†è§£è´¨ç–‘ -->
                            ${data.decomposition_challenge ? `
                                <div class="space-y-3">
                                    ${data.decomposition_challenge.missing_dimensions && data.decomposition_challenge.missing_dimensions.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-purple-200">
                                            <div class="text-[11px] font-bold text-purple-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">ğŸ”</span> é—æ¼ç»´åº¦
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.decomposition_challenge.missing_dimensions.map(d => `<li>${d}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.decomposition_challenge.hidden_assumptions && data.decomposition_challenge.hidden_assumptions.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-indigo-200">
                                            <div class="text-[11px] font-bold text-indigo-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">ğŸ’¡</span> éšå«å‡è®¾
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.decomposition_challenge.hidden_assumptions.map(a => `<li>${a}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.decomposition_challenge.alternative_frameworks && data.decomposition_challenge.alternative_frameworks.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-blue-200">
                                            <div class="text-[11px] font-bold text-blue-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">ğŸ”„</span> æ›¿ä»£æ¡†æ¶
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.decomposition_challenge.alternative_frameworks.map(f => `<li>${f}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.decomposition_challenge.extreme_scenario_issues && data.decomposition_challenge.extreme_scenario_issues.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-rose-200">
                                            <div class="text-[11px] font-bold text-rose-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">âš¡</span> æç«¯åœºæ™¯é—®é¢˜
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.decomposition_challenge.extreme_scenario_issues.map(i => `<li>${i}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <!-- æ€»ç»“è´¨ç–‘ -->
                            ${data.summary_challenge ? `
                                <div class="space-y-3">
                                    ${data.summary_challenge.logical_gaps && data.summary_challenge.logical_gaps.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-red-200">
                                            <div class="text-[11px] font-bold text-red-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">ğŸ”—</span> é€»è¾‘ç¼ºå£
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.summary_challenge.logical_gaps.map(g => `<li>${g}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.summary_challenge.missing_points && data.summary_challenge.missing_points.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-orange-200">
                                            <div class="text-[11px] font-bold text-orange-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">ğŸ“Œ</span> é—æ¼è¦ç‚¹
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.summary_challenge.missing_points.map(p => `<li>${p}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.summary_challenge.inconsistencies && data.summary_challenge.inconsistencies.length > 0 ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-pink-200">
                                            <div class="text-[11px] font-bold text-pink-600 uppercase mb-2 flex items-center">
                                                <span class="mr-1">âš¡</span> çŸ›ç›¾ä¹‹å¤„
                                            </div>
                                            <ul class="list-disc ml-4 text-sm text-slate-700 space-y-1">
                                                ${data.summary_challenge.inconsistencies.map(i => `<li>${i}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${data.summary_challenge.optimism_bias ? `
                                        <div class="bg-white/80 p-3 rounded-lg border border-yellow-200">
                                            <div class="text-[11px] font-bold text-yellow-700 uppercase mb-2 flex items-center">
                                                <span class="mr-1">âš–ï¸</span> åè§è¯†åˆ«
                                            </div>
                                            <div class="text-sm text-slate-700">${data.summary_challenge.optimism_bias}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <!-- ä¸¥é‡é—®é¢˜ -->
                            ${data.critical_issues && data.critical_issues.length > 0 ? `
                                <div class="bg-red-100 p-3 rounded-lg border-2 border-red-300">
                                    <div class="text-[11px] font-bold text-red-700 uppercase mb-2 flex items-center">
                                        <span class="mr-1">ğŸš¨</span> ä¸¥é‡é—®é¢˜
                                    </div>
                                    <ul class="list-disc ml-4 text-sm text-red-800 space-y-1 font-medium">
                                        ${data.critical_issues.map(i => `<li>${i}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <!-- æ”¹è¿›å»ºè®® -->
                            ${data.recommendations && data.recommendations.length > 0 ? `
                                <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                    <div class="text-[11px] font-bold text-green-700 uppercase mb-2 flex items-center">
                                        <span class="mr-1">âœ…</span> æ”¹è¿›å»ºè®®
                                    </div>
                                    <ul class="list-decimal ml-4 text-sm text-green-800 space-y-1">
                                        ${data.recommendations.map(r => `<li>${r}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                // 5. é€šç”¨ JSON å±•ç¤º (æ™ºèƒ½æ ‘å½¢ç»„ä»¶)
                else {
                    html += renderGenericJsonTree(data);
                }
                
                } catch (e) {
                    // å·²çŸ¥è§’è‰²æ¸²æŸ“å¤±è´¥æ—¶ï¼Œé€€å›ä½¿ç”¨é€šç”¨JSONæ ‘å½¢ç»„ä»¶
                    console.warn('[renderStructuredData] æ¸²æŸ“å¤±è´¥ï¼Œä½¿ç”¨é€šç”¨ç»„ä»¶:', e);
                    html = '<div class="space-y-4 mt-2">';
                    html += renderGenericJsonTree(data);
                }

                html += '</div>';
                return html;
            }
            
            // ==================== æ™ºèƒ½æ··åˆæ¸²æŸ“ç»„ä»¶ ====================
            // æ™ºèƒ½é«˜äº®å…³é”®å­—æ˜ å°„
            const SMART_HIGHLIGHT_KEYWORDS = {
                error: ['issues', 'problems', 'errors', 'error', 'bugs', 'failures', 'failed', 'critical', 'warnings', 'risks', 'concerns', 'weaknesses', 'limitations', 'gaps', 'missing', 'é—®é¢˜', 'é”™è¯¯', 'é£é™©', 'ç¼ºé™·', 'ä¸è¶³', 'éšæ‚£', 'æ¼æ´', 'è´¨ç–‘', 'æŒ‘æˆ˜'],
                success: ['suggestions', 'recommendations', 'solutions', 'improvements', 'advantages', 'benefits', 'strengths', 'success', 'achieved', 'å»ºè®®', 'ä¼˜åŠ¿', 'æ–¹æ¡ˆ', 'æ”¹è¿›', 'è§£å†³', 'ä¼˜ç‚¹', 'æˆåŠŸ', 'é€‰æ‹©', 'æ¨è'],
                rating: ['rating', 'score', 'level', 'grade', 'priority', 'status', 'evaluation', 'assessment', 'è¯„åˆ†', 'ç­‰çº§', 'è¯„çº§', 'ä¼˜å…ˆçº§', 'çŠ¶æ€', 'ç±»å‹', 'type']
            };
            
            // è¯„çº§å€¼åˆ°Badgeé¢œè‰²æ˜ å°„
            const SMART_BADGE_COLORS = {
                // ä¸­æ–‡
                'ä¼˜ç§€': 'green', 'è‰¯å¥½': 'blue', 'åˆæ ¼': 'blue', 'ä¸€èˆ¬': 'yellow', 'è¾ƒå·®': 'red', 'ä¸åˆæ ¼': 'red', 'ä¸å¯è¡Œ': 'red', 'éœ€é‡æ„': 'yellow',
                'é«˜': 'red', 'ä¸­': 'yellow', 'ä½': 'green',
                'ç´§æ€¥': 'red', 'é‡è¦': 'yellow', 'æ™®é€š': 'blue',
                'æˆåŠŸ': 'green', 'å¤±è´¥': 'red', 'è¿›è¡Œä¸­': 'blue', 'å¾…å¤„ç†': 'yellow',
                'å†³ç­–ç±»': 'purple', 'åˆ†æç±»': 'blue', 'åˆ›æ„ç±»': 'green', 'è§„åˆ’ç±»': 'yellow',
                // è‹±æ–‡
                'excellent': 'green', 'good': 'blue', 'pass': 'blue', 'fair': 'yellow', 'poor': 'red', 'fail': 'red', 'infeasible': 'red',
                'high': 'red', 'medium': 'yellow', 'low': 'green',
                'critical': 'red', 'important': 'yellow', 'normal': 'blue',
                'success': 'green', 'failed': 'red', 'pending': 'yellow', 'in_progress': 'blue',
                'decision': 'purple', 'analysis': 'blue', 'creative': 'green', 'planning': 'yellow'
            };
            
            // å­—æ®µåç§°ç¾åŒ–æ˜ å°„
            const FIELD_DISPLAY_NAMES = {
                // é€šç”¨
                'analysis': 'ğŸ“Š éœ€æ±‚åˆ†æ', 'role_planning': 'ğŸ‘¥ è§’è‰²è§„åˆ’', 'framework_selection': 'ğŸ—ï¸ æ¡†æ¶é€‰æ‹©',
                'execution_config': 'âš™ï¸ æ‰§è¡Œé…ç½®', 'summary': 'ğŸ“‹ è§„åˆ’æ‘˜è¦',
                'problem_type': 'é—®é¢˜ç±»å‹', 'core_requirement': 'æ ¸å¿ƒéœ€æ±‚', 'complexity': 'å¤æ‚åº¦',
                'key_points': 'å…³é”®è¦ç‚¹', 'constraints': 'çº¦æŸæ¡ä»¶',
                'recommended_roles': 'æ¨èè§’è‰²', 'custom_roles_needed': 'éœ€è¦è‡ªå®šä¹‰è§’è‰²',
                'custom_role_descriptions': 'è‡ªå®šä¹‰è§’è‰²æè¿°',
                'selected_framework': 'é€‰å®šæ¡†æ¶', 'framework_reason': 'é€‰æ‹©åŸå› ', 'stage_customization': 'é˜¶æ®µå®šåˆ¶',
                'total_rounds': 'æ€»è½®æ•°', 'agents_per_role': 'æ¯è§’è‰²Agentæ•°',
                'key_decisions': 'å…³é”®å†³ç­–', 'expected_outcomes': 'é¢„æœŸæˆæœ', 'risk_factors': 'é£é™©å› ç´ ',
                'name': 'åç§°', 'description': 'æè¿°', 'type': 'ç±»å‹', 'source': 'æ¥æº',
                'stages': 'é˜¶æ®µ', 'roles': 'è§’è‰²', 'rounds': 'è½®æ•°',
                'core_idea': 'æ ¸å¿ƒæ€è·¯', 'steps': 'æ‰§è¡Œæ­¥éª¤', 'feasibility': 'å¯è¡Œæ€§åˆ†æ',
                'advantages': 'ä¼˜åŠ¿', 'requirements': 'èµ„æºéœ€æ±‚',
                'reviews': 'å®¡æŸ¥æ„è§', 'issues': 'å‘ç°é—®é¢˜', 'suggestions': 'æ”¹è¿›å»ºè®®',
                'rating': 'è¯„çº§', 'plan_id': 'æ–¹æ¡ˆID',
                'decomposition': 'é—®é¢˜æ‹†è§£', 'core_goal': 'æ ¸å¿ƒç›®æ ‡', 'key_questions': 'å…³é”®é—®é¢˜',
                'boundaries': 'è¾¹ç•Œæ¡ä»¶', 'report_design': 'æŠ¥å‘Šè®¾è®¡', 'instructions': 'æ‰§è¡ŒæŒ‡ä»¤'
            };
            
            function getSmartHighlightType(key) {
                if (!key) return null;
                const lowerKey = key.toLowerCase();
                for (const [type, keywords] of Object.entries(SMART_HIGHLIGHT_KEYWORDS)) {
                    if (keywords.some(kw => lowerKey.includes(kw))) {
                        return type;
                    }
                }
                return null;
            }
            
            function getSmartBadgeColor(value) {
                if (typeof value !== 'string') return null;
                const lowerValue = value.toLowerCase();
                for (const [val, color] of Object.entries(SMART_BADGE_COLORS)) {
                    if (lowerValue === val.toLowerCase() || lowerValue.includes(val.toLowerCase())) {
                        return color;
                    }
                }
                return 'gray';
            }
            
            function getFieldDisplayName(key) {
                return FIELD_DISPLAY_NAMES[key] || key;
            }
            
            function getFieldIcon(key) {
                const icons = {
                    'analysis': 'ğŸ“Š', 'role_planning': 'ğŸ‘¥', 'framework_selection': 'ğŸ—ï¸',
                    'execution_config': 'âš™ï¸', 'summary': 'ğŸ“‹', 'stages': 'ğŸ“‘', 'roles': 'ğŸ‘¤',
                    'key_points': 'ğŸ¯', 'constraints': 'ğŸ”’', 'risk_factors': 'âš ï¸',
                    'advantages': 'âœ…', 'issues': 'âŒ', 'suggestions': 'ğŸ’¡',
                    'steps': 'ğŸ“', 'core_idea': 'ğŸ’¡', 'decomposition': 'ğŸ”'
                };
                return icons[key] || 'ğŸ“„';
            }
            
            // æ£€æµ‹æ˜¯å¦ä¸ºåŒæ„å¯¹è±¡æ•°ç»„ï¼ˆå¯ç”Ÿæˆè¡¨æ ¼ï¼‰
            function isHomogeneousObjectArray(arr) {
                if (!Array.isArray(arr) || arr.length === 0) return false;
                if (arr.length === 1) return typeof arr[0] === 'object' && arr[0] !== null && !Array.isArray(arr[0]);
                
                const firstKeys = typeof arr[0] === 'object' && arr[0] !== null ? Object.keys(arr[0]).sort().join(',') : null;
                if (!firstKeys) return false;
                
                return arr.every(item => {
                    if (typeof item !== 'object' || item === null || Array.isArray(item)) return false;
                    return Object.keys(item).sort().join(',') === firstKeys;
                });
            }
            
            // æ£€æµ‹æ˜¯å¦ä¸ºç®€å•å€¼æ•°ç»„
            function isSimpleArray(arr) {
                if (!Array.isArray(arr)) return false;
                return arr.every(item => typeof item !== 'object' || item === null);
            }
            
            // æ£€æµ‹æ˜¯å¦ä¸ºæ‰å¹³å¯¹è±¡ï¼ˆæ‰€æœ‰å€¼éƒ½æ˜¯åŸå§‹ç±»å‹ï¼‰
            function isFlatObject(obj) {
                if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) return false;
                return Object.values(obj).every(v => typeof v !== 'object' || v === null);
            }
            
            // ä¸»æ¸²æŸ“å‡½æ•°
            function renderGenericJsonTree(data, title = null) {
                return `
                    <div class="smart-render-container">
                        ${title ? `
                            <div class="smart-render-header">
                                <span class="smart-render-header-icon">ğŸ“‹</span>
                                <span class="smart-render-header-title">${escapeHtml(title)}</span>
                            </div>
                        ` : ''}
                        ${renderSmartValue(data, null, 0)}
                    </div>
                `;
            }
            
            // æ™ºèƒ½å€¼æ¸²æŸ“
            function renderSmartValue(data, key, depth) {
                // null / undefined
                if (data === null || data === undefined) {
                    return `<span class="text-slate-400 italic">${data === null ? 'ç©º' : 'æœªå®šä¹‰'}</span>`;
                }
                
                // åŸå§‹ç±»å‹
                if (typeof data !== 'object') {
                    return renderPrimitiveValue(data, key);
                }
                
                // æ•°ç»„
                if (Array.isArray(data)) {
                    if (data.length === 0) {
                        return `<span class="text-slate-400 italic">ï¼ˆç©ºåˆ—è¡¨ï¼‰</span>`;
                    }
                    
                    // åŒæ„å¯¹è±¡æ•°ç»„ â†’ è¡¨æ ¼
                    if (isHomogeneousObjectArray(data)) {
                        return renderTable(data);
                    }
                    
                    // ç®€å•å€¼æ•°ç»„ â†’ åˆ—è¡¨
                    if (isSimpleArray(data)) {
                        return renderSimpleList(data, key);
                    }
                    
                    // å¤æ‚æ•°ç»„ â†’ å¡ç‰‡åˆ—è¡¨
                    return renderComplexArray(data, key, depth);
                }
                
                // å¯¹è±¡
                const keys = Object.keys(data);
                if (keys.length === 0) {
                    return `<span class="text-slate-400 italic">ï¼ˆç©ºå¯¹è±¡ï¼‰</span>`;
                }
                
                // é¡¶å±‚æˆ–æµ…å±‚å¯¹è±¡ â†’ æŒ‰å­—æ®µç±»å‹åˆ†åˆ«å¤„ç†
                if (depth === 0) {
                    return renderTopLevelObject(data);
                }
                
                // æ‰å¹³å¯¹è±¡ â†’ é”®å€¼å¯¹ç½‘æ ¼
                if (isFlatObject(data)) {
                    return renderKeyValueGrid(data);
                }
                
                // åµŒå¥—å¯¹è±¡ â†’ å¡ç‰‡
                return renderNestedObject(data, key, depth);
            }
            
            // æ¸²æŸ“åŸå§‹å€¼
            function renderPrimitiveValue(value, key) {
                if (typeof value === 'string') {
                    // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºä¸ºBadge
                    const badgeColor = key && getSmartHighlightType(key) === 'rating' ? getSmartBadgeColor(value) : null;
                    if (badgeColor) {
                        return `<span class="smart-badge smart-badge-${badgeColor}">${escapeHtml(value)}</span>`;
                    }
                    
                    // é•¿æ–‡æœ¬
                    if (value.length > 80) {
                        return `<div class="smart-kv-value-long">${escapeHtml(value)}</div>`;
                    }
                    
                    return `<span class="text-slate-700">${escapeHtml(value)}</span>`;
                }
                
                if (typeof value === 'number') {
                    return `<span class="text-blue-600 font-medium">${value}</span>`;
                }
                
                if (typeof value === 'boolean') {
                    return value 
                        ? `<span class="smart-badge smart-badge-green">æ˜¯</span>`
                        : `<span class="smart-badge smart-badge-gray">å¦</span>`;
                }
                
                return `<span class="text-slate-500">${String(value)}</span>`;
            }
            
            // æ¸²æŸ“è¡¨æ ¼ï¼ˆåŒæ„å¯¹è±¡æ•°ç»„ï¼‰
            function renderTable(arr) {
                if (arr.length === 0) return '';
                
                const headers = Object.keys(arr[0]);
                
                return `
                    <table class="smart-table">
                        <thead>
                            <tr>
                                ${headers.map(h => `<th>${escapeHtml(getFieldDisplayName(h))}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${arr.map(row => `
                                <tr>
                                    ${headers.map(h => `<td>${renderPrimitiveValue(row[h], h)}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // æ¸²æŸ“ç®€å•åˆ—è¡¨
            function renderSimpleList(arr, key) {
                const useNumbers = key && (key.includes('step') || key.includes('point') || key.includes('question') || 
                                          key.includes('æ­¥éª¤') || key.includes('è¦ç‚¹') || key.includes('é—®é¢˜'));
                
                return `
                    <ul class="smart-list">
                        ${arr.map((item, i) => `
                            <li class="smart-list-item">
                                ${useNumbers 
                                    ? `<span class="smart-list-number">${i + 1}</span>`
                                    : `<span class="smart-list-bullet"></span>`
                                }
                                <span>${renderPrimitiveValue(item, null)}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }
            
            // æ¸²æŸ“å¤æ‚æ•°ç»„
            function renderComplexArray(arr, key, depth) {
                return arr.map((item, i) => {
                    const nodeId = `arr-${Math.random().toString(36).substr(2, 9)}`;
                    const itemTitle = item.name || item.title || item.id || `é¡¹ç›® ${i + 1}`;
                    
                    return `
                        <div class="smart-card">
                            <div class="smart-card-header" onclick="toggleSmartCard('${nodeId}')">
                                <span class="smart-card-title">
                                    <span class="smart-card-title-icon">ğŸ“Œ</span>
                                    ${escapeHtml(String(itemTitle))}
                                </span>
                                <span class="smart-card-toggle" id="${nodeId}-icon">â–¼</span>
                            </div>
                            <div class="smart-card-content" id="${nodeId}">
                                ${renderSmartValue(item, null, depth + 1)}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // æ¸²æŸ“é”®å€¼å¯¹ç½‘æ ¼
            function renderKeyValueGrid(obj) {
                const entries = Object.entries(obj);
                
                return `
                    <div class="smart-kv-grid">
                        ${entries.map(([k, v]) => `
                            <span class="smart-kv-key">${escapeHtml(getFieldDisplayName(k))}</span>
                            <span class="smart-kv-value">${renderPrimitiveValue(v, k)}</span>
                        `).join('')}
                    </div>
                `;
            }
            
            // æ¸²æŸ“é¡¶å±‚å¯¹è±¡ï¼ˆåˆ†å¡ç‰‡æ˜¾ç¤ºï¼‰
            function renderTopLevelObject(obj) {
                const entries = Object.entries(obj);
                
                // åˆ†ç¦»ç®€å•å­—æ®µå’Œå¤æ‚å­—æ®µ
                const simpleFields = {};
                const complexFields = [];
                
                entries.forEach(([k, v]) => {
                    if (typeof v !== 'object' || v === null) {
                        simpleFields[k] = v;
                    } else {
                        complexFields.push([k, v]);
                    }
                });
                
                let html = '';
                
                // ç®€å•å­—æ®µä½œä¸ºæ¦‚è§ˆå¡ç‰‡
                if (Object.keys(simpleFields).length > 0) {
                    html += `
                        <div class="smart-card">
                            <div class="smart-card-header" onclick="toggleSmartCard('overview-card')">
                                <span class="smart-card-title">
                                    <span class="smart-card-title-icon">ğŸ“‹</span>
                                    æ¦‚è§ˆ
                                </span>
                                <span class="smart-card-toggle" id="overview-card-icon">â–¼</span>
                            </div>
                            <div class="smart-card-content" id="overview-card">
                                ${renderKeyValueGrid(simpleFields)}
                            </div>
                        </div>
                    `;
                }
                
                // å¤æ‚å­—æ®µå„è‡ªä¸€ä¸ªå¡ç‰‡
                complexFields.forEach(([k, v]) => {
                    const nodeId = `card-${Math.random().toString(36).substr(2, 9)}`;
                    const highlightType = getSmartHighlightType(k);
                    const highlightClass = highlightType ? `smart-highlight-${highlightType}` : '';
                    const displayName = getFieldDisplayName(k);
                    const icon = getFieldIcon(k);
                    const isArray = Array.isArray(v);
                    const badge = isArray ? `${v.length} é¡¹` : `${Object.keys(v).length} å­—æ®µ`;
                    
                    html += `
                        <div class="smart-card ${highlightClass}">
                            <div class="smart-card-header" onclick="toggleSmartCard('${nodeId}')">
                                <span class="smart-card-title">
                                    <span class="smart-card-title-icon">${icon}</span>
                                    ${escapeHtml(displayName)}
                                    <span class="smart-card-badge">${badge}</span>
                                </span>
                                <span class="smart-card-toggle" id="${nodeId}-icon">â–¼</span>
                            </div>
                            <div class="smart-card-content" id="${nodeId}">
                                ${renderSmartValue(v, k, 1)}
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }
            
            // æ¸²æŸ“åµŒå¥—å¯¹è±¡
            function renderNestedObject(obj, key, depth) {
                // å¦‚æœæ˜¯æ‰å¹³çš„ï¼Œç”¨ç½‘æ ¼
                if (isFlatObject(obj)) {
                    return renderKeyValueGrid(obj);
                }
                
                // å¦åˆ™é€’å½’å¤„ç†æ¯ä¸ªå­—æ®µ
                const entries = Object.entries(obj);
                let html = '<div class="space-y-2">';
                
                entries.forEach(([k, v]) => {
                    const displayName = getFieldDisplayName(k);
                    
                    if (typeof v !== 'object' || v === null) {
                        html += `
                            <div class="flex items-start gap-2">
                                <span class="smart-kv-key min-w-[100px]">${escapeHtml(displayName)}</span>
                                <span class="smart-kv-value">${renderPrimitiveValue(v, k)}</span>
                            </div>
                        `;
                    } else {
                        const nodeId = `nested-${Math.random().toString(36).substr(2, 9)}`;
                        const collapsed = depth >= 2 ? 'collapsed' : '';
                        const icon = collapsed ? 'â–¶' : 'â–¼';
                        
                        html += `
                            <div class="border-l-2 border-slate-200 pl-3 mt-2">
                                <div class="flex items-center gap-2 cursor-pointer text-slate-600 hover:text-slate-800 mb-1" onclick="toggleSmartCard('${nodeId}')">
                                    <span class="text-xs" id="${nodeId}-icon">${icon}</span>
                                    <span class="font-medium text-sm">${escapeHtml(displayName)}</span>
                                </div>
                                <div class="${collapsed}" id="${nodeId}">
                                    ${renderSmartValue(v, k, depth + 1)}
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                return html;
            }
            
            // åˆ‡æ¢å¡ç‰‡å±•å¼€/æŠ˜å 
            function toggleSmartCard(nodeId) {
                const content = document.getElementById(nodeId);
                const icon = document.getElementById(`${nodeId}-icon`);
                if (!content || !icon) return;
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }

            function appendLog(logText) {
                const p = document.createElement('p');
                p.className = 'break-all border-b border-slate-800 pb-1 last:border-0';
                if (logText.includes('ERROR')) p.classList.add('text-red-400');
                else if (logText.includes('WARNING')) p.classList.add('text-yellow-400');
                else if (logText.includes('INFO')) p.classList.add('text-blue-300');
                p.textContent = logText;
                logContainer.appendChild(p);
            }

            function clearLogs() {
                logContainer.innerHTML = '';
                lastLogCount = 0;
            }

            // ==================== æŠ¥å‘Šç‰ˆæœ¬ç®¡ç† ====================
            async function fetchReportVersions() {
                if (!currentSessionId) return;
                
                try {
                    const response = await fetch(`/api/report_versions?workspace_id=${currentSessionId}`);
                    const data = await response.json();
                    
                    const select = document.getElementById('report-version-select');
                    if (!select) return;
                    
                    // å¦‚æœåªæœ‰ä¸€ä¸ªç‰ˆæœ¬æˆ–æ²¡æœ‰ç‰ˆæœ¬ï¼Œéšè—ä¸‹æ‹‰æ¡†
                    if (!data.versions || data.versions.length <= 1) {
                        select.classList.add('hidden');
                        return;
                    }
                    
                    // æ¸…ç©ºå¹¶å¡«å……é€‰é¡¹
                    select.innerHTML = '';
                    data.versions.forEach((v, idx) => {
                        const option = document.createElement('option');
                        option.value = v.filename;
                        option.textContent = v.label;
                        // é»˜è®¤é€‰ä¸­å½“å‰ç‰ˆæœ¬ï¼ˆreport.htmlï¼‰
                        if (v.filename === 'report.html') {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                    select.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('è·å–æŠ¥å‘Šç‰ˆæœ¬å¤±è´¥:', error);
                }
            }

            async function loadReportVersion(filename) {
                if (!currentSessionId || !filename) return;
                
                try {
                    const response = await fetch(`/api/report_content?workspace_id=${currentSessionId}&filename=${encodeURIComponent(filename)}`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.content) {
                        // æ›´æ–°iframeå†…å®¹
                        let html = data.content;
                        
                        // å¤„ç†é™æ€èµ„æºè·¯å¾„ï¼ˆä¸handleFinalReportç›¸åŒçš„é€»è¾‘ï¼‰
                        const baseUrl = window.location.origin;
                        html = html
                            .replace(/src=["']\/static\/vendor\/echarts\.min\.js["']/g, `src="${baseUrl}/static/vendor/echarts.min.js"`)
                            .replace(/href=["']\/static\//g, `href="${baseUrl}/static/`);
                        
                        // æ³¨å…¥ä¿®è®¢é¢æ¿
                        if (!html.includes('revision-panel')) {
                            html = injectRevisionPanel(html);
                        }
                        
                        reportIframe.srcdoc = html;
                        cachedReportHtml = data.content; // æ›´æ–°ç¼“å­˜
                    } else {
                        showAlert(data.message || 'åŠ è½½æŠ¥å‘Šç‰ˆæœ¬å¤±è´¥', 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    console.error('åŠ è½½æŠ¥å‘Šç‰ˆæœ¬å¤±è´¥:', error);
                    showAlert('åŠ è½½æŠ¥å‘Šç‰ˆæœ¬å¤±è´¥', 'é”™è¯¯', 'error');
                }
            }

            function openReportInNewTab() {
                if (!currentSessionId) {
                    showAlert('æŠ¥å‘Šå°šæœªç”Ÿæˆï¼Œæ— æ³•æ‰“å¼€ç¼–è¾‘å™¨', 'æç¤º');
                    return;
                }
                
                const reportUrl = `/report/${currentSessionId}`;
                window.open(reportUrl, '_blank');
                showAlert('å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æŠ¥å‘Šï¼ˆæ”¯æŒç¼–è¾‘åŠŸèƒ½ï¼‰', 'æˆåŠŸ');
            }

            function copyReport() {
                if (reportIframe && reportIframe.contentDocument) {
                    const text = reportIframe.contentDocument.body.innerText;
                    navigator.clipboard.writeText(text).then(() => showAlert(t('msg_copy_success'), t('title_success')));
                }
            }

            function downloadReport() {
                if (reportIframe && reportIframe.srcdoc) {
                    const blob = new Blob([reportIframe.srcdoc], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    a.download = `è®®äº‹æŠ¥å‘Š_${timestamp}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    showAlert(t('msg_report_not_ready'), t('title_hint'));
                }
            }

            async function downloadMarkdown(e) {
                if (!(reportIframe && reportIframe.srcdoc)) {
                    showAlert(t('msg_report_not_ready'), t('title_hint'));
                    return;
                }
                
                const btn = e ? e.target.closest('button') : null;
                const originalText = btn ? btn.innerText : '';
                
                try {
                    if (btn) {
                        btn.disabled = true;
                        btn.innerText = 'ğŸ”„ è½¬æ¢ä¸­...';
                    }
                    
                    console.log('å¼€å§‹Markdownå¯¼å‡º...');
                    
                    // å‘é€HTMLåˆ°åç«¯è½¬æ¢
                    const response = await fetch('/api/export_md', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            html: reportIframe.srcdoc,
                            filename: `è®®äº‹æŠ¥å‘Š_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.md`
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Markdownå¯¼å‡ºå¤±è´¥');
                    }
                    
                    // è·å–æ–‡ä»¶
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è®®äº‹æŠ¥å‘Š_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log('âœ… Markdownå¯¼å‡ºæˆåŠŸ');
                    showAlert('Markdownæ ¼å¼å¯¼å‡ºæˆåŠŸï¼', t('title_success'));
                    
                } catch (error) {
                    console.error('Markdownå¯¼å‡ºå¤±è´¥:', error);
                    showAlert('Markdownå¯¼å‡ºå¤±è´¥: ' + error.message, t('title_error'), 'error');
                } finally {
                    if (btn) {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }
            }

            async function downloadPDF(e) {
                if (!(reportIframe && reportIframe.contentDocument && reportIframe.contentDocument.body)) {
                    showAlert(t('msg_report_not_ready'), t('title_hint'));
                    return;
                }

                const btn = e?.currentTarget;
                const originalText = btn ? btn.innerText : '';
                if (btn) {
                    btn.innerText = 'ç”Ÿæˆä¸­...';
                    btn.disabled = true;
                }

                // ä¿å­˜æŠ˜å çŠ¶æ€å¹¶å…¨éƒ¨å±•å¼€
                const collapsedElements = [];
                try {
                    const doc = reportIframe.contentDocument;
                    
                    // æŸ¥æ‰¾æ‰€æœ‰å¸¦ 'collapsed' ç±»çš„å…ƒç´ 
                    const collapsedItems = doc.querySelectorAll('.collapsed');
                    collapsedItems.forEach(elem => {
                        collapsedElements.push(elem);
                        elem.classList.remove('collapsed');
                    });
                    
                    // æŸ¥æ‰¾æ‰€æœ‰ details å…ƒç´ å¹¶å±•å¼€
                    const detailsElements = doc.querySelectorAll('details:not([open])');
                    detailsElements.forEach(elem => {
                        collapsedElements.push({ elem, type: 'details' });
                        elem.setAttribute('open', '');
                    });
                    
                    // æŸ¥æ‰¾æ‰€æœ‰éšè—å…ƒç´ ï¼ˆhiddenç±»ï¼‰
                    const hiddenElements = doc.querySelectorAll('.hidden:not(script):not(style)');
                    hiddenElements.forEach(elem => {
                        // åªå±•å¼€æœ‰å®é™…å†…å®¹çš„å…ƒç´ 
                        if (elem.textContent.trim() || elem.querySelector('img, svg, canvas')) {
                            collapsedElements.push({ elem, type: 'hidden' });
                            elem.classList.remove('hidden');
                        }
                    });
                    
                    console.log(`å±•å¼€äº† ${collapsedElements.length} ä¸ªæŠ˜å å…ƒç´ `);
                } catch (err) {
                    console.warn('å±•å¼€æŠ˜å å†…å®¹æ—¶å‡ºé”™:', err);
                }

                try {
                    // æ‰“åŒ…ç‰ˆæœ¬ç›´æ¥å°è¯•ä½¿ç”¨Playwrightï¼ˆå·²å†…ç½®ï¼‰ï¼Œå¼€å‘ç¯å¢ƒä¼šè‡ªåŠ¨é™çº§
                    try {
                        // å°è¯•ä½¿ç”¨é«˜è´¨é‡PDFå¯¼å‡ºï¼ˆPlaywrightï¼‰
                        let htmlContent = reportIframe.contentDocument.documentElement.outerHTML;
                        
                        // æ›¿æ¢CDNé“¾æ¥ä¸ºæœ¬åœ°è·¯å¾„ï¼ˆç¡®ä¿EChartså›¾è¡¨èƒ½æ­£ç¡®æ¸²æŸ“ï¼‰
                        htmlContent = htmlContent.replace(
                            /https?:\/\/[^"']+echarts[^"']*(\.min)?\.js/gi,
                            '/static/vendor/echarts.min.js'
                        );
                        
                        // å¦‚æœä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºå®Œæ•´URL
                        htmlContent = htmlContent.replace(
                            /src="\/static\//g,
                            `src="http://127.0.0.1:5000/static/`
                        );
                        htmlContent = htmlContent.replace(
                            /href="\/static\//g,
                            `href="http://127.0.0.1:5000/static/`
                        );
                        
                        const response = await fetch('/api/export_pdf', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                html: htmlContent,
                                filename: `Council_Report_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.pdf`
                            })
                        });
                        
                        if (response.ok) {
                            // ä¸‹è½½PDFæ–‡ä»¶
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `Council_Report_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            
                            showAlert(
                                'âœ… PDFå·²å¯¼å‡ºï¼ˆé«˜è´¨é‡ç‰ˆæœ¬ï¼Œä¿ç•™è¶…é“¾æ¥ï¼‰',
                                'æˆåŠŸ',
                                'success'
                            );
                        } else {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'PDFç”Ÿæˆå¤±è´¥');
                        }
                    } catch (playwrightError) {
                        // Playwrightå¯¼å‡ºå¤±è´¥ï¼Œé™çº§åˆ°ä¼ ç»Ÿæ–¹å¼
                        console.warn('Playwright PDFå¯¼å‡ºå¤±è´¥ï¼Œé™çº§åˆ°ä¼ ç»Ÿæ–¹å¼:', playwrightError);
                        await downloadPDFLegacy();
                    }
                } catch (error) {
                    console.error('PDF export error:', error);
                    showAlert(
                        error.message || t('msg_pdf_failed'),
                        t('title_error'),
                        'error'
                    );
                } finally {
                    // æ¢å¤æŠ˜å çŠ¶æ€
                    try {
                        collapsedElements.forEach(item => {
                            if (item.type === 'details') {
                                item.elem.removeAttribute('open');
                            } else if (item.type === 'hidden') {
                                item.elem.classList.add('hidden');
                            } else if (item.classList) {
                                item.classList.add('collapsed');
                            }
                        });
                        console.log('å·²æ¢å¤æŠ˜å çŠ¶æ€');
                    } catch (err) {
                        console.warn('æ¢å¤æŠ˜å çŠ¶æ€æ—¶å‡ºé”™:', err);
                    }
                    
                    if (btn) {
                // æ³¨æ„ï¼šæŠ˜å å…ƒç´ å·²åœ¨ downloadPDF ä¸­å±•å¼€ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }
            }
            
            // æ—§ç‰ˆjsPDFå¯¼å‡ºæ–¹æ³•ï¼ˆä½œä¸ºåå¤‡æ–¹æ¡ˆï¼‰
            async function downloadPDFLegacy() {
                if (!(reportIframe && reportIframe.contentDocument && reportIframe.contentDocument.body)) {
                    throw new Error(t('msg_report_not_ready'));
                }

                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error('jsPDF not loaded');
                }

                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(reportIframe.contentDocument.body, {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scale: 2
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth;
                const imgHeight = canvas.height * (imgWidth / canvas.width);

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                pdf.save(`Council_Report_${timestamp}.pdf`);
            }

            async function downloadImage(e) {
                if (reportIframe && reportIframe.contentDocument && reportIframe.contentDocument.body) {
                    const btn = e.currentTarget;
                    const originalText = btn.innerText;
                    btn.innerText = 'è½¬æ¢ä¸­...';
                    btn.disabled = true;

                    // ä¿å­˜æŠ˜å çŠ¶æ€å¹¶å…¨éƒ¨å±•å¼€
                    const collapsedElements = [];
                    try {
                        const doc = reportIframe.contentDocument;
                        
                        // æŸ¥æ‰¾æ‰€æœ‰å¸¦ 'collapsed' ç±»çš„å…ƒç´ 
                        const collapsedItems = doc.querySelectorAll('.collapsed');
                        collapsedItems.forEach(elem => {
                            collapsedElements.push(elem);
                            elem.classList.remove('collapsed');
                        });
                        
                        // æŸ¥æ‰¾æ‰€æœ‰ details å…ƒç´ å¹¶å±•å¼€
                        const detailsElements = doc.querySelectorAll('details:not([open])');
                        detailsElements.forEach(elem => {
                            collapsedElements.push({ elem, type: 'details' });
                            elem.setAttribute('open', '');
                        });
                        
                        // æŸ¥æ‰¾æ‰€æœ‰éšè—å…ƒç´ ï¼ˆhiddenç±»ï¼‰
                        const hiddenElements = doc.querySelectorAll('.hidden:not(script):not(style)');
                        hiddenElements.forEach(elem => {
                            if (elem.textContent.trim() || elem.querySelector('img, svg, canvas')) {
                                collapsedElements.push({ elem, type: 'hidden' });
                                elem.classList.remove('hidden');
                            }
                        });
                        
                        console.log(`é•¿å›¾å¯¼å‡ºï¼šå±•å¼€äº† ${collapsedElements.length} ä¸ªæŠ˜å å…ƒç´ `);
                        
                        // ç»™DOMä¸€ç‚¹æ—¶é—´é‡æ–°æ¸²æŸ“
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (err) {
                        console.warn('å±•å¼€æŠ˜å å†…å®¹æ—¶å‡ºé”™:', err);
                    }

                    try {
                        // ä½¿ç”¨ html2canvas æ¸²æŸ“ iframe å†…å®¹
                        const canvas = await html2canvas(reportIframe.contentDocument.body, {
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            scale: 2 // æé«˜æ¸…æ™°åº¦
                        });
                        
                        const url = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        a.download = `Council_Report_${timestamp}.png`;
                        a.href = url;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } catch (error) {
                        console.error('Image conversion error:', error);
                        showAlert(t('msg_image_failed'), t('title_error'), 'error');
                    } finally {
                        // æ¢å¤æŠ˜å çŠ¶æ€
                        try {
                            collapsedElements.forEach(item => {
                                if (item.type === 'details') {
                                    item.elem.removeAttribute('open');
                                } else if (item.type === 'hidden') {
                                    item.elem.classList.add('hidden');
                                } else if (item.classList) {
                                    item.classList.add('collapsed');
                                }
                            });
                            console.log('å·²æ¢å¤æŠ˜å çŠ¶æ€');
                        } catch (err) {
                            console.warn('æ¢å¤æŠ˜å çŠ¶æ€æ—¶å‡ºé”™:', err);
                        }
                        
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                } else {
                    showAlert(t('msg_report_not_ready'), t('title_hint'));
                }
            }

            // å†å²è®°å½•åŠŸèƒ½
            async function deleteWorkspace(event, sessionId) {
                event.stopPropagation(); // é˜»æ­¢è§¦å‘ loadWorkspace
                
                const confirmed = await showConfirm(t('msg_confirm_delete'), t('title_confirm_delete'));
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/delete_workspace/${sessionId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // é‡æ–°åŠ è½½å†å²åˆ—è¡¨
                        const modal = document.getElementById('history-modal');
                        modal.classList.add('hidden'); // å…ˆå…³é—­
                        toggleHistoryModal(); // å†æ‰“å¼€ä»¥è§¦å‘åˆ·æ–°
                        showAlert(t('msg_delete_success'), t('title_success'));
                    } else {
                        showAlert(t('msg_delete_failed') + ': ' + (data.message || 'unknown'), t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert(t('msg_delete_failed') + ': ' + error.message, t('title_error'), 'error');
                }
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
            async function checkAdminStatus() {
                try {
                    const response = await fetch('/api/auth/user-info');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.is_admin) {
                            // æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®
                            document.getElementById('admin-btn').classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Failed to check admin status:', error);
                }
            }

            async function logout() {
                const confirmed = await showConfirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ', 'é€€å‡ºç™»å½•');
                if (!confirmed) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        await showAlert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    await showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
                }
            }

            async function toggleHistoryModal() {
                const modal = document.getElementById('history-modal');
                const list = document.getElementById('history-list');
                
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    list.innerHTML = `<div class="text-center py-8 text-slate-400 italic">${t('history_loading')}</div>`;
                    
                    try {
                        const response = await fetch('/api/workspaces');
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.workspaces.length > 0) {
                            list.innerHTML = '';
                            data.workspaces.forEach(ws => {
                                const item = document.createElement('div');
                                item.className = 'p-4 border border-slate-100 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 cursor-pointer transition group';
                                item.onclick = () => loadWorkspace(ws.id);
                                item.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-800 group-hover:text-indigo-700">${ws.issue || t('msg_untitled_issue')}</h4>
                                            <p class="text-xs text-slate-400 mt-1">ID: ${ws.id}</p>
                                        </div>
                                        <div class="flex flex-col items-end space-y-2">
                                            <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">${ws.timestamp}</span>
                                            <button onclick="deleteWorkspace(event, '${ws.id}')" 
                                                    class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition opacity-0 group-hover:opacity-100"
                                                    title="${t('btn_delete_record')}">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                `;
                                list.appendChild(item);
                            });
                        } else {
                            list.innerHTML = `<div class="text-center py-8 text-slate-400 italic">${t('msg_history_empty')}</div>`;
                        }
                    } catch (error) {
                        list.innerHTML = `<div class="text-center py-8 text-red-400 italic">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    }
                } else {
                    modal.classList.add('hidden');
                }
            }

            function toggleLogs() {
                const logSection = document.getElementById('log-section');
                logSection.classList.toggle('hidden');
            }

            async function loadWorkspace(sessionId) {
                const confirmed = await showConfirm(t('msg_confirm_load'), t('title_confirm_load'));
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/load_workspace/${sessionId}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // é‡ç½®UI
                        document.getElementById('discussion-flow').innerHTML = '';
                        // æ¸…ç©ºå¹¶éšè—æŠ¥å‘Š
                        const reportIframe = document.getElementById('report-iframe');
                        reportIframe.srcdoc = "<div style='color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;'></div>";
                        
                        // é‡ç½®è¿›åº¦æ¡
                        currentProgress = 0;
                        isReportingPhase = false;
                        document.getElementById('progress-bar').style.width = '0%';
                        document.getElementById('progress-percentage').innerText = '0%';
                        
                        // æ›´æ–°è¾“å…¥æ¡†
                        document.getElementById('issue-input').value = data.issue || '';
                        if (data.rounds) {
                            document.getElementById('rounds-input').value = data.rounds;
                        }
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        toggleHistoryModal();
                        
                        // æç¤ºæˆåŠŸ
                        showAlert(t('msg_load_success'), t('title_success'));
                        
                        // é‡ç½®è®¡æ•°å™¨ä»¥å¼ºåˆ¶å…¨é‡æ‹‰å–
                        lastEventCount = 0;
                        lastLogCount = 0;
                        
                        // è§¦å‘ä¸€æ¬¡æ›´æ–°ä»¥æ‹‰å–æ‰€æœ‰å†å²äº‹ä»¶
                        fetchUpdates();
                    } else {
                        showAlert(t('msg_load_failed') + ': ' + (data.message || 'unknown'), t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert(t('msg_load_failed') + ': ' + error.message, t('title_error'), 'error');
                }
            }

            // åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', () => {
                // åˆå§‹åŒ–è¯­è¨€
                setLanguage(currentLang);

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜å¹¶æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®
                checkAdminStatus();

                // æ¢å¤ Meta-Orchestrator æ¨¡å¼çŠ¶æ€
                const savedOrchestratorMode = localStorage.getItem('orchestrator_mode') === 'true';
                isOrchestratorMode = savedOrchestratorMode;
                const orchestratorToggle = document.getElementById('orchestrator-mode-toggle');
                if (orchestratorToggle) {
                    orchestratorToggle.checked = savedOrchestratorMode;
                }

                // åˆå§‹åŒ–éšè—å­—æ®µçš„é»˜è®¤å€¼
                document.getElementById('backend-select').value = 'deepseek';
                document.getElementById('global-model-input').value = '';
                document.getElementById('global-reasoning-input').value = '';
                document.getElementById('rounds-input').value = '3';
                document.getElementById('planners-input').value = '2';
                document.getElementById('auditors-input').value = '2';

                // åŠ è½½ç¼–åˆ¶åˆ—è¡¨
                loadPresets();

                // å¯åŠ¨å®šæ—¶è½®è¯¢
                setInterval(fetchUpdates, 1000);
                
                // åˆå§‹æ£€æŸ¥æµè§ˆå™¨çŠ¶æ€
                fetch('/api/status').then(r => r.json()).then(data => {
                    if (data.browser_found === false) {
                        showAlert(t('msg_browser_missing'), t('title_hint'), 'warning');
                    }
                });
                
                // ç›‘å¬æŠ¥å‘Šä¿®è®¢åº”ç”¨æ¶ˆæ¯
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'revision_applied' && event.data.html) {
                        // é‡æ–°æ³¨å…¥ä¿®è®¢é¢æ¿å¹¶æ›´æ–°iframe
                        let newHtml = event.data.html;
                        if (!newHtml.includes('revision-panel')) {
                            newHtml = injectRevisionPanel(newHtml);
                        }
                        const reportFrame = document.getElementById('report-iframe');
                        if (reportFrame) {
                            reportFrame.srcdoc = newHtml;
                        }
                        // æ›´æ–°ç‰ˆæœ¬é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆæ–°å¢ç‰ˆæœ¬ï¼‰
                        fetchReportVersions();
                    }
                });
                
                // ç›‘å¬å…¨å±€åç«¯é€‰æ‹©ï¼ˆéšè—å­—æ®µï¼‰
                const globalBackend = document.getElementById('backend-select');
                const globalModel = document.getElementById('global-model-input');
                const updateGlobalList = () => {
                    if (globalBackend.value === 'openrouter') {
                        globalModel.setAttribute('list', 'openrouter-models-list');
                        fetchOpenRouterModels();
                    } else if (globalBackend.value === 'deepseek') {
                        globalModel.setAttribute('list', 'deepseek-models-list');
                        fetchDeepSeekModels();
                    } else {
                        globalModel.removeAttribute('list');
                    }
                };
                globalBackend.addEventListener('change', updateGlobalList);
                updateGlobalList(); // åˆå§‹æ£€æŸ¥

                // ç›‘å¬modalåç«¯é€‰æ‹©
                const modalBackend = document.getElementById('modal-backend-select');
                const modalModel = document.getElementById('modal-global-model-input');
                const updateModalGlobalList = () => {
                    if (modalBackend.value === 'openrouter') {
                        modalModel.setAttribute('list', 'openrouter-models-list');
                        fetchOpenRouterModels();
                    } else if (modalBackend.value === 'deepseek') {
                        modalModel.setAttribute('list', 'deepseek-models-list');
                        fetchDeepSeekModels();
                    } else {
                        modalModel.removeAttribute('list');
                    }
                    updateModalReasoningVisibility();
                };
                modalBackend.addEventListener('change', updateModalGlobalList);
                
                // ç›‘å¬modalä¸­ç­–è®ºå®¶å’Œç›‘å¯Ÿå®˜æ•°é‡å˜åŒ–
                document.getElementById('modal-planners-input').addEventListener('input', () => {
                    updateModalAgentConfigsUI();
                });
                document.getElementById('modal-auditors-input').addEventListener('input', () => {
                    updateModalAgentConfigsUI();
                });

                // ç›‘å¬ç­–è®ºå®¶å’Œç›‘å¯Ÿå®˜æ•°é‡å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°å¸­ä½é…ç½®
                const updateConfigsIfVisible = () => {
                    const modal = document.getElementById('advanced-config-modal');
                    if (modal && !modal.classList.contains('hidden')) {
                        updateModalAgentConfigsUI();
                    }
                };
                document.getElementById('planners-input').addEventListener('input', updateConfigsIfVisible);
                document.getElementById('auditors-input').addEventListener('input', updateConfigsIfVisible);

                // ç›‘å¬é™æ€ Agent åç«¯é€‰æ‹© (Leader, Reporter)
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    const input = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    if (input) {
                        const updateAgentList = () => {
                            if (select.value === 'openrouter') {
                                input.setAttribute('list', 'openrouter-models-list');
                                fetchOpenRouterModels();
                            } else if (select.value === 'deepseek') {
                                input.setAttribute('list', 'deepseek-models-list');
                                fetchDeepSeekModels();
                            } else {
                                input.removeAttribute('list');
                            }
                        };
                        select.addEventListener('change', updateAgentList);
                        updateAgentList(); // åˆå§‹æ£€æŸ¥
                    }
                });
            });

            function toggleAdvancedSettings() {
                // åºŸå¼ƒå‡½æ•° - æ”¹ä¸ºä½¿ç”¨ toggleAdvancedConfigModal
                toggleAdvancedConfigModal();
            }

            // æ–°çš„é«˜çº§é…ç½®Modalæ§åˆ¶å‡½æ•°
            function toggleAdvancedConfigModal() {
                const modal = document.getElementById('advanced-config-modal');
                if (modal.classList.contains('hidden')) {
                    // æ‰“å¼€modal - ä»éšè—å­—æ®µåŠ è½½å€¼åˆ°modalå­—æ®µ
                    document.getElementById('modal-backend-select').value = document.getElementById('backend-select').value || 'deepseek';
                    document.getElementById('modal-global-model-input').value = document.getElementById('global-model-input').value || '';
                    document.getElementById('modal-global-reasoning-input').value = document.getElementById('global-reasoning-input').value || '';
                    document.getElementById('modal-rounds-input').value = document.getElementById('rounds-input').value || '3';
                    document.getElementById('modal-planners-input').value = document.getElementById('planners-input').value || '2';
                    document.getElementById('modal-auditors-input').value = document.getElementById('auditors-input').value || '2';
                    
                    // æ›´æ–°æ¨ç†å¼ºåº¦å®¹å™¨æ˜¾ç¤º
                    updateModalReasoningVisibility();
                    // æ›´æ–°å¸­ä½é…ç½®åˆ—è¡¨
                    updateModalAgentConfigsUI();
                    
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }

            // Tabåˆ‡æ¢å‡½æ•°
            function switchAdvancedTab(tabName) {
                // æ›´æ–°tabæŒ‰é’®æ ·å¼
                const basicBtn = document.getElementById('tab-basic-btn');
                const agentsBtn = document.getElementById('tab-agents-btn');
                const presetsBtn = document.getElementById('tab-presets-btn');
                const settingsBtn = document.getElementById('tab-settings-btn');
                const userBtn = document.getElementById('tab-user-btn');
                const basicContent = document.getElementById('tab-basic-content');
                const agentsContent = document.getElementById('tab-agents-content');
                const presetsContent = document.getElementById('tab-presets-content');
                const settingsContent = document.getElementById('tab-settings-content');
                const userContent = document.getElementById('tab-user-content');
                
                // é‡ç½®æ‰€æœ‰tabæ ·å¼
                [basicBtn, agentsBtn, presetsBtn, settingsBtn, userBtn].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('text-blue-600', 'border-blue-600');
                        btn.classList.add('text-slate-500', 'border-transparent');
                    }
                });
                [basicContent, agentsContent, presetsContent, settingsContent, userContent].forEach(content => {
                    if (content) content.classList.add('hidden');
                });
                
                // æ¿€æ´»é€‰ä¸­çš„tab
                if (tabName === 'basic') {
                    basicBtn.classList.add('text-blue-600', 'border-blue-600');
                    basicBtn.classList.remove('text-slate-500', 'border-transparent');
                    basicContent.classList.remove('hidden');
                } else if (tabName === 'agents') {
                    agentsBtn.classList.add('text-blue-600', 'border-blue-600');
                    agentsBtn.classList.remove('text-slate-500', 'border-transparent');
                    agentsContent.classList.remove('hidden');
                    // åˆ‡æ¢åˆ°å¸­ä½é…ç½®tabæ—¶ï¼Œæ›´æ–°UI
                    updateModalAgentConfigsUI();
                } else if (tabName === 'presets') {
                    presetsBtn.classList.add('text-blue-600', 'border-blue-600');
                    presetsBtn.classList.remove('text-slate-500', 'border-transparent');
                    presetsContent.classList.remove('hidden');
                    // åˆ‡æ¢åˆ°ç¼–åˆ¶tabæ—¶ï¼ŒåŠ è½½ç¼–åˆ¶åˆ—è¡¨
                    loadModalPresetsList();
                } else if (tabName === 'settings') {
                    settingsBtn.classList.add('text-blue-600', 'border-blue-600');
                    settingsBtn.classList.remove('text-slate-500', 'border-transparent');
                    settingsContent.classList.remove('hidden');
                    // åˆ‡æ¢åˆ°ç³»ç»Ÿè®¾ç½®tabæ—¶ï¼ŒåŠ è½½å½“å‰é…ç½®
                    loadSystemSettings();
                } else if (tabName === 'user') {
                    userBtn.classList.add('text-blue-600', 'border-blue-600');
                    userBtn.classList.remove('text-slate-500', 'border-transparent');
                    userContent.classList.remove('hidden');
                    // åˆ‡æ¢åˆ°ç”¨æˆ·è®¾ç½®tabæ—¶ï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯
                    loadUserInfo();
                }
            }

            // åº”ç”¨é«˜çº§é…ç½®
            async function applyAdvancedConfig() {
                // å¦‚æœå½“å‰åœ¨ç³»ç»Ÿè®¾ç½®tabï¼Œå…ˆä¿å­˜ç³»ç»Ÿè®¾ç½®
                const settingsTab = document.getElementById('tab-settings-content');
                if (!settingsTab.classList.contains('hidden')) {
                    const saved = await saveSettings();
                    if (!saved) {
                        return; // å¦‚æœä¿å­˜å¤±è´¥ï¼Œä¸å…³é—­modal
                    }
                }
                
                // ä»modalå­—æ®µå¤åˆ¶å€¼åˆ°éšè—å­—æ®µ
                document.getElementById('backend-select').value = document.getElementById('modal-backend-select').value;
                document.getElementById('global-model-input').value = document.getElementById('modal-global-model-input').value;
                document.getElementById('global-reasoning-input').value = document.getElementById('modal-global-reasoning-input').value;
                document.getElementById('rounds-input').value = document.getElementById('modal-rounds-input').value;
                document.getElementById('planners-input').value = document.getElementById('modal-planners-input').value;
                document.getElementById('auditors-input').value = document.getElementById('modal-auditors-input').value;
                
                // è§¦å‘åç«¯é€‰æ‹©å˜åŒ–äº‹ä»¶ï¼ˆæ›´æ–°æ¨ç†å®¹å™¨å¯è§æ€§ï¼‰
                const backendSelect = document.getElementById('backend-select');
                const event = new Event('change');
                backendSelect.dispatchEvent(event);
                
                // å…³é—­modal
                toggleAdvancedConfigModal();
                
                // æ˜¾ç¤ºæç¤º
                console.log('é«˜çº§é…ç½®å·²åº”ç”¨');
            }

            // ç›‘å¬modalåç«¯é€‰æ‹©å˜åŒ–ï¼Œæ§åˆ¶æ¨ç†å¼ºåº¦æ˜¾ç¤º
            function updateModalReasoningVisibility() {
                const backend = document.getElementById('modal-backend-select').value;
                const reasoningContainer = document.getElementById('modal-global-reasoning-container');
                const supportsReasoning = ['deepseek', 'openai', 'azure', 'openrouter'].includes(backend);
                
                if (supportsReasoning) {
                    reasoningContainer.classList.remove('hidden');
                } else {
                    reasoningContainer.classList.add('hidden');
                }
            }

            // æ›´æ–°modalä¸­çš„å¸­ä½é…ç½®UI
            function updateModalAgentConfigsUI() {
                const container = document.getElementById('modal-agent-configs-container');
                const plannersCount = parseInt(document.getElementById('modal-planners-input').value) || 0;
                const auditorsCount = parseInt(document.getElementById('modal-auditors-input').value) || 0;
                
                // å¤„ç† Planners
                for (let i = 0; i < 5; i++) {
                    const id = `planner_${i}`;
                    let el = container.querySelector(`[data-agent-wrapper="${id}"]`);
                    if (i < plannersCount) {
                        if (!el) {
                            const div = createAgentConfigItem(`${t('role_planner')} ${i+1}`, id, 'bg-blue-50', 'bg-blue-500');
                            container.appendChild(div);
                        } else {
                            // æ›´æ–°æ ‡ç­¾è¯­è¨€
                            const label = el.querySelector('h4');
                            if (label) {
                                label.innerHTML = `<span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>${t('role_planner')} ${i+1}`;
                            }
                        }
                    } else if (el) {
                        container.removeChild(el);
                    }
                }

                // å¤„ç† Auditors
                for (let i = 0; i < 5; i++) {
                    const id = `auditor_${i}`;
                    let el = container.querySelector(`[data-agent-wrapper="${id}"]`);
                    if (i < auditorsCount) {
                        if (!el) {
                            const div = createAgentConfigItem(`${t('role_auditor')} ${i+1}`, id, 'bg-amber-50', 'bg-amber-500');
                            container.appendChild(div);
                        } else {
                            // æ›´æ–°æ ‡ç­¾è¯­è¨€
                            const label = el.querySelector('h4');
                            if (label) {
                                label.innerHTML = `<span class="w-2 h-2 bg-amber-500 rounded-full mr-2"></span>${t('role_auditor')} ${i+1}`;
                            }
                        }
                    } else if (el) {
                        container.removeChild(el);
                    }
                }
            }

            function updateAgentConfigsUI() {
                // æ—§å‡½æ•° - ç°åœ¨è°ƒç”¨modalç‰ˆæœ¬
                updateModalAgentConfigsUI();
            }

            // Modalç¼–åˆ¶ç®¡ç†å‡½æ•°
            async function saveModalPreset() {
                const nameInput = document.getElementById('modal-new-preset-name');
                let name = nameInput.value.trim();
                
                if (!name) {
                    showAlert(t('msg_preset_name_empty'), t('title_hint'), 'warning');
                    return;
                }

                // ä»modalå­—æ®µæ”¶é›†é…ç½®
                const config = {
                    backend: document.getElementById('modal-backend-select').value,
                    global_model: document.getElementById('modal-global-model-input').value,
                    global_reasoning: document.getElementById('modal-global-reasoning-input').value,
                    rounds: parseInt(document.getElementById('modal-rounds-input').value),
                    planners: parseInt(document.getElementById('modal-planners-input').value),
                    auditors: parseInt(document.getElementById('modal-auditors-input').value),
                    agents: {}
                };

                // æ”¶é›† Agent é…ç½®
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    const modelInput = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    const reasoningSelect = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                    if (modelInput && reasoningSelect) {
                        config.agents[agentId] = {
                            backend: select.value,
                            model: modelInput.value,
                            reasoning: reasoningSelect.value
                        };
                    }
                });

                try {
                    const response = await fetch('/api/presets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, config })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert(t('msg_preset_saved'), t('title_success'));
                        nameInput.value = ''; 
                        loadModalPresetsList();
                        loadPresets(); // åŒæ—¶æ›´æ–°dropdownåˆ—è¡¨
                    } else {
                        showAlert(data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert(error.message, t('title_error'), 'error');
                }
            }

            async function loadModalPresetsList() {
                const container = document.getElementById('modal-presets-list');
                try {
                    const response = await fetch('/api/presets');
                    const data = await response.json();
                    
                    // APIè¿”å›çš„æ˜¯å¯¹è±¡æ ¼å¼ {name: config, ...}
                    const presetArray = Object.entries(data.presets || {});
                    
                    if (presetArray.length > 0) {
                        container.innerHTML = presetArray.map(([name, config]) => `
                            <div class="bg-white p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-700 mb-1">${name}</div>
                                    <div class="text-xs text-slate-500">
                                        ${config.backend || 'default'} | ${t('input_rounds_label')}: ${config.rounds || 3} | 
                                        ${t('input_planners_label')}: ${config.planners || 2} | ${t('input_auditors_label')}: ${config.auditors || 2}
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="applyModalPreset('${name}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition" data-i18n="btn_load">
                                        åŠ è½½
                                    </button>
                                    <button onclick="deleteModalPreset('${name}')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition" data-i18n="btn_delete">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="text-center text-gray-400 py-4">æš‚æ— å­˜æ¡£</div>';
                    }
                } catch (error) {
                    container.innerHTML = `<div class="text-center text-red-400 py-4">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
            }

            async function applyModalPreset(name) {
                try {
                    const response = await fetch('/api/presets');
                    const data = await response.json();
                    
                    // APIè¿”å›çš„æ˜¯å¯¹è±¡æ ¼å¼ {name: config, ...}
                    const config = data.presets[name];
                    if (!config) {
                        showAlert('ç¼–åˆ¶ä¸å­˜åœ¨', t('title_error'), 'error');
                        return;
                    }
                    
                    // åº”ç”¨åˆ°modalå­—æ®µ
                    document.getElementById('modal-backend-select').value = config.backend || 'deepseek';
                    document.getElementById('modal-global-model-input').value = config.global_model || '';
                    document.getElementById('modal-global-reasoning-input').value = config.global_reasoning || '';
                    document.getElementById('modal-rounds-input').value = config.rounds || 3;
                    document.getElementById('modal-planners-input').value = config.planners || 2;
                    document.getElementById('modal-auditors-input').value = config.auditors || 2;
                    
                    // æ›´æ–°æ¨ç†å¼ºåº¦æ˜¾ç¤º
                    updateModalReasoningVisibility();
                    
                    // åº”ç”¨ Agent é…ç½®
                    if (config.agents) {
                        Object.keys(config.agents).forEach(agentId => {
                            const agentConfig = config.agents[agentId];
                            const backendSelect = document.querySelector(`.agent-backend[data-agent="${agentId}"]`);
                            const modelInput = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                            const reasoningSelect = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                            
                            if (backendSelect) backendSelect.value = agentConfig.backend || 'default';
                            if (modelInput) modelInput.value = agentConfig.model || '';
                            if (reasoningSelect) reasoningSelect.value = agentConfig.reasoning || '';
                        });
                    }
                    
                    // æ›´æ–°å¸­ä½é…ç½®UI
                    updateModalAgentConfigsUI();
                    
                    showAlert(t('msg_preset_loaded'), t('title_success'));
                } catch (error) {
                    showAlert(error.message, t('title_error'), 'error');
                }
            }

            async function deleteModalPreset(name) {
                if (!confirm(t('confirm_delete_preset'))) return;

                try {
                    const response = await fetch(`/api/presets/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert(t('msg_preset_deleted'), t('title_success'));
                        loadModalPresetsList();
                        loadPresets(); // åŒæ—¶æ›´æ–°dropdownåˆ—è¡¨
                    } else {
                        showAlert(data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert(error.message, t('title_error'), 'error');
                }
            }

            function createAgentConfigItem(label, id, bgColor, dotColor) {
                const div = document.createElement('div');
                div.className = `p-3 ${bgColor} rounded-lg border border-slate-200`;
                div.setAttribute('data-agent-wrapper', id);
                div.innerHTML = `
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center">
                        <span class="w-2 h-2 ${dotColor} rounded-full mr-2"></span>${label}
                    </h4>
                    <div class="flex gap-2">
                        <select class="agent-backend flex-1 text-xs p-1 border rounded" data-agent="${id}">
                            <option value="default">${t('backend_default')}</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="aliyun">Aliyun</option>
                            <option value="ollama">Ollama</option>
                        </select>
                        <input type="text" class="agent-model flex-1 text-xs p-1 border rounded" placeholder="${t('agent_model_placeholder')}" data-agent="${id}">
                    </div>
                    <select class="agent-reasoning hidden text-[10px] p-1 border rounded mt-1 w-full" data-agent="${id}">
                        <option value="">${t('reasoning_off')}</option>
                        <option value="low">æ¨ç†: Low</option>
                        <option value="medium">æ¨ç†: Medium</option>
                        <option value="high">æ¨ç†: High</option>
                    </select>
                `;
                
                // ä¸ºåç«¯é€‰æ‹©æ·»åŠ ç›‘å¬å™¨ï¼ŒåŠ¨æ€åˆ‡æ¢ datalist
                const select = div.querySelector('.agent-backend');
                const input = div.querySelector('.agent-model');
                const reasoningSelect = div.querySelector('.agent-reasoning');
                const updateList = () => {
                    if (select.value === 'openrouter') {
                        input.setAttribute('list', 'openrouter-models-list');
                        reasoningSelect.classList.remove('hidden');
                        fetchOpenRouterModels();
                    } else if (select.value === 'deepseek') {
                        input.setAttribute('list', 'deepseek-models-list');
                        reasoningSelect.classList.add('hidden');
                        fetchDeepSeekModels();
                    } else {
                        input.removeAttribute('list');
                        reasoningSelect.classList.add('hidden');
                    }
                };
                select.addEventListener('change', updateList);
                updateList(); // åˆå§‹æ£€æŸ¥
                
                return div;
            }

            async function fetchOpenRouterModels() {
                try {
                    const response = await fetch('/api/openrouter/models');
                    const models = await response.json();
                    const datalist = document.getElementById('openrouter-models-list');
                    datalist.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name || model.id;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching OpenRouter models:', error);
                }
            }

            async function fetchDeepSeekModels() {
                try {
                    const response = await fetch('/api/deepseek/models');
                    const models = await response.json();
                    const datalist = document.getElementById('deepseek-models-list');
                    datalist.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching DeepSeek models:', error);
                }
            }

            // ç›‘å¬å…¨å±€åç«¯é€‰æ‹©
            document.getElementById('backend-select').addEventListener('change', function() {
                const modelInput = document.getElementById('global-model-input');
                const reasoningContainer = document.getElementById('global-reasoning-container');
                
                if (this.value === 'openrouter') {
                    modelInput.setAttribute('list', 'openrouter-models-list');
                    reasoningContainer.classList.remove('hidden');
                    fetchOpenRouterModels();
                } else if (this.value === 'deepseek') {
                    modelInput.setAttribute('list', 'deepseek-models-list');
                    reasoningContainer.classList.add('hidden');
                    fetchDeepSeekModels();
                } else {
                    modelInput.removeAttribute('list');
                    reasoningContainer.classList.add('hidden');
                }
            });

            // ç›‘å¬ä»£ç†äººåç«¯é€‰æ‹©
            document.addEventListener('change', function(e) {
                if (e.target && e.target.classList.contains('agent-backend')) {
                    const agentId = e.target.dataset.agent;
                    const modelInput = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    const reasoningSelect = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                    
                    if (e.target.value === 'openrouter') {
                        modelInput.setAttribute('list', 'openrouter-models-list');
                        reasoningSelect.classList.remove('hidden');
                        fetchOpenRouterModels();
                    } else if (e.target.value === 'deepseek') {
                        modelInput.setAttribute('list', 'deepseek-models-list');
                        reasoningSelect.classList.add('hidden');
                        fetchDeepSeekModels();
                    } else {
                        modelInput.removeAttribute('list');
                        reasoningSelect.classList.add('hidden');
                    }
                }
            });

            // --- ç³»ç»Ÿè®¾ç½®åŠŸèƒ½ (æ•´åˆè‡³é«˜çº§é…ç½®) ---
            
            async function loadSystemSettings() {
                try {
                    const response = await fetch('/api/config');
                    const data = await response.json();
                    if (data.status === 'success') {
                        const cfg = data.config;
                        document.getElementById('settings-key-deepseek').value = cfg.DEEPSEEK_API_KEY || '';
                        document.getElementById('settings-key-openai').value = cfg.OPENAI_API_KEY || '';
                        document.getElementById('settings-key-azure').value = cfg.AZURE_OPENAI_API_KEY || '';
                        document.getElementById('settings-azure-endpoint').value = cfg.AZURE_OPENAI_ENDPOINT || '';
                        document.getElementById('settings-azure-deployment').value = cfg.AZURE_OPENAI_DEPLOYMENT_NAME || '';
                        document.getElementById('settings-key-anthropic').value = cfg.ANTHROPIC_API_KEY || '';
                        document.getElementById('settings-key-gemini').value = cfg.GEMINI_API_KEY || '';
                        document.getElementById('settings-key-openrouter').value = cfg.OPENROUTER_API_KEY || '';
                        document.getElementById('settings-key-aliyun').value = cfg.ALIYUN_API_KEY || '';
                        document.getElementById('settings-key-tavily').value = cfg.TAVILY_API_KEY || '';
                        document.getElementById('settings-key-google').value = cfg.GOOGLE_API_KEY || '';
                        document.getElementById('settings-google-cx').value = cfg.GOOGLE_SEARCH_ENGINE_ID || '';
                        document.getElementById('settings-browser-path').value = cfg.BROWSER_PATH || '';
                        
                        // å¤„ç†å¤šé€‰æœç´¢ä¾›åº”å•†
                        if (cfg.SEARCH_PROVIDER) {
                            const providers = cfg.SEARCH_PROVIDER.split(',').map(p => p.trim());
                            document.querySelectorAll('.search-provider-checkbox').forEach(cb => {
                                cb.checked = providers.includes(cb.value);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Failed to load config:', error);
                }
            }

            async function saveSettings() {
                const selectedProviders = Array.from(document.querySelectorAll('.search-provider-checkbox:checked'))
                    .map(cb => cb.value)
                    .join(',');

                const keys = {
                    DEEPSEEK_API_KEY: document.getElementById('settings-key-deepseek').value.trim(),
                    OPENAI_API_KEY: document.getElementById('settings-key-openai').value.trim(),
                    AZURE_OPENAI_API_KEY: document.getElementById('settings-key-azure').value.trim(),
                    AZURE_OPENAI_ENDPOINT: document.getElementById('settings-azure-endpoint').value.trim(),
                    AZURE_OPENAI_DEPLOYMENT_NAME: document.getElementById('settings-azure-deployment').value.trim(),
                    ANTHROPIC_API_KEY: document.getElementById('settings-key-anthropic').value.trim(),
                    GEMINI_API_KEY: document.getElementById('settings-key-gemini').value.trim(),
                    OPENROUTER_API_KEY: document.getElementById('settings-key-openrouter').value.trim(),
                    ALIYUN_API_KEY: document.getElementById('settings-key-aliyun').value.trim(),
                    TAVILY_API_KEY: document.getElementById('settings-key-tavily').value.trim(),
                    GOOGLE_API_KEY: document.getElementById('settings-key-google').value.trim(),
                    GOOGLE_SEARCH_ENGINE_ID: document.getElementById('settings-google-cx').value.trim(),
                    BROWSER_PATH: document.getElementById('settings-browser-path').value.trim(),
                    SEARCH_PROVIDER: selectedProviders
                };

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(keys)
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        showAlert(t('msg_save_success'), t('title_success'));
                        return true;
                    } else {
                        showAlert(t('msg_save_failed') + ': ' + data.message, t('title_error'), 'error');
                        return false;
                    }
                } catch (error) {
                    showAlert(t('msg_save_failed') + ': ' + error.message, t('title_error'), 'error');
                    return false;
                }
            }
            
            // --- è§’è‰²ç®¡ç†åŠŸèƒ½ ---

            async function toggleRolesModal() {
                const modal = document.getElementById('roles-modal');
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    await loadRolesList();
                } else {
                    modal.classList.add('hidden');
                    closeRoleDetail();
                }
            }

            // åŠ è½½ç”¨æˆ·ä¿¡æ¯
            async function loadUserInfo() {
                try {
                    const response = await fetch('/api/auth/user/info');
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('user-display-username').textContent = data.username;
                        document.getElementById('user-display-email').textContent = data.email;
                        
                        const mfaStatus = data.mfa_enabled 
                            ? '<span class="text-green-600">âœ… å·²å¯ç”¨</span>' 
                            : '<span class="text-gray-500">âŒ æœªå¯ç”¨</span>';
                        document.getElementById('user-display-mfa').innerHTML = mfaStatus;
                        
                        // åŠ è½½MFAç®¡ç†ç•Œé¢
                        loadMfaManagement(data.mfa_enabled);
                    } else {
                        showAlert('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Load user info error:', error);
                    showAlert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯', t('title_error'), 'error');
                }
            }

            // åŠ è½½MFAç®¡ç†ç•Œé¢
            function loadMfaManagement(mfaEnabled) {
                const container = document.getElementById('mfa-status-container');
                
                if (mfaEnabled) {
                    // MFAå·²å¯ç”¨
                    container.innerHTML = `
                        <div class="bg-green-50 border border-green-200 p-3 rounded-lg">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-bold text-green-800">åŒå› ç´ è®¤è¯å·²å¯ç”¨</span>
                            </div>
                            <p class="text-xs text-green-700 mb-3">æ‚¨çš„è´¦æˆ·å·²å—åˆ°é¢å¤–ä¿æŠ¤ã€‚å¦‚éœ€æ›´æ¢è®¾å¤‡æˆ–é‡æ–°é…ç½®ï¼Œè¯·å…ˆç¦ç”¨å†é‡æ–°è®¾ç½®ã€‚</p>
                            <button onclick="disableMfa()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded-lg font-bold transition">
                                ç¦ç”¨åŒå› ç´ è®¤è¯
                            </button>
                        </div>
                        <div class="bg-white border border-blue-200 p-3 rounded-lg">
                            <p class="text-xs text-slate-600 mb-2">
                                <span class="font-bold">ğŸ’¡ æç¤ºï¼š</span>ç¦ç”¨åå¯ä»¥é‡æ–°é…ç½®MFA
                            </p>
                            <a href="/mfa-setup" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs font-bold underline">
                                éœ€è¦å¸®åŠ©ï¼ŸæŸ¥çœ‹è®¾ç½®æŒ‡å— â†—
                            </a>
                        </div>
                    `;
                } else {
                    // MFAæœªå¯ç”¨
                    container.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-bold text-yellow-800">å»ºè®®å¯ç”¨åŒå› ç´ è®¤è¯</span>
                            </div>
                            <p class="text-xs text-yellow-700 mb-3">å¯ç”¨åŒå› ç´ è®¤è¯å¯ä»¥å¤§å¹…æå‡è´¦æˆ·å®‰å…¨æ€§ï¼Œé˜²æ­¢å¯†ç æ³„éœ²å¯¼è‡´çš„è´¦æˆ·è¢«ç›—ã€‚</p>
                            <a href="/mfa-setup" class="block w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-bold transition text-center">
                                ç«‹å³å¯ç”¨
                            </a>
                        </div>
                        <div class="bg-white border border-blue-200 p-3 rounded-lg">
                            <p class="text-xs text-slate-600 mb-1">
                                <span class="font-bold">ğŸ” ä»€ä¹ˆæ˜¯åŒå› ç´ è®¤è¯ï¼Ÿ</span>
                            </p>
                            <p class="text-xs text-slate-500">
                                é™¤äº†å¯†ç å¤–ï¼Œè¿˜éœ€è¦æ‰‹æœºéªŒè¯å™¨åº”ç”¨ç”Ÿæˆçš„6ä½åŠ¨æ€éªŒè¯ç ï¼Œå³ä½¿å¯†ç æ³„éœ²ä¹Ÿèƒ½ä¿æŠ¤è´¦æˆ·å®‰å…¨ã€‚
                            </p>
                        </div>
                    `;
                }
            }

            // ç¦ç”¨MFA
            async function disableMfa() {
                const password = await showPasswordInput('ä¸ºäº†å®‰å…¨ï¼Œè¯·è¾“å…¥æ‚¨çš„å½“å‰å¯†ç ä»¥ç¦ç”¨åŒå› ç´ è®¤è¯ï¼š', 'ç¦ç”¨åŒå› ç´ è®¤è¯');
                
                if (!password) {
                    return; // ç”¨æˆ·å–æ¶ˆ
                }

                try {
                    const response = await fetch('/api/auth/mfa/disable', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert('åŒå› ç´ è®¤è¯å·²ç¦ç”¨ã€‚æ‚¨å¯ä»¥éšæ—¶é‡æ–°å¯ç”¨ã€‚', t('title_success'), 'success');
                        // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                        loadUserInfo();
                    } else {
                        showAlert(data.error || 'ç¦ç”¨å¤±è´¥', t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Disable MFA error:', error);
                    showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', t('title_error'), 'error');
                }
            }

            // ä¿®æ”¹å¯†ç 
            async function changePassword() {
                const currentPassword = document.getElementById('user-current-password').value.trim();
                const newPassword = document.getElementById('user-new-password').value.trim();
                const confirmPassword = document.getElementById('user-confirm-password').value.trim();

                // å‰ç«¯éªŒè¯
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', t('title_error'), 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showAlert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', t('title_error'), 'error');
                    return;
                }

                if (newPassword.length < 8) {
                    showAlert('æ–°å¯†ç é•¿åº¦è‡³å°‘8ä½', t('title_error'), 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/auth/user/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showAlert(data.message || 'å¯†ç ä¿®æ”¹æˆåŠŸï¼', t('title_success'), 'success');
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        document.getElementById('user-current-password').value = '';
                        document.getElementById('user-new-password').value = '';
                        document.getElementById('user-confirm-password').value = '';
                    } else {
                        if (data.details) {
                            const errors = Object.values(data.details).join('ã€');
                            showAlert(`${data.error}ï¼š${errors}`, t('title_error'), 'error');
                        } else {
                            showAlert(data.error || 'å¯†ç ä¿®æ”¹å¤±è´¥', t('title_error'), 'error');
                        }
                    }
                } catch (error) {
                    console.error('Change password error:', error);
                    showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', t('title_error'), 'error');
                }
            }

            // é€€å‡ºç™»å½•
            async function handleLogout() {
                if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    return;
                }

                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        showAlert('ç™»å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', t('title_error'), 'error');
                }
            }

            async function loadRolesList(tagFilter = null) {
                try {
                    let url = '/api/roles';
                    if (tagFilter) {
                        url += `?tag=${tagFilter}`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    console.log('Roles API response:', data); // Debug log
                    
                    if (data.status === 'success') {
                        if (!data.roles) {
                            console.error('API returned success but no roles array:', data);
                            showAlert('è§’è‰²æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘roleså­—æ®µ', t('title_error'), 'error');
                            return;
                        }
                        renderRolesList(data.roles);
                    } else {
                        showAlert(t('msg_load_failed') + ': ' + (data.message || 'Unknown error'), t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to load roles:', error);
                    showAlert(t('msg_load_failed') + ': ' + error.message, t('title_error'), 'error');
                }
            }

            function renderRolesList(roles) {
                const listContainer = document.getElementById('roles-list');
                if (!listContainer) return;

                listContainer.innerHTML = '';

                if (!roles || !Array.isArray(roles)) {
                    console.error('renderRolesList: roles is not an array:', roles);
                    listContainer.innerHTML = `<div class="col-span-2 text-center text-red-400 py-8">æ•°æ®æ ¼å¼é”™è¯¯</div>`;
                    return;
                }

                if (roles.length === 0) {
                    listContainer.innerHTML = `<div class="col-span-2 text-center text-gray-400 py-8">æš‚æ— è§’è‰²</div>`;
                    return;
                }

                roles.forEach(role => {
                    const card = document.createElement('div');
                    card.className = 'bg-gradient-to-br from-slate-50 to-slate-100 p-4 rounded-xl border border-slate-200 hover:shadow-lg transition group';
                    
                    const colorMap = {
                        'blue': 'bg-blue-500',
                        'green': 'bg-green-500',
                        'purple': 'bg-purple-500',
                        'orange': 'bg-orange-500',
                        'red': 'bg-red-500',
                        'pink': 'bg-pink-500',
                        'indigo': 'bg-indigo-500'
                    };
                    
                    const bgColor = colorMap[role.ui.color] || 'bg-slate-500';
                    const tags = role.tags.map(tag => {
                        const tagColor = tag === 'core' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600';
                        const tagText = tag === 'core' ? t('role_tag_core') : (tag === 'advanced' ? t('role_tag_advanced') : tag);
                        return `<span class="px-2 py-0.5 ${tagColor} rounded-full text-xs">${tagText}</span>`;
                    }).join(' ');
                    
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 ${bgColor} rounded-lg flex items-center justify-center text-white text-xl">
                                    ${role.ui.icon}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">${role.display_name}</h4>
                                    <p class="text-xs text-slate-500">${t('role_version')}: ${role.version}</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mb-3 line-clamp-2">${role.ui.description_short}</p>
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${tags}
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-slate-200">
                            <div class="text-xs text-slate-500">
                                ${t('role_stages')}: ${role.stages.length}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="showRoleDetail('${role.name}')" 
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition">
                                    ${t('role_btn_detail')}
                                </button>
                                <button onclick="reloadRole('${role.name}')" 
                                        class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded-lg transition">
                                    ${t('role_btn_reload')}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    listContainer.appendChild(card);
                });
            }

            async function showRoleDetail(roleName) {
                try {
                    const response = await fetch(`/api/roles/${roleName}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const role = data.role;
                        
                        let contentHtml = '';
                        
                        // é˜¶æ®µä¿¡æ¯
                        if (role.stages && role.stages.length > 0) {
                            contentHtml += `
                                <section class="space-y-2">
                                    <h4 class="text-sm font-bold text-slate-700">${t('role_stages')}</h4>
                                    ${role.stages.map(stage => `
                                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                            <div class="font-bold text-slate-800 mb-1">${stage.name}</div>
                                            <div class="text-xs text-slate-600">${stage.description || 'æ— æè¿°'}</div>
                                            ${stage.input_vars && stage.input_vars.length > 0 ? `
                                                <div class="text-xs text-slate-500 mt-2">
                                                    è¾“å…¥å˜é‡: ${stage.input_vars.join(', ')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </section>
                            `;
                        }
                        
                        // å‚æ•°ä¿¡æ¯
                        if (role.parameters) {
                            contentHtml += `
                                <section class="space-y-2">
                                    <h4 class="text-sm font-bold text-slate-700">${t('role_parameters')}</h4>
                                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div><span class="text-slate-500">Temperature:</span> <span class="font-mono">${role.parameters.temperature}</span></div>
                                            <div><span class="text-slate-500">Max Retries:</span> <span class="font-mono">${role.parameters.max_retries}</span></div>
                                        </div>
                                    </div>
                                </section>
                            `;
                        }
                        
                        // æç¤ºè¯é¢„è§ˆï¼ˆå®Œæ•´æ˜¾ç¤ºï¼‰
                        if (role.prompt_preview || role.prompts) {
                            let promptContent = '';
                            if (role.prompts) {
                                // å¦‚æœæœ‰å®Œæ•´çš„promptsä¿¡æ¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰é˜¶æ®µ
                                promptContent = Object.entries(role.prompts).map(([stage, prompt]) => 
                                    `<div class="mb-3 pb-3 border-b border-slate-200 last:border-0 last:pb-0">
                                        <h5 class="text-xs font-bold text-blue-700 mb-2">é˜¶æ®µ: ${stage}</h5>
                                        <pre class="text-xs text-slate-600 whitespace-pre-wrap font-mono">${prompt}</pre>
                                    </div>`
                                ).join('');
                            } else {
                                // fallbackåˆ°preview
                                promptContent = `<pre class="text-xs text-slate-600 whitespace-pre-wrap font-mono">${role.prompt_preview}</pre>`;
                            }
                            
                            contentHtml += `
                                <section class="space-y-2">
                                    <h4 class="text-sm font-bold text-slate-700">${t('role_prompt_preview')}</h4>
                                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 max-h-96 overflow-y-auto">
                                        ${promptContent}
                                    </div>
                                </section>
                            `;
                        }
                        
                        // æ˜¾ç¤ºç‹¬ç«‹Modal
                        document.getElementById('detail-role-name').textContent = role.display_name;
                        document.getElementById('detail-role-desc').textContent = role.description;
                        document.getElementById('detail-role-content').innerHTML = contentHtml;
                        
                        // æ·»åŠ ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                        const detailHeader = document.getElementById('role-detail-modal').querySelector('.flex.justify-between');
                        const existingBtns = detailHeader.querySelector('.role-action-btns');
                        if (existingBtns) {
                            existingBtns.remove();
                        }
                        
                        const btnContainer = document.createElement('div');
                        btnContainer.className = 'role-action-btns flex space-x-2 mr-2';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition text-sm';
                        editBtn.innerHTML = 'âœï¸ ç¼–è¾‘';
                        editBtn.onclick = () => openRoleEditor(roleName);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition text-sm';
                        deleteBtn.innerHTML = 'ğŸ—‘ï¸ åˆ é™¤';
                        deleteBtn.onclick = () => deleteRole(roleName);
                        
                        btnContainer.appendChild(editBtn);
                        btnContainer.appendChild(deleteBtn);
                        
                        const closeBtn = detailHeader.querySelector('button');
                        closeBtn.parentElement.insertBefore(btnContainer, closeBtn);
                        
                        document.getElementById('role-detail-modal').classList.remove('hidden');
                    } else {
                        showAlert(t('msg_load_failed') + ': ' + data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to load role detail:', error);
                    showAlert(t('msg_load_failed') + ': ' + error.message, t('title_error'), 'error');
                }
            }

            function closeRoleDetail() {
                document.getElementById('role-detail-modal').classList.add('hidden');
            }
            
            async function deleteRole(roleName) {
                // å¼¹çª—ç¡®è®¤
                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² "${roleName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤è§’è‰²é…ç½®æ–‡ä»¶å’Œæ‰€æœ‰ç›¸å…³Promptæ–‡ä»¶ï¼Œä¸”ä¸å¯æ¢å¤ï¼`);
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/roles/${roleName}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert('è§’è‰²å·²æˆåŠŸåˆ é™¤', 'åˆ é™¤æˆåŠŸ');
                        closeRoleDetail(); // å…³é—­è¯¦æƒ…Modal
                        await loadRolesList(); // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
                    } else {
                        showAlert('åˆ é™¤å¤±è´¥: ' + data.message, 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    console.error('Failed to delete role:', error);
                    showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'é”™è¯¯', 'error');
                }
            }

            async function reloadRole(roleName) {
                try {
                    const response = await fetch(`/api/roles/${roleName}/reload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert(t('role_reload_success'), t('title_success'));
                        await loadRolesList(); // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
                        closeRoleDetail(); // å…³é—­è¯¦æƒ…é¢æ¿
                    } else {
                        showAlert(t('role_reload_failed') + ': ' + data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to reload role:', error);
                    showAlert(t('role_reload_failed') + ': ' + error.message, t('title_error'), 'error');
                }
            }

            // --- è§’è‰²ç¼–è¾‘åŠŸèƒ½ ---
            
            let currentEditingRole = null;
            
            async function openRoleEditor(roleName) {
                try {
                    const response = await fetch(`/api/roles/${roleName}/config`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        currentEditingRole = roleName;
                        
                        // æ˜¾ç¤ºmodal
                        document.getElementById('role-edit-modal').classList.remove('hidden');
                        document.getElementById('edit-role-name').textContent = roleName;
                        
                        // åŠ è½½YAMLé…ç½®
                        document.getElementById('role-yaml-editor').value = data.data.yaml_content;
                        
                        // åŠ è½½prompts
                        const promptsContainer = document.getElementById('prompt-editors');
                        promptsContainer.innerHTML = '';
                        
                        for (const [stageName, promptContent] of Object.entries(data.data.prompts)) {
                            const editorHtml = `
                                <div class="border border-slate-300 rounded-lg p-4">
                                    <label class="block text-xs font-bold text-slate-600 uppercase mb-2">${stageName} Prompt</label>
                                    <textarea data-stage="${stageName}" 
                                              class="prompt-editor w-full h-48 px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm outline-none focus:border-blue-500 transition"
                                              placeholder="Promptå†…å®¹...">${promptContent}</textarea>
                                </div>
                            `;
                            promptsContainer.insertAdjacentHTML('beforeend', editorHtml);
                        }
                    } else {
                        showAlert('åŠ è½½é…ç½®å¤±è´¥: ' + data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to load role config:', error);
                    showAlert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, t('title_error'), 'error');
                }
            }
            
            function closeRoleEditor() {
                document.getElementById('role-edit-modal').classList.add('hidden');
                currentEditingRole = null;
            }
            
            async function validateRoleConfig() {
                const yamlContent = document.getElementById('role-yaml-editor').value;
                
                try {
                    const response = await fetch('/api/roles/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ yaml_content: yamlContent })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.valid) {
                        showAlert('âœ… é…ç½®éªŒè¯é€šè¿‡', t('title_success'));
                    } else {
                        showAlert('âŒ é…ç½®éªŒè¯å¤±è´¥:\n' + data.error, t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert('éªŒè¯å¤±è´¥: ' + error.message, t('title_error'), 'error');
                }
            }
            
            async function saveRoleConfig() {
                if (!currentEditingRole) return;
                
                const yamlContent = document.getElementById('role-yaml-editor').value;
                
                // æ”¶é›†æ‰€æœ‰prompt
                const prompts = {};
                document.querySelectorAll('.prompt-editor').forEach(textarea => {
                    const stageName = textarea.getAttribute('data-stage');
                    prompts[stageName] = textarea.value;
                });
                
                try {
                    const response = await fetch(`/api/roles/${currentEditingRole}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            yaml_content: yamlContent,
                            prompts: prompts
                        })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert('âœ… è§’è‰²é…ç½®å·²ä¿å­˜å¹¶é‡è½½', t('title_success'));
                        closeRoleEditor();
                        await loadRolesList(); // åˆ·æ–°è§’è‰²åˆ—è¡¨
                        closeRoleDetail(); // å…³é—­è¯¦æƒ…é¢æ¿
                    } else {
                        showAlert('âŒ ä¿å­˜å¤±è´¥:\n' + data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to save role config:', error);
                    showAlert('ä¿å­˜å¤±è´¥: ' + error.message, t('title_error'), 'error');
                }
            }

            // --- è§’è‰²è®¾è®¡å¸ˆåŠŸèƒ½ ---
            let currentDesignerStep = 1;
            let generatedRoleDesign = null;

            function openRoleDesigner() {
                // é‡ç½®çŠ¶æ€
                currentDesignerStep = 1;
                generatedRoleDesign = null;
                document.getElementById('role-requirement-input').value = '';
                
                // æ˜¾ç¤ºç‹¬ç«‹Modal
                document.getElementById('role-designer-modal').classList.remove('hidden');
                updateDesignerStep(1);
            }

            function closeRoleDesigner() {
                // å…³é—­ç‹¬ç«‹Modal
                document.getElementById('role-designer-modal').classList.add('hidden');
                currentDesignerStep = 1;
                generatedRoleDesign = null;
            }

            function updateDesignerStep(step) {
                currentDesignerStep = step;
                
                // éšè—æ‰€æœ‰æ­¥éª¤å†…å®¹
                document.getElementById('designer-step-1').classList.add('hidden');
                document.getElementById('designer-step-2').classList.add('hidden');
                document.getElementById('designer-step-3').classList.add('hidden');
                
                // æ˜¾ç¤ºå½“å‰æ­¥éª¤
                document.getElementById(`designer-step-${step}`).classList.remove('hidden');
                
                // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
                for (let i = 1; i <= 3; i++) {
                    const indicator = document.getElementById(`step-indicator-${i}`);
                    const label = document.getElementById(`step-label-${i}`);
                    
                    if (i < step) {
                        // å·²å®Œæˆçš„æ­¥éª¤
                        indicator.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold';
                        indicator.innerHTML = 'âœ“';
                        label.className = 'ml-2 text-green-600 font-bold';
                    } else if (i === step) {
                        // å½“å‰æ­¥éª¤
                        indicator.className = 'w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold';
                        indicator.textContent = i;
                        label.className = 'ml-2 font-bold text-blue-600';
                    } else {
                        // æœªå®Œæˆçš„æ­¥éª¤
                        indicator.className = 'w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center font-bold';
                        indicator.textContent = i;
                        label.className = 'ml-2 text-slate-400';
                    }
                }
                
                // æ›´æ–°è¿›åº¦æ¡
                for (let i = 1; i <= 2; i++) {
                    const progress = document.getElementById(`step-progress-${i}`);
                    if (i < step) {
                        progress.style.width = '100%';
                    } else {
                        progress.style.width = '0%';
                    }
                }
                
                // æ›´æ–°æŒ‰é’®
                const backBtn = document.getElementById('designer-back-btn');
                const nextBtn = document.getElementById('designer-next-btn');
                
                if (step === 1) {
                    backBtn.classList.add('hidden');
                    nextBtn.textContent = 'å¼€å§‹ç”Ÿæˆ â†’';
                    nextBtn.onclick = designerNextStep;
                } else if (step === 2) {
                    backBtn.classList.add('hidden'); // ç”Ÿæˆä¸­ä¸å…è®¸è¿”å›
                    nextBtn.classList.add('hidden');
                } else if (step === 3) {
                    backBtn.classList.remove('hidden');
                    nextBtn.classList.remove('hidden');
                    nextBtn.textContent = 'ä¿å­˜è§’è‰²';
                    nextBtn.onclick = saveNewRole;
                }
            }

            async function designerNextStep() {
                if (currentDesignerStep === 1) {
                    // éªŒè¯éœ€æ±‚è¾“å…¥
                    const requirement = document.getElementById('role-requirement-input').value.trim();
                    if (!requirement) {
                        showAlert('è¯·è¾“å…¥è§’è‰²éœ€æ±‚æè¿°', 'æç¤º', 'warning');
                        return;
                    }
                    
                    // åˆ‡æ¢åˆ°ç”Ÿæˆæ­¥éª¤
                    updateDesignerStep(2);
                    
                    // æ¸…ç©ºæ˜¾ç¤ºåŒº
                    document.getElementById('reasoning-display').textContent = '';
                    document.getElementById('content-display').textContent = '';
                    
                    // è°ƒç”¨APIç”Ÿæˆè§’è‰²
                    try {
                        const response = await fetch('/api/roles/design', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ requirement })
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            generatedRoleDesign = data.design;
                            
                            // çŸ­æš‚å»¶è¿Ÿååˆ‡æ¢åˆ°é¢„è§ˆæ­¥éª¤
                            setTimeout(() => {
                                updateDesignerStep(3);
                                renderRolePreview(generatedRoleDesign);
                            }, 1000);
                        } else {
                            showAlert('ç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯', 'error');
                            
                            // å¤±è´¥åè¿”å›ç¬¬1æ­¥
                            setTimeout(() => updateDesignerStep(1), 2000);
                        }
                    } catch (error) {
                        console.error('Failed to generate role:', error);
                        showAlert('ç”Ÿæˆå¤±è´¥: ' + error.message, 'é”™è¯¯', 'error');
                        updateDesignerStep(1);
                    }
                }
            }
            
            // å¤„ç†è§’è‰²è®¾è®¡å¸ˆçš„å®æ—¶æ›´æ–°
            function handleRoleDesignerEvent(eventData) {
                if (eventData.type === 'role_designer_reasoning') {
                    const reasoningDiv = document.getElementById('reasoning-display');
                    if (reasoningDiv) {
                        reasoningDiv.textContent += eventData.content;
                        reasoningDiv.scrollTop = reasoningDiv.scrollHeight;
                    }
                } else if (eventData.type === 'role_designer_content') {
                    const contentDiv = document.getElementById('content-display');
                    if (contentDiv) {
                        contentDiv.textContent += eventData.content;
                        contentDiv.scrollTop = contentDiv.scrollHeight;
                    }
                }
            }

            function designerGoBack() {
                if (currentDesignerStep === 3) {
                    updateDesignerStep(1);
                }
            }

            function renderRolePreview(design) {
                // æ¸²æŸ“åŸºæœ¬ä¿¡æ¯
                document.getElementById('preview-role-name').value = design.role_name;
                document.getElementById('preview-display-name').value = design.display_name;
                document.getElementById('preview-description').value = design.role_description;
                
                // æ¸²æŸ“é˜¶æ®µ
                const stagesContainer = document.getElementById('preview-stages-container');
                stagesContainer.innerHTML = '';
                
                design.stages.forEach((stage, idx) => {
                    const stageCard = document.createElement('div');
                    stageCard.className = 'bg-white border border-slate-300 rounded-lg p-3';
                    stageCard.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-bold text-slate-700">${stage.stage_name}</h5>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${stage.output_schema}</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-2"><strong>æ€ç»´æ–¹å¼:</strong> ${stage.thinking_style}</p>
                        <div class="text-sm text-slate-600">
                            <strong>èŒè´£:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                ${stage.responsibilities.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                        <p class="text-xs text-slate-500 mt-2"><strong>è¾“å‡ºæ ¼å¼:</strong> ${stage.output_format}</p>
                    `;
                    stagesContainer.appendChild(stageCard);
                });
                
                // æ¸²æŸ“æ¨èäººç‰©
                const personasContainer = document.getElementById('preview-personas-container');
                personasContainer.innerHTML = '';
                
                if (design.recommended_personas && design.recommended_personas.length > 0) {
                    design.recommended_personas.forEach(persona => {
                        const personaCard = document.createElement('div');
                        personaCard.className = 'bg-white border border-slate-300 rounded-lg p-3 flex items-start';
                        personaCard.innerHTML = `
                            <div class="text-2xl mr-3">ğŸ‘¤</div>
                            <div class="flex-1">
                                <h5 class="font-bold text-slate-700 mb-1">${persona.name}</h5>
                                <p class="text-sm text-slate-600 mb-2">${persona.reason}</p>
                                <div class="flex flex-wrap gap-1">
                                    ${persona.traits.map(t => `<span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">${t}</span>`).join('')}
                                </div>
                            </div>
                        `;
                        personasContainer.appendChild(personaCard);
                    });
                } else {
                    personasContainer.innerHTML = '<p class="text-sm text-slate-400">æ— æ¨èäººç‰©</p>';
                }
            }

            async function saveNewRole() {
                try {
                    // æ”¶é›†å¯èƒ½çš„ç¼–è¾‘å†…å®¹
                    const updatedDesign = {
                        ...generatedRoleDesign,
                        display_name: document.getElementById('preview-display-name').value,
                        role_description: document.getElementById('preview-description').value
                    };
                    
                    const response = await fetch('/api/roles', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(updatedDesign)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(`âœ… æˆåŠŸåˆ›å»ºè§’è‰²: ${data.display_name}`, 'æˆåŠŸ', 'success');
                        closeRoleDesigner();
                        
                        // åˆ·æ–°è§’è‰²åˆ—è¡¨ï¼ˆå¦‚æœåœ¨è§’è‰²ç®¡ç†é¡µé¢ï¼‰
                        if (typeof loadRoles === 'function') {
                            loadRoles();
                        }
                    } else {
                        showAlert('åˆ›å»ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    console.error('Failed to create role:', error);
                    showAlert('åˆ›å»ºå¤±è´¥: ' + error.message, 'é”™è¯¯', 'error');
                }
            }

            // --- ç¼–åˆ¶ç®¡ç†åŠŸèƒ½ ---

            function togglePresetsModal() {
                // åºŸå¼ƒå‡½æ•° - æ”¹ä¸ºopenPresetsTab
                openPresetsTab();
            }

            function openPresetsTab() {
                // æ‰“å¼€é«˜çº§é…ç½®modalå¹¶åˆ‡æ¢åˆ°ç¼–åˆ¶tab
                const modal = document.getElementById('advanced-config-modal');
                if (modal.classList.contains('hidden')) {
                    // é¦–å…ˆåŠ è½½å½“å‰é…ç½®åˆ°modal
                    document.getElementById('modal-backend-select').value = document.getElementById('backend-select').value || 'deepseek';
                    document.getElementById('modal-global-model-input').value = document.getElementById('global-model-input').value || '';
                    document.getElementById('modal-global-reasoning-input').value = document.getElementById('global-reasoning-input').value || '';
                    document.getElementById('modal-rounds-input').value = document.getElementById('rounds-input').value || '3';
                    document.getElementById('modal-planners-input').value = document.getElementById('planners-input').value || '2';
                    document.getElementById('modal-auditors-input').value = document.getElementById('auditors-input').value || '2';
                    
                    modal.classList.remove('hidden');
                }
                // åˆ‡æ¢åˆ°ç¼–åˆ¶tab
                switchAdvancedTab('presets');
            }

            function togglePresetsDropdown() {
                const dropdown = document.getElementById("presets-dropdown");
                dropdown.classList.toggle("show");
                if (dropdown.classList.contains("show")) {
                    loadPresets();
                }
            }

            async function loadPresets() {
                try {
                    const response = await fetch('/api/presets');
                    const data = await response.json();
                    
                    if (data.presets) {
                        renderPresetsList(data.presets);
                    }
                } catch (error) {
                    console.error('Failed to load presets:', error);
                }
            }

            function renderPresetsList(presets) {
                const dropdownContainer = document.getElementById('presets-list-container');
                
                if (!dropdownContainer) return;

                dropdownContainer.innerHTML = '';

                // APIè¿”å›çš„æ˜¯å¯¹è±¡æ ¼å¼ {name: config, ...}ï¼Œéœ€è¦è½¬æ¢ä¸ºæ•°ç»„
                const presetArray = Object.entries(presets || {});
                
                if (presetArray.length === 0) {
                    const emptyHtml = `<div class="text-center text-gray-400 py-4 text-xs">æš‚æ— å­˜æ¡£</div>`;
                    dropdownContainer.innerHTML = emptyHtml;
                    return;
                }

                for (const [name, config] of presetArray) {
                    
                    // æ¸²æŸ“ä¸‹æ‹‰èœå•é¡¹
                    const dropdownItem = document.createElement('button');
                    dropdownItem.onclick = () => { applyPreset(name); togglePresetsDropdown(); };
                    dropdownItem.className = 'w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition group border-b border-slate-100 last:border-0';
                    dropdownItem.innerHTML = `
                        <div class="font-bold text-slate-700 mb-1 truncate">${name}</div>
                        <div class="text-xs text-slate-500 group-hover:text-slate-600 flex items-center space-x-2">
                            <span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded text-[10px] border border-blue-100 font-medium">${config.backend || 'default'}</span>
                            <span class="bg-slate-100 px-1.5 py-0.5 rounded text-[10px] border border-slate-200">R${config.rounds || 3}</span>
                            <span class="flex items-center space-x-1">
                                <span title="ç­–è®ºå®¶">ğŸ§  ${config.planners || 2}</span>
                                <span class="text-slate-300">|</span>
                                <span title="ç›‘å¯Ÿå®˜">ğŸ‘ï¸ ${config.auditors || 2}</span>
                            </span>
                        </div>
                    `;
                    dropdownContainer.appendChild(dropdownItem);
                }
            }

            async function saveCurrentAsPreset() {
                // ä»ä¸‹æ‹‰èœå•è°ƒç”¨æ—¶ï¼Œæ²¡æœ‰è¾“å…¥æ¡†ï¼Œéœ€è¦å¼¹å‡ºprompt
                let name = prompt(t('msg_preset_name_empty'));
                if (!name || !name.trim()) return;
                
                name = name.trim();

                // æ”¶é›†å½“å‰é…ç½®ï¼ˆä»éšè—å­—æ®µè¯»å–ï¼‰
                const config = {
                    backend: document.getElementById('backend-select').value,
                    global_model: document.getElementById('global-model-input').value,
                    global_reasoning: document.getElementById('global-reasoning-input').value,
                    rounds: parseInt(document.getElementById('rounds-input').value),
                    planners: parseInt(document.getElementById('planners-input').value),
                    auditors: parseInt(document.getElementById('auditors-input').value),
                    agents: {}
                };

                // æ”¶é›† Agent é…ç½®
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    config.agents[agentId] = {
                        backend: select.value,
                        model: document.querySelector(`.agent-model[data-agent="${agentId}"]`).value,
                        reasoning: document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`).value
                    };
                });

                try {
                    const response = await fetch('/api/presets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, config })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert(t('msg_preset_saved'), t('title_success'));
                        loadPresets(); // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
                    } else {
                        showAlert(data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert(error.message, t('title_error'), 'error');
                }
            }

            async function deletePreset(name) {
                if (!confirm(t('confirm_delete_preset'))) return;

                try {
                    const response = await fetch(`/api/presets/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert(t('msg_preset_deleted'), t('title_success'));
                        loadPresets();
                    } else {
                        showAlert(data.message, t('title_error'), 'error');
                    }
                } catch (error) {
                    showAlert(error.message, t('title_error'), 'error');
                }
            }

            function applyPreset(name) {
                fetch('/api/presets')
                    .then(res => res.json())
                    .then(data => {
                        // APIè¿”å›çš„æ˜¯ {presets: {name: config, ...}} å¯¹è±¡ç»“æ„
                        const config = data.presets[name];
                        if (config) {
                            
                            document.getElementById('backend-select').value = config.backend || 'deepseek';
                            document.getElementById('global-model-input').value = config.global_model || '';
                            document.getElementById('global-reasoning-input').value = config.global_reasoning || '';
                            document.getElementById('rounds-input').value = config.rounds || 3;
                            document.getElementById('planners-input').value = config.planners || 2;
                            document.getElementById('auditors-input').value = config.auditors || 2;

                            document.getElementById('backend-select').dispatchEvent(new Event('change'));

                            if (config.agents) {
                                for (const [agentId, agentConfig] of Object.entries(config.agents)) {
                                    const backendSelect = document.querySelector(`.agent-backend[data-agent="${agentId}"]`);
                                    const modelInput = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                                    const reasoningSelect = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                                    
                                    if (backendSelect) {
                                        backendSelect.value = agentConfig.backend;
                                        backendSelect.dispatchEvent(new Event('change'));
                                    }
                                    if (modelInput) modelInput.value = agentConfig.model || '';
                                    if (reasoningSelect) reasoningSelect.value = agentConfig.reasoning || '';
                                }
                            }

                            showAlert(t('msg_preset_loaded'), t('title_success'));
                        } else {
                            showAlert('ç¼–åˆ¶ä¸å­˜åœ¨', t('title_error'), 'error');
                        }
                    })
                    .catch(error => {
                        showAlert(error.message, t('title_error'), 'error');
                    });
            }
        </script>
    </main>
    <footer class="fixed bottom-0 right-0 p-2 text-xs text-gray-400">
        v{{ version }}
    </footer>
</body>
</html>


