<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å…ƒè€é™¢ - å®æ—¶è®¨è®ºè§†å›¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        .role-leader { border-left: 4px solid #3b82f6; }
        .role-planner { border-left: 4px solid #10b981; }
        .role-auditor { border-left: 4px solid #f59e0b; }
        .role-reporter { border-left: 4px solid #8b5cf6; }
        .markdown-body h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .markdown-body h2 { font-size: 1.25rem; font-weight: bold; margin-top: 0.75rem; }
        .markdown-body p { margin-bottom: 0.5rem; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.875rem; }
        .markdown-body th, .markdown-body td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
        .markdown-body th { background-color: #f8fafc; font-weight: bold; }
        .markdown-body tr:nth-child(even) { background-color: #f8fafc; }
        .markdown-body {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }
        .search-progress-card {
            margin: 0.75rem 0;
            transition: all 0.3s ease;
        }
        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.25rem 0.5rem;
            background-color: rgba(219, 234, 254, 0.5); /* bg-blue-100/50 */
            border-left: 2px solid #bfdbfe; /* border-blue-200 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-header:hover {
            background-color: rgba(191, 219, 254, 0.5); /* bg-blue-200/50 */
        }
        .search-header h5 {
            color: #1d4ed8; /* text-blue-700 */
            font-weight: 800;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
            display: flex;
            align-items: center;
        }
        .search-content {
            padding: 0.75rem;
            background-color: rgba(239, 246, 255, 0.4); /* bg-blue-50/40 */
            border-left: 2px solid #bfdbfe; /* border-blue-200 */
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            font-size: 13px;
            line-height: 1.6;
            color: #475569; /* text-slate-600 */
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin: 0;
            border-bottom: none;
            overflow: hidden;
        }
        .event-reasoning {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            max-height: 300px;
            overflow-y: auto;
        }
        .event-reasoning.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            opacity: 0;
            border: none;
            overflow: hidden;
        }

        .discussion-card {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .event-content, .event-reasoning {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .event-reasoning::-webkit-scrollbar,
        .search-content::-webkit-scrollbar {
            width: 4px;
        }
        .event-reasoning::-webkit-scrollbar-track,
        .search-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .event-reasoning::-webkit-scrollbar-thumb,
        .search-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .event-reasoning::-webkit-scrollbar-thumb:hover,
        .search-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <nav class="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="px-4 flex justify-between items-center">
            <h1 class="text-3xl font-black tracking-tighter">ğŸ›ï¸ AI å…ƒè€é™¢ <span class="text-lg font-normal text-slate-400 ml-3 tracking-normal">å®æ—¶ç›‘æ§é¢æ¿</span></h1>
            <div class="flex items-center space-x-4">
                <div id="status-indicator" class="flex items-center space-x-3 bg-slate-700/50 px-4 py-2 rounded-full border border-slate-600">
                    <span id="status-dot" class="w-3 h-3 bg-gray-500 rounded-full"></span>
                    <span id="status-text" class="text-base">å°±ç»ª</span>
                </div>
                <button onclick="toggleLogs()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 transition group" title="åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
                <button onclick="toggleSettingsModal()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 transition group" title="ç³»ç»Ÿè®¾ç½®">
                    <svg class="w-5 h-5 text-slate-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto py-4 px-4 max-w-[98vw] h-[calc(100vh-80px)] flex flex-col">
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4 border border-slate-200 flex-shrink-0">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">è®®é¢˜å†…å®¹</label>
                    <textarea id="issue-input" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦è®¨è®ºçš„è®®é¢˜ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰..." rows="1"
                           class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-base resize-none min-h-[42px] max-h-48 overflow-y-auto"
                           oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                </div>
                <div class="w-full md:w-32">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">åç«¯</label>
                    <select id="backend-select" 
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base bg-white">
                        <option value="deepseek">DeepSeek</option>
                        <option value="openai">OpenAI</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="aliyun">Aliyun</option>
                        <option value="ollama">Ollama</option>
                    </select>
                </div>
                <div class="w-full md:w-48">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">å…¨å±€æ¨¡å‹ (å¯é€‰)</label>
                    <input type="text" id="global-model-input" placeholder="é»˜è®¤æ¨¡å‹"
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                </div>
                <div class="w-full md:w-32 hidden" id="global-reasoning-container">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">æ¨ç†å¼ºåº¦</label>
                    <select id="global-reasoning-input" 
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base bg-white">
                        <option value="">å…³é—­</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="w-full md:w-20">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">è½®æ•°</label>
                    <input type="number" id="rounds-input" value="3" min="1" max="10" 
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                </div>
                <div class="w-full md:w-20">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">ç­–è®ºå®¶</label>
                    <input type="number" id="planners-input" value="2" min="1" max="5" 
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                </div>
                <div class="w-full md:w-20">
                    <label class="block text-sm font-bold text-slate-500 uppercase mb-1">ç›‘å¯Ÿå®˜</label>
                    <input type="number" id="auditors-input" value="2" min="1" max="5" 
                           class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-base">
                </div>
                <div class="flex items-end space-x-2">
                    <button id="start-btn" onclick="startDiscussion()" 
                            class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg transition shadow-lg shadow-blue-200 disabled:bg-gray-400 disabled:shadow-none">
                        å¼€å§‹è®®äº‹
                    </button>
                    <button id="advanced-toggle-btn" onclick="toggleAdvancedSettings()" 
                            class="w-full md:w-auto bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition border border-slate-300">
                        âš™ï¸ é«˜çº§é…ç½®
                    </button>
                    <button id="history-btn" onclick="toggleHistoryModal()" 
                            class="w-full md:w-auto bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition border border-slate-300">
                        ğŸ“œ å†å²
                    </button>
                    <button id="stop-btn" onclick="stopDiscussion()" 
                            class="hidden w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-lg transition shadow-lg shadow-red-200">
                        åœæ­¢
                    </button>
                </div>
            </div>

            <!-- é«˜çº§é…ç½®é¢æ¿ -->
            <div id="advanced-settings" class="hidden mt-4 pt-4 border-t border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center">
                        <span class="mr-2">âš™ï¸</span> å¸­ä½ä¸“å®¶é…ç½®
                    </h3>
                    <button onclick="resetAgentConfigs()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">é‡ç½®ä¸ºé»˜è®¤</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="agent-configs-container">
                    <!-- åŠ¨æ€ç”Ÿæˆ Agent é…ç½® -->
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>è®®é•¿ (Leader)
                        </h4>
                        <div class="flex gap-2">
                            <select class="agent-backend flex-1 text-xs p-1 border rounded" data-agent="leader">
                                <option value="default">é»˜è®¤åç«¯</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="openai">OpenAI</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="aliyun">Aliyun</option>
                                <option value="ollama">Ollama</option>
                            </select>
                            <input type="text" class="agent-model flex-1 text-xs p-1 border rounded" placeholder="æ¨¡å‹åç§° (å¯é€‰)" data-agent="leader">
                        </div>
                        <select class="agent-reasoning hidden text-[10px] p-1 border rounded mt-1 w-full" data-agent="leader">
                            <option value="">æ¨ç†: å…³é—­</option>
                            <option value="low">æ¨ç†: Low</option>
                            <option value="medium">æ¨ç†: Medium</option>
                            <option value="high">æ¨ç†: High</option>
                        </select>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center">
                            <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>è®°å½•å‘˜ (Reporter)
                        </h4>
                        <div class="flex gap-2">
                            <select class="agent-backend flex-1 text-xs p-1 border rounded" data-agent="reporter">
                                <option value="default">é»˜è®¤åç«¯</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="openai">OpenAI</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="aliyun">Aliyun</option>
                                <option value="ollama">Ollama</option>
                            </select>
                            <input type="text" class="agent-model flex-1 text-xs p-1 border rounded" placeholder="æ¨¡å‹åç§° (å¯é€‰)" data-agent="reporter">
                        </div>
                        <select class="agent-reasoning hidden text-[10px] p-1 border rounded mt-1 w-full" data-agent="reporter">
                            <option value="">æ¨ç†: å…³é—­</option>
                            <option value="low">æ¨ç†: Low</option>
                            <option value="medium">æ¨ç†: Medium</option>
                            <option value="high">æ¨ç†: High</option>
                        </select>
                    </div>
                </div>
                <datalist id="openrouter-models-list"></datalist>
                <datalist id="deepseek-models-list"></datalist>
            </div>
        </div>

        <div id="main-layout" class="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
            <!-- å·¦ä¾§è®¨è®ºæµ -->
            <div id="discussion-section" class="flex flex-col min-h-0 transition-all duration-300 flex-1">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col flex-1 min-h-0 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700 flex items-center text-base">
                                <span class="mr-2">ğŸ’¬</span> è®®äº‹è¿‡ç¨‹
                            </h3>
                            <span id="progress-percentage" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-1.5 overflow-hidden">
                            <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all duration-500 ease-out"></div>
                        </div>
                    </div>
                    <div id="discussion-container" class="p-4 overflow-y-auto flex-1 space-y-4 bg-gray-50/50">
                        <div id="discussion-flow" class="space-y-4">
                            <!-- åŠ¨æ€æ’å…¥å†…å®¹ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´æœ€ç»ˆæŠ¥å‘Š -->
            <div id="report-section" class="flex flex-col min-h-0 transition-all duration-300 flex-[2]">
                <div class="bg-white rounded-xl shadow-lg border border-purple-200 flex flex-col flex-1 min-h-0 overflow-hidden">
                    <div class="bg-purple-600 text-white px-4 py-3 flex justify-between items-center">
                        <h3 class="font-bold flex items-center text-base">
                            <span class="mr-2">ğŸ“œ</span> æœ€ç»ˆè®®äº‹æŠ¥å‘Š
                        </h3>
                        <div id="report-actions" class="flex space-x-2">
                            <button onclick="reReport()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">é‡æ–°ç”ŸæˆæŠ¥å‘Š</button>
                            <button onclick="copyReport()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">å¤åˆ¶</button>
                            <button onclick="downloadReport()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹è½½HTML</button>
                            <button onclick="downloadImage(event)" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹è½½å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div id="report-container" class="relative flex-1 min-h-0 overflow-hidden">
                        <iframe id="report-iframe" class="w-full h-full border-none" srcdoc="<div style='color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;'></div>"></iframe>
                        <!-- æŠ¥å‘Šç”Ÿæˆé®ç½©å±‚ -->
                        <div id="report-loader" class="hidden absolute inset-0 bg-white/70 backdrop-blur-[1px] flex flex-col items-center justify-center z-10">
                            <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
                            <p id="loader-text" class="text-purple-700 font-bold animate-pulse text-base">æ­£åœ¨è¿›è¡Œè®®äº‹è®¨è®º...</p>
                            <p id="loader-subtext" class="text-slate-400 text-sm mt-2">å…ƒè€ä»¬æ­£åœ¨æ¿€çƒˆè¾©è®ºä¸­</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ—¥å¿—çª—å£ -->
            <div id="log-section" class="hidden flex flex-col min-h-0 transition-all duration-300 flex-1">
                <div class="bg-slate-900 rounded-xl shadow-lg overflow-hidden flex flex-col flex-1 min-h-0">
                    <div class="bg-slate-800 px-4 py-3 flex justify-between items-center border-b border-slate-700">
                        <h3 class="text-slate-300 text-sm font-bold flex items-center">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                            ç³»ç»Ÿæ‰§è¡Œæ—¥å¿—
                        </h3>
                        <button onclick="clearLogs()" class="text-xs text-slate-500 hover:text-slate-300">æ¸…é™¤</button>
                    </div>
                    <div id="log-container" class="p-3 font-mono text-[13px] text-slate-400 overflow-y-auto flex-1 space-y-1">
                        <!-- æ—¥å¿—å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
        <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[120] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full mx-4 flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">è®®äº‹å†å²è®°å½•</h3>
                    <button onclick="toggleHistoryModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="history-list" class="overflow-y-auto flex-1 space-y-2 pr-2">
                    <!-- å†å²é¡¹åŠ¨æ€æ’å…¥ -->
                    <div class="text-center py-8 text-slate-400 italic">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>
                </div>
                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                    <button onclick="toggleHistoryModal()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- é€šç”¨ç¡®è®¤æ¨¡æ€æ¡† -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                <div class="text-center">
                    <div id="confirm-icon" class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-2">ç¡®è®¤</h3>
                    <p id="confirm-message" class="text-slate-600 mb-8 text-base"></p>
                    <div class="flex space-x-4">
                        <button id="confirm-cancel-btn" class="flex-1 px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                            å–æ¶ˆ
                        </button>
                        <button id="confirm-ok-btn" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200">
                            ç¡®è®¤
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æç¤ºæ¨¡æ€æ¡† -->
        <div id="alert-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
                <div class="text-center">
                    <div id="alert-icon" class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 id="alert-title" class="text-xl font-bold text-slate-800 mb-2">æç¤º</h3>
                    <p id="alert-message" class="text-slate-600 mb-8 text-base"></p>
                    <div class="flex">
                        <button onclick="closeAlertModal()" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿè®¾ç½®æ¨¡æ€æ¡† -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-xl w-full mx-4 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="mr-2 text-2xl">âš™ï¸</span> ç³»ç»Ÿå…¨å±€è®¾ç½®
                    </h3>
                    <button onclick="toggleSettingsModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div class="space-y-6 overflow-y-auto max-h-[60vh] pr-2">
                    <section>
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center">
                            <span class="w-1.5 h-4 bg-blue-500 rounded-full mr-2"></span> API å¯†é’¥é…ç½®
                        </h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">DeepSeek API Key</label>
                                <input type="password" id="settings-key-deepseek" placeholder="sk-..." 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">OpenAI API Key</label>
                                <input type="password" id="settings-key-openai" placeholder="sk-..." 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">OpenRouter API Key</label>
                                <input type="password" id="settings-key-openrouter" placeholder="sk-or-..." 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Aliyun API Key</label>
                                <input type="password" id="settings-key-aliyun" placeholder="sk-..." 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-500 uppercase">æœç´¢å¢å¼ºå¼•æ“ (å¯å¤šé€‰)</label>
                                <div id="settings-search-providers" class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center space-x-2 p-2 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition">
                                        <input type="checkbox" value="bing" class="search-provider-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Bing (ç¨³å®š)</span>
                                    </label>
                                    <label class="flex items-center space-x-2 p-2 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition">
                                        <input type="checkbox" value="baidu" class="search-provider-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Baidu (ä¸­æ–‡)</span>
                                    </label>
                                    <label class="flex items-center space-x-2 p-2 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition">
                                        <input type="checkbox" value="duckduckgo" class="search-provider-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">DuckDuckGo</span>
                                    </label>
                                    <label class="flex items-center space-x-2 p-2 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer transition">
                                        <input type="checkbox" value="tavily" class="search-provider-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Tavily (Key)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Tavily API Key</label>
                                <input type="password" id="settings-key-tavily" placeholder="tvly-..." 
                                       class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition">
                            </div>
                        </div>
                    </section>
                </div>

                <div class="mt-8 pt-4 border-t border-slate-100 flex justify-end space-x-3">
                    <button onclick="toggleSettingsModal()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                        å–æ¶ˆ
                    </button>
                    <button onclick="saveSettings()" class="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition shadow-lg shadow-blue-200">
                        ä¿å­˜å¹¶åº”ç”¨
                    </button>
                </div>
            </div>
        </div>

        <script>
            function toggleReportLoading(isLoading, text = '', subtext = '') {
                const loader = document.getElementById('report-loader');
                const loaderText = document.getElementById('loader-text');
                const loaderSubtext = document.getElementById('loader-subtext');
                const actionButtons = document.querySelectorAll('#report-actions button');

                if (isLoading) {
                    loader.classList.remove('hidden');
                    if (text) loaderText.innerText = text;
                    if (subtext) loaderSubtext.innerText = subtext;
                    actionButtons.forEach(btn => btn.disabled = true);
                } else {
                    loader.classList.add('hidden');
                    actionButtons.forEach(btn => btn.disabled = false);
                }
            }

            // é…ç½® marked
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            let lastEventCount = 0;
            let lastLogCount = 0;
            let currentProgress = 0;
            let isRunning = false;
            let openRouterModelsFetched = false;
            let isFetchingModels = false;
            const flowContainer = document.getElementById('discussion-flow');
            const discussionContainer = document.getElementById('discussion-container');
            const logContainer = document.getElementById('log-container');
            const reportIframe = document.getElementById('report-iframe');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            async function startDiscussion() {
                if (isRunning) return;
                
                const issue = document.getElementById('issue-input').value.trim();
                const backend = document.getElementById('backend-select').value;
                const model = document.getElementById('global-model-input').value;
                const reasoningEffort = document.getElementById('global-reasoning-input').value;
                const rounds = document.getElementById('rounds-input').value;
                const planners = document.getElementById('planners-input').value;
                const auditors = document.getElementById('auditors-input').value;

                // æ”¶é›† Agent é…ç½®
                const agentConfigs = {};
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    const agentBackend = select.value;
                    const modelEl = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    const reasoningEl = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                    
                    const agentModel = modelEl ? modelEl.value.trim() : '';
                    const agentReasoning = reasoningEl ? reasoningEl.value : '';
                    
                    if (agentBackend !== 'default' || agentModel !== '' || agentReasoning !== '') {
                        agentConfigs[agentId] = {
                            type: agentBackend === 'default' ? backend : agentBackend,
                            model: agentModel || undefined,
                            reasoning: agentReasoning ? { effort: agentReasoning } : undefined
                        };
                    }
                });

                if (!issue) {
                    showAlert('è¯·è¾“å…¥è®®é¢˜å†…å®¹', 'æç¤º');
                    return;
                }

                // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
                const issueInput = document.getElementById('issue-input');
                issueInput.style.height = 'auto';

                // æ¸…ç©ºæ—§å†…å®¹å¹¶æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
                flowContainer.innerHTML = '<div class="flex justify-center my-4 animate-pulse"><span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-medium">æ­£åœ¨åˆå§‹åŒ–è®®äº‹å…...</span></div>';
                logContainer.innerHTML = '<div class="text-slate-500 italic">æ­£åœ¨è¿æ¥åç«¯å¼•æ“...</div>';
                if (reportIframe) {
                    reportIframe.srcdoc = '<div style="color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;"></div>';
                }
                lastEventCount = 0;
                lastLogCount = 0;
                currentProgress = 0;
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-percentage').innerText = '0%';

                try {
                    const response = await fetch('/api/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            issue, 
                            backend, 
                            model: model || undefined,
                            reasoning: reasoningEffort ? { effort: reasoningEffort } : undefined,
                            rounds, 
                            planners, 
                            auditors,
                            agent_configs: Object.keys(agentConfigs).length > 0 ? agentConfigs : null
                        })
                    });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        console.log('è®¨è®ºå·²å¯åŠ¨');
                    } else {
                        showAlert('å¯åŠ¨å¤±è´¥: ' + data.message, 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    console.error('Start error:', error);
                    showAlert('å¯åŠ¨è¯·æ±‚å‘é€å¤±è´¥', 'é”™è¯¯', 'error');
                }
            }

            async function reReport() {
                if (isRunning) return;
                
                const backend = document.getElementById('backend-select').value;
                toggleReportLoading(true, 'æ­£åœ¨é‡æ–°ç”ŸæˆæŠ¥å‘Š...', `æ­£åœ¨ä½¿ç”¨ ${backend} é‡æ–°æ’°å†™æŠ¥å‘Š`);
                
                try {
                    const response = await fetch('/api/rereport', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ backend: backend })
                    });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        console.log('é‡æ–°ç”ŸæˆæŠ¥å‘Šè¯·æ±‚å·²å‘é€');
                    } else {
                        showAlert('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + data.message, 'é”™è¯¯', 'error');
                        toggleReportLoading(false);
                    }
                } catch (error) {
                    console.error('Re-report error:', error);
                    showAlert('é‡æ–°ç”Ÿæˆè¯·æ±‚å‘é€å¤±è´¥', 'é”™è¯¯', 'error');
                    toggleReportLoading(false);
                }
            }

            async function fetchUpdates() {
                try {
                    // æ£€æŸ¥çŠ¶æ€
                    const statusResponse = await fetch('/api/status');
                    const statusData = await statusResponse.json();
                    updateStatusUI(statusData);

                    const response = await fetch('/api/events');
                    const data = await response.json();

                    // æ›´æ–°è®¨è®ºæµ
                    if (data.events.length > lastEventCount) {
                        // æ£€æŸ¥æ˜¯å¦åœ¨åº•éƒ¨ (å…è®¸ 50px è¯¯å·®)
                        const isAtBottom = discussionContainer.scrollHeight - discussionContainer.scrollTop <= discussionContainer.clientHeight + 50;
                        
                        for (let i = lastEventCount; i < data.events.length; i++) {
                            appendEvent(data.events[i]);
                            updateProgress(data.events[i]);
                        }
                        lastEventCount = data.events.length;
                        
                        if (isAtBottom) {
                            discussionContainer.scrollTo({
                                top: discussionContainer.scrollHeight,
                                behavior: 'smooth'
                            });
                        }
                    }

                    // æ›´æ–°æ—¥å¿—
                    if (data.logs) {
                        // å¦‚æœåç«¯æ—¥å¿—é•¿åº¦å‡å°‘ï¼Œè¯´æ˜å¯èƒ½è¢«é‡ç½®æˆ–è½®è½¬äº†
                        if (data.logs.length < lastLogCount) {
                            lastLogCount = 0;
                            logContainer.innerHTML = '';
                        }

                        if (data.logs.length > lastLogCount) {
                            const isAtBottom = logContainer.scrollHeight - logContainer.scrollTop <= logContainer.clientHeight + 50;
                            
                            for (let i = lastLogCount; i < data.logs.length; i++) {
                                appendLog(data.logs[i]);
                            }
                            lastLogCount = data.logs.length;
                            
                            if (isAtBottom) {
                                logContainer.scrollTop = logContainer.scrollHeight;
                            }
                        }
                    }

                    // æ›´æ–°æœ€ç»ˆæŠ¥å‘Š
                    if (data.final_report) {
                        if (reportIframe && reportIframe.srcdoc !== data.final_report) {
                            reportIframe.srcdoc = data.final_report;
                            // åªè¦å¼€å§‹æœ‰æŠ¥å‘Šå†…å®¹ï¼Œå°±éšè—åŠ è½½é®ç½©
                            toggleReportLoading(false);
                        }
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                }
            }

            async function stopDiscussion() {
                const confirmed = await showConfirm('åœæ­¢åï¼Œå½“å‰çš„è®¨è®ºè¿›åº¦å°†ä¼šä¸¢å¤±ï¼Œä¸”æ— æ³•ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚', 'ç¡®è®¤åœæ­¢è®®äº‹ï¼Ÿ');
                if (confirmed) {
                    try {
                        const response = await fetch('/api/stop', { method: 'POST' });
                        const data = await response.json();
                        if (data.status === 'ok') {
                            console.log('å·²å‘é€åœæ­¢è¯·æ±‚');
                        } else {
                            showAlert('åœæ­¢å¤±è´¥: ' + data.message, 'é”™è¯¯', 'error');
                        }
                    } catch (error) {
                        console.error('Stop error:', error);
                        showAlert('åœæ­¢è¯·æ±‚å‘é€å¤±è´¥', 'é”™è¯¯', 'error');
                    }
                }
            }

            function showAlert(message, title = 'æç¤º', type = 'info') {
                const modal = document.getElementById('alert-modal');
                const titleEl = document.getElementById('alert-title');
                const messageEl = document.getElementById('alert-message');
                const iconEl = document.getElementById('alert-icon');
                
                titleEl.innerText = title;
                messageEl.innerText = message;
                
                // è®¾ç½®å›¾æ ‡å’Œé¢œè‰²
                if (type === 'error') {
                    iconEl.className = 'w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4';
                    iconEl.innerHTML = '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                } else {
                    iconEl.className = 'w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4';
                    iconEl.innerHTML = '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }
                
                modal.classList.remove('hidden');
            }

            function closeAlertModal() {
                document.getElementById('alert-modal').classList.add('hidden');
            }

            function showConfirm(message, title = 'ç¡®è®¤') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirm-modal');
                    const titleEl = document.getElementById('confirm-title');
                    const messageEl = document.getElementById('confirm-message');
                    const okBtn = document.getElementById('confirm-ok-btn');
                    const cancelBtn = document.getElementById('confirm-cancel-btn');
                    
                    titleEl.innerText = title;
                    messageEl.innerText = message;
                    
                    const handleOk = () => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(true);
                    };
                    
                    const handleCancel = () => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        okBtn.removeEventListener('click', handleOk);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    okBtn.addEventListener('click', handleOk);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    modal.classList.remove('hidden');
                });
            }

            function updateStatusUI(statusData) {
                const running = statusData.is_running;
                const config = statusData.config;
                isRunning = running;
                const reportLoader = document.getElementById('report-loader');
                const loaderText = document.getElementById('loader-text');
                const loaderSubtext = document.getElementById('loader-subtext');
                
                // å¦‚æœæ­£åœ¨è¿è¡Œä¸”è¾“å…¥æ¡†ä¸ºç©ºï¼ˆè¯´æ˜æ˜¯åˆ·æ–°é¡µé¢ï¼‰ï¼Œåˆ™å¡«å……é…ç½®
                if (running && config) {
                    const issueInput = document.getElementById('issue-input');
                    if (!issueInput.value.trim()) {
                        issueInput.value = config.issue || '';
                        document.getElementById('backend-select').value = config.backend || 'deepseek';
                        document.getElementById('rounds-input').value = config.rounds || 3;
                        document.getElementById('planners-input').value = config.planners || 2;
                        document.getElementById('auditors-input').value = config.auditors || 2;
                        // è§¦å‘é«˜åº¦è‡ªé€‚åº”
                        issueInput.style.height = '';
                        issueInput.style.height = issueInput.scrollHeight + 'px';
                    }
                }

                if (running) {
                    startBtn.disabled = true;
                    startBtn.innerText = 'è®®äº‹ä¸­...';
                    stopBtn.classList.remove('hidden');
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    statusText.innerText = 'æ­£åœ¨è®¨è®º';

                    // å¦‚æœæ˜¯åˆ·æ–°é¡µé¢ä¸”è¿˜æ²¡æœ‰åŠ è½½å‡ºäº‹ä»¶ï¼Œæ˜¾ç¤ºæ¢å¤çŠ¶æ€
                    if (lastEventCount === 0 && flowContainer.innerHTML.trim() === '') {
                        flowContainer.innerHTML = '<div class="flex justify-center my-4 animate-pulse"><span class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-medium">æ­£åœ¨æ¢å¤è®®äº‹è¿›åº¦...</span></div>';
                    }

                    // æ˜¾ç¤ºæŠ¥å‘ŠåŠ è½½é®ç½©ï¼Œåˆå§‹è®¾ä¸ºè®¨è®ºçŠ¶æ€
                    // ä¿®å¤é—ªçƒï¼šå¦‚æœå·²ç»æœ‰æŠ¥å‘Šå†…å®¹åœ¨æ˜¾ç¤ºï¼Œåˆ™ä¸å†å¼ºåˆ¶æ˜¾ç¤ºè’™ç‰ˆ
                    if (reportLoader && (!reportIframe.srcdoc || reportIframe.srcdoc.includes('italic'))) {
                        const currentText = loaderText.innerText;
                        let targetText = 'æ­£åœ¨è¿›è¡Œè®®äº‹è®¨è®º...';
                        let targetSub = 'å…ƒè€ä»¬æ­£åœ¨æ¿€çƒˆè¾©è®ºä¸­';
                        
                        if (currentText.includes('æŠ¥å‘Š') || currentText.includes('æ’°å†™')) {
                            targetText = currentText;
                            targetSub = loaderSubtext.innerText;
                        }
                        toggleReportLoading(true, targetText, targetSub);
                    }
                } else {
                    startBtn.disabled = false;
                    startBtn.innerText = 'å¼€å§‹è®®äº‹';
                    stopBtn.classList.add('hidden');
                    statusDot.className = 'w-3 h-3 bg-blue-500 rounded-full';
                    statusText.innerText = 'å°±ç»ª';
                    // éšè—æŠ¥å‘ŠåŠ è½½é®ç½©
                    if (reportLoader) reportLoader.classList.add('hidden');
                }
            }

            let currentRound = 1;

            function updateProgress(event) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-percentage');
                const maxRounds = parseInt(document.getElementById('rounds-input').value) || 3;
                
                let targetProgress = currentProgress;

                if (event.type === 'system_start') {
                    targetProgress = 5;
                    currentRound = 1;
                } else if (event.type === 'round_start') {
                    currentRound = event.round;
                    targetProgress = 5 + ((currentRound - 1) / maxRounds) * 85;
                } else if (event.type === 'agent_action') {
                    const roundWeight = 85 / maxRounds;
                    const roundBase = 5 + ((currentRound - 1) / maxRounds) * 85;

                    if (event.role_type === 'Leader') {
                        if (currentProgress < 10) {
                            targetProgress = 10;
                        } else {
                            // æ±‡æ€»é˜¶æ®µ
                            targetProgress = Math.max(targetProgress, roundBase + roundWeight * 0.9);
                        }
                    } else if (event.role_type === 'Planner') {
                        targetProgress = Math.max(targetProgress, roundBase + roundWeight * 0.3);
                    } else if (event.role_type === 'Auditor') {
                        targetProgress = Math.max(targetProgress, roundBase + roundWeight * 0.6);
                    } else if (event.role_type === 'Reporter') {
                        targetProgress = 98;
                    }
                } else if (event.type === 'final_report') {
                    targetProgress = 100;
                }

                // ç¡®ä¿è¿›åº¦ä¸ä¼šè¶…è¿‡ 100% æˆ–å‡ºç°å¼‚å¸¸å€¼
                targetProgress = Math.min(100, Math.max(0, targetProgress));

                if (targetProgress > currentProgress) {
                    currentProgress = targetProgress;
                    progressBar.style.width = `${currentProgress}%`;
                    progressText.innerText = `${Math.round(currentProgress)}%`;
                }
            }

            function appendEvent(event) {
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªäº‹ä»¶ï¼Œä¸”å®¹å™¨å†…åªæœ‰åˆå§‹åŒ–æ¶ˆæ¯ï¼Œåˆ™æ¸…ç©º
                if (lastEventCount === 0 && flowContainer.querySelector('.animate-pulse')) {
                    flowContainer.innerHTML = '';
                }

                if (event.chunk_id) {
                    let existing = document.getElementById(`event-${event.chunk_id}`);
                    if (existing) {
                        const contentDiv = existing.querySelector('.event-content');
                        const reasoningDiv = existing.querySelector('.event-reasoning');
                        
                        if (event.reasoning && reasoningDiv) {
                            reasoningDiv.textContent += event.reasoning;
                            // å®æ—¶æ¸…ç†å¼€å¤´çš„ç©ºè¡Œå’Œç©ºæ ¼
                            const trimmed = reasoningDiv.textContent.replace(/^\s+/, '');
                            if (reasoningDiv.textContent !== trimmed) {
                                reasoningDiv.textContent = trimmed;
                            }
                            reasoningDiv.closest('.reasoning-wrapper').classList.remove('hidden');
                        }
                        if (event.content && contentDiv) {
                            const oldRaw = contentDiv.dataset.raw || "";
                            const newRaw = oldRaw + event.content;
                            
                            // 1. è‡ªåŠ¨æ”¶ç¼©æ¨ç† (Reasoning)
                            // å¦‚æœæ¨ç†éƒ¨åˆ†è¿˜æ²¡æ”¶ç¼©ï¼Œä¸”ç°åœ¨å¼€å§‹è¾“å‡ºæ­£å¼å†…å®¹ï¼ˆéç©ºä¸”ä¸æ˜¯æœç´¢æ ‡è®°ï¼‰ï¼Œåˆ™æ”¶ç¼©å®ƒ
                            if (reasoningDiv && !reasoningDiv.classList.contains('collapsed')) {
                                if (event.content.trim() && !event.content.includes('SEARCH PROGRESS')) {
                                    const header = reasoningDiv.closest('.reasoning-wrapper').querySelector('.cursor-pointer');
                                    if (header) toggleReasoning(header);
                                }
                            }

                            // 2. è‡ªåŠ¨æ”¶ç¼©æœç´¢ (Search)
                            // å¦‚æœå½“å‰å†…å®¹åŒ…å« SEARCH PROGRESSï¼Œä¸”å·²ç»æ˜¾ç¤ºäº†ç»“æŸæ ‡è®°ï¼Œåˆ™æ”¶ç¼©
                            if (newRaw.includes('é‡æ–°ç”Ÿæˆæœ€ç»ˆæ–¹æ¡ˆ')) {
                                const hasEndMarker = newRaw.includes('æœç´¢å®Œæˆ') || 
                                                   newRaw.includes('æœç´¢å·²å®Œæˆ') || 
                                                   newRaw.includes('é‡æ–°ç”Ÿæˆæœ€ç»ˆæ–¹æ¡ˆ');
                                
                                if (hasEndMarker) {
                                    const searchCard = existing.querySelector('.search-progress-card');
                                    if (searchCard) {
                                        const searchContent = searchCard.querySelector('.search-content');
                                        // åªæœ‰å½“æ–°å†…å®¹ä¸æ˜¯æœç´¢æ ‡è®°æœ¬èº«æ—¶ï¼ˆå³å¼€å§‹è¾“å‡ºçœŸæ­£çš„æ–¹æ¡ˆæ—¶ï¼‰ï¼Œæ‰æ”¶ç¼©
                                        // æˆ–è€…å¦‚æœå·²ç»æœ‰äº†ç»“æŸæ ‡è®°ä¸”å½“å‰å¡ç‰‡è¿˜æ˜¯å±•å¼€çŠ¶æ€
                                        if (!searchContent.classList.contains('collapsed')) {
                                            const header = searchCard.querySelector('.cursor-pointer');
                                            if (header) toggleSearchCard(header);
                                        }
                                    }
                                }
                            }

                            contentDiv.dataset.raw = newRaw;
                            
                            let text = contentDiv.dataset.raw;
                            // å®æ—¶æ¸…ç† Markdown æ ‡ç­¾ (é’ˆå¯¹ JSON è¾“å‡º)
                            if (text.includes('```')) {
                                text = text.replace(/^(\s*```json\s*|\s*```\s*)/, '');
                                text = text.replace(/(\s*```\s*)$/, '');
                            }
                            
                            contentDiv.innerHTML = formatContent(text);
                        }
                        return;
                    }
                }

                const div = document.createElement('div');
                if (event.chunk_id) div.id = `event-${event.chunk_id}`;
                
                if (event.type === 'system_start') {
                    div.className = 'space-y-4 my-6';
                    div.innerHTML = `
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-5 shadow-xl border border-slate-700 text-white">
                            <div class="flex items-center mb-3">
                                <span class="text-xl mr-2">ğŸ¯</span>
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">å½“å‰è®®äº‹ä¸»é¢˜</h4>
                            </div>
                            <p class="text-lg font-medium leading-relaxed">${event.issue || 'æœªæŒ‡å®šè®®é¢˜'}</p>
                            <div class="mt-4 pt-4 border-t border-slate-700/50 flex justify-between items-center text-[10px] text-slate-500 uppercase tracking-widest">
                                <span>AICouncil Protocol v1.0</span>
                                <span>${new Date().toLocaleTimeString()}</span>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <span class="bg-slate-800 text-white px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-slate-200 border border-slate-700">System Startup</span>
                        </div>
                    `;
                } else if (event.type === 'round_start') {
                    div.className = 'flex justify-center my-4';
                    div.innerHTML = `<span class="bg-slate-200 text-slate-600 px-3 py-0.5 rounded-full text-xs font-bold uppercase">Round ${event.round}</span>`;
                } else if (event.type === 'final_report') {
                    // è¿›å…¥æŠ¥å‘Šç”Ÿæˆé˜¶æ®µï¼Œæ›´æ–°çŠ¶æ€æ–‡å­—
                    toggleReportLoading(true, 'ğŸ“œ è®®äº‹è¾¾æˆå…±è¯†ï¼Œæ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...', 'è¯·ç¨å€™ï¼Œæ­£åœ¨æ•´ç†å…ƒè€ä»¬çš„æ™ºæ…§ç»“æ™¶');
                    return; // æŠ¥å‘Šå†…å®¹ç”± handleFinalReport å¤„ç†
                } else if (event.type === 'agent_action') {
                    const roleClass = `role-${event.role_type.toLowerCase()}`;
                    const roleIcon = getIcon(event.role_type);
                    
                    // å¦‚æœæ˜¯è®°å½•å‘˜ï¼ˆReporterï¼‰å¼€å§‹è¡ŒåŠ¨ï¼Œæ›´æ–°æŠ¥å‘Šçª—å£çš„åŠ è½½æ–‡å­—
                    if (event.role_type === 'Reporter') {
                        toggleReportLoading(true, 'æ­£åœ¨æ’°å†™æœ€ç»ˆè®®äº‹æŠ¥å‘Š...', 'è¯·è€å¿ƒç­‰å¾…å…ƒè€é™¢è¾¾æˆå…±è¯†');
                    }

                    const hasReasoning = !!event.reasoning;
                    const reasoningContent = (event.reasoning || '').replace(/^\s+/, '');
                    const content = event.content || '';

                    div.className = `bg-white rounded-lg shadow-sm p-4 border-l-4 ${roleClass} text-base discussion-card`;
                    div.innerHTML = `
                        <div class="flex items-center mb-2">
                            <span class="text-xl mr-2">${roleIcon}</span>
                            <div>
                                <h4 class="font-bold text-slate-800 text-base">${event.agent_name}</h4>
                            </div>
                        </div>
                        <div class="reasoning-wrapper mb-2 ${hasReasoning ? '' : 'hidden'}">
                            <div class="flex items-center justify-between px-2 py-1 bg-amber-100/50 rounded-t-lg border-l-2 border-amber-200 cursor-pointer hover:bg-amber-200/50 transition-colors" onclick="toggleReasoning(this)">
                                <span class="text-[10px] text-amber-700 font-bold uppercase tracking-wider flex items-center">
                                    <span class="toggle-icon mr-1">â–¼</span> Thinking Process
                                </span>
                            </div>
                            <div class="event-reasoning p-3 bg-amber-50/40 border-l-2 border-amber-200 text-[13px] leading-relaxed text-slate-600 italic whitespace-pre-wrap relative rounded-b-lg">
                                ${reasoningContent}
                            </div>
                        </div>
                        <div class="text-slate-600 leading-relaxed text-base event-content markdown-body">${formatContent(content)}</div>
                    `;
                }
                
                flowContainer.appendChild(div);
            }

            function toggleReasoning(header) {
                const wrapper = header.closest('.reasoning-wrapper');
                const content = wrapper.querySelector('.event-reasoning');
                const icon = header.querySelector('.toggle-icon');
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }

            function toggleSearchCard(header) {
                const card = header.closest('.search-progress-card');
                const content = card.querySelector('.search-content');
                const icon = header.querySelector('.toggle-icon');
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = 'â–¼';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = 'â–¶';
                }
            }

            function getIcon(role) {
                const icons = {
                    'Leader': 'ğŸ‘¨â€âš–ï¸',
                    'Planner': 'ğŸ’¡',
                    'Auditor': 'ğŸ”',
                    'Reporter': 'ğŸ“'
                };
                return icons[role] || 'ğŸ‘¤';
            }

            function formatContent(content) {
                if (!content) return '';
                
                let text = content.trim();
                let prefix = '';
                let jsonData = null;

                // 1. å¯»æ‰¾ JSON çš„èµ·å§‹ä½ç½®
                // é€»è¾‘ï¼šä¼˜å…ˆå¯»æ‰¾ { (JSONå¯¹è±¡)ï¼Œæˆ–è€…å¯»æ‰¾ä¸å¸¦ SEARCH å…³é”®å­—çš„ [ (JSONæ•°ç»„)
                let jsonStartIndex = -1;
                
                // å¯»æ‰¾æœ€åä¸€ä¸ªæœç´¢ç›¸å…³çš„æ ‡è®°ï¼ŒJSON é€šå¸¸åœ¨è¿™äº›æ ‡è®°ä¹‹å
                const searchMarkers = ["é‡æ–°ç”Ÿæˆ", "æœç´¢å®Œæˆ", "æœç´¢å·²å®Œæˆ", "ç³»ç»Ÿæ­£åœ¨æœç´¢", "SEARCH PROGRESS"];
                let lastMarkerIndex = -1;
                searchMarkers.forEach(marker => {
                    const idx = text.lastIndexOf(marker);
                    if (idx !== -1 && idx + marker.length > lastMarkerIndex) {
                        lastMarkerIndex = idx + marker.length;
                    }
                });

                if (lastMarkerIndex !== -1) {
                    // åœ¨æœç´¢æ ‡è®°ä¹‹åå¯»æ‰¾ JSON
                    const afterMarker = text.substring(lastMarkerIndex);
                    const match = afterMarker.match(/\{|\[(?!\s*SEARCH)/);
                    if (match) {
                        jsonStartIndex = lastMarkerIndex + match.index;
                    }
                } else {
                    // æ²¡æœ‰æœç´¢æ ‡è®°ï¼Œç›´æ¥å¯»æ‰¾èµ·å§‹ç¬¦å·ï¼Œæ’é™¤ [SEARCH:
                    const match = text.match(/\{|\[(?!\s*SEARCH)/);
                    if (match) {
                        jsonStartIndex = match.index;
                    }
                }

                // 2. æå–å‰ç¼€å’Œå°è¯•è§£æ JSON
                if (jsonStartIndex !== -1) {
                    prefix = text.substring(0, jsonStartIndex).trim();
                    let potentialJson = text.substring(jsonStartIndex).trim();
                    
                    // æ¸…ç†æœ«å°¾çš„ Markdown é—­åˆæ ‡ç­¾
                    potentialJson = potentialJson.replace(/(\s*```\s*)$/, '');
                    
                    try {
                        jsonData = JSON.parse(potentialJson);
                    } catch (e) {
                        // æµå¼è¾“å‡ºä¸­ JSON å¯èƒ½ä¸å®Œæ•´ï¼Œè§£æå¤±è´¥æ˜¯æ­£å¸¸çš„
                    }
                } else if (text.includes('SEARCH PROGRESS')) {
                    // å¦‚æœæ²¡æœ‰ JSON ä½†æœ‰ SEARCH PROGRESSï¼Œæ•´ä¸ªå†…å®¹éƒ½è§†ä¸ºå‰ç¼€ï¼Œä»¥ä¾¿è§¦å‘å¡ç‰‡æ¸²æŸ“
                    prefix = text;
                }

                let html = '';
                if (prefix) {
                    // æ¸…ç† prefixï¼šç§»é™¤ [SEARCH: ...] æ ‡ç­¾å’Œé‡å¤çš„ SEARCH PROGRESS æ ‡é¢˜
                    let cleanPrefix = prefix.replace(/\[SEARCH:.*?\]/g, '').trim();
                    
                    let prefixHtml = marked.parse(cleanPrefix);
                    // æ£€æŸ¥æ˜¯å¦åŒ…å« SEARCH PROGRESSï¼Œå¦‚æœæ˜¯åˆ™åŒ…è£…æˆå¯æŠ˜å å¡ç‰‡
                    if (prefix.includes('SEARCH PROGRESS')) {
                        // ç§»é™¤æ‰€æœ‰ç”Ÿæˆçš„ <h3>SEARCH PROGRESS</h3> æ ‡ç­¾
                        prefixHtml = prefixHtml.replace(/<h3[^>]*>SEARCH PROGRESS<\/h3>/gi, '');
                        html += `
                            <div class="search-progress-card mb-2">
                                <div class="search-header" onclick="toggleSearchCard(this)">
                                    <h5>
                                        <span class="toggle-icon mr-1">â–¼</span>
                                        <span class="mr-1">ğŸŒ</span> SEARCH PROGRESS
                                    </h5>
                                    <span class="text-[10px] text-blue-400 uppercase font-bold tracking-widest">Details</span>
                                </div>
                                <div class="search-content markdown-body">
                                    ${prefixHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        html += `<div class="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 italic shadow-sm">${prefixHtml}</div>`;
                    }
                }

                if (jsonData) {
                    html += renderStructuredData(jsonData);
                } else {
                    // å¦‚æœæ²¡æœ‰è§£æå‡º JSONï¼Œæ¸²æŸ“å‰©ä½™éƒ¨åˆ†
                    const remainingText = jsonStartIndex !== -1 ? text.substring(jsonStartIndex) : text;
                    // å¦‚æœå·²ç»ä½œä¸º prefix æ¸²æŸ“è¿‡äº†ï¼ˆå³åŒ…å« SEARCH PROGRESS ä¸”æ²¡æœ‰ JSONï¼‰ï¼Œåˆ™ä¸å†é‡å¤æ¸²æŸ“
                    if (jsonStartIndex !== -1 || !text.includes('SEARCH PROGRESS')) {
                        html += marked.parse(remainingText);
                    }
                }

                return html;
            }

            function renderStructuredData(data) {
                let html = '<div class="space-y-4 mt-2">';

                // 1. ç›‘å¯Ÿå®˜è¯„è®º (Auditor Review)
                if (data.reviews && Array.isArray(data.reviews)) {
                    data.reviews.forEach(review => {
                        const ratingClass = {
                            'ä¼˜ç§€': 'bg-green-100 text-green-700',
                            'åˆæ ¼': 'bg-blue-100 text-blue-700',
                            'éœ€é‡æ„': 'bg-amber-100 text-amber-700',
                            'ä¸å¯è¡Œ': 'bg-red-100 text-red-700'
                        }[review.rating] || 'bg-slate-100 text-slate-700';

                        html += `
                            <div class="border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm">
                                <div class="bg-slate-50 px-3 py-2 border-b border-slate-200 flex justify-between items-center">
                                    <span class="font-bold text-slate-700 text-sm">ğŸ¯ é’ˆå¯¹: ${review.plan_id || 'æœªçŸ¥æ–¹æ¡ˆ'}</span>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${ratingClass}">${review.rating || 'æœªè¯„çº§'}</span>
                                </div>
                                <div class="p-3 space-y-3">
                                    <div>
                                        <div class="text-[11px] font-bold text-red-500 uppercase mb-1">âš ï¸ è´¨ç–‘ç‚¹</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600 space-y-1">
                                            ${(review.issues || []).map(i => `<li>${i}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <div class="text-[11px] font-bold text-green-600 uppercase mb-1">ğŸ’¡ æ”¹è¿›å»ºè®®</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600 space-y-1">
                                            ${(review.suggestions || []).map(s => `<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (data.summary) {
                        html += `
                            <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <div class="text-[11px] font-bold text-indigo-600 uppercase mb-1">ğŸ“ å®¡è®¡æ€»ç»“</div>
                                <div class="text-sm text-slate-700 leading-relaxed">${data.summary}</div>
                            </div>
                        `;
                    }
                }
                // 2. è®®é•¿æ‹†è§£ (Leader Decomposition)
                else if (data.decomposition) {
                    const d = data.decomposition;
                    html += `
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4">
                            <div>
                                <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">ğŸ¯ æ ¸å¿ƒç›®æ ‡</div>
                                <div class="text-base font-bold text-slate-800">${d.core_goal || 'æœªå®šä¹‰'}</div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">â“ å…³é”®é—®é¢˜</div>
                                    <ul class="list-decimal ml-4 text-sm text-slate-700 space-y-1">
                                        ${(d.key_questions || []).map(q => `<li>${q}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">ğŸš§ è®¨è®ºè¾¹ç•Œ</div>
                                    <div class="text-sm text-slate-700">${d.boundaries || 'æ— '}</div>
                                </div>
                            </div>
                            ${d.report_design ? `
                                <div>
                                    <div class="text-[11px] font-bold text-blue-600 uppercase mb-1">ğŸ“‹ æŠ¥å‘Šå¤§çº²è®¾è®¡</div>
                                    <div class="grid grid-cols-1 gap-2 mt-2">
                                        ${Object.entries(d.report_design).map(([name, desc]) => `
                                            <div class="bg-white/60 p-2 rounded border border-blue-200/50">
                                                <span class="font-bold text-slate-800 text-sm">${name}:</span>
                                                <span class="text-sm text-slate-600">${desc}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    if (data.instructions) {
                        html += `
                            <div class="bg-amber-50 p-3 rounded-lg border border-amber-100">
                                <div class="text-[11px] font-bold text-amber-600 uppercase mb-1">ğŸ“¢ æœ¬è½®æŒ‡ä»¤</div>
                                <div class="text-sm text-slate-700 font-medium">${data.instructions}</div>
                            </div>
                        `;
                    }
                }
                // 3. ç­–è®ºå®¶æ–¹æ¡ˆ (Planner Plan)
                else if (data.core_idea || data.steps) {
                    html += `
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 space-y-4">
                            <div>
                                <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">ğŸ’¡ æ ¸å¿ƒæ€è·¯</div>
                                <div class="text-base font-bold text-slate-800">${data.core_idea || 'æœªå®šä¹‰'}</div>
                            </div>
                            <div>
                                <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">ğŸš€ æ‰§è¡Œæ­¥éª¤</div>
                                <div class="space-y-2 mt-2">
                                    ${(data.steps || []).map((step, i) => `
                                        <div class="flex items-start">
                                            <span class="bg-emerald-200 text-emerald-700 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold mr-2 mt-0.5 flex-shrink-0">${i+1}</span>
                                            <span class="text-sm text-slate-700">${step}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ${data.feasibility ? `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2 border-t border-emerald-200/50">
                                    <div>
                                        <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">âœ… ä¼˜åŠ¿</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600">
                                            ${(data.feasibility.advantages || []).map(a => `<li>${a}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <div class="text-[11px] font-bold text-emerald-600 uppercase mb-1">ğŸ› ï¸ èµ„æºéœ€æ±‚</div>
                                        <ul class="list-disc ml-4 text-sm text-slate-600">
                                            ${(data.feasibility.requirements || []).map(r => `<li>${r}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                // 4. é€šç”¨ JSON å±•ç¤º (Tree-like)
                else {
                    html += `<pre class="bg-slate-50 p-3 rounded-lg text-xs overflow-x-auto border border-slate-200 text-slate-600"><code>${JSON.stringify(data, null, 2)}</code></pre>`;
                }

                html += '</div>';
                return html;
            }

            function appendLog(logText) {
                const p = document.createElement('p');
                p.className = 'break-all border-b border-slate-800 pb-1 last:border-0';
                if (logText.includes('ERROR')) p.classList.add('text-red-400');
                else if (logText.includes('WARNING')) p.classList.add('text-yellow-400');
                else if (logText.includes('INFO')) p.classList.add('text-blue-300');
                p.textContent = logText;
                logContainer.appendChild(p);
            }

            function clearLogs() {
                logContainer.innerHTML = '';
                lastLogCount = 0;
            }

            function copyReport() {
                if (reportIframe && reportIframe.contentDocument) {
                    const text = reportIframe.contentDocument.body.innerText;
                    navigator.clipboard.writeText(text).then(() => showAlert('æŠ¥å‘Šå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'æˆåŠŸ'));
                }
            }

            function downloadReport() {
                if (reportIframe && reportIframe.srcdoc) {
                    const blob = new Blob([reportIframe.srcdoc], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    a.download = `è®®äº‹æŠ¥å‘Š_${timestamp}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    showAlert('æŠ¥å‘Šå°šæœªç”Ÿæˆï¼Œæ— æ³•ä¸‹è½½', 'æç¤º');
                }
            }

            async function downloadImage(e) {
                if (reportIframe && reportIframe.contentDocument && reportIframe.contentDocument.body) {
                    const btn = e.currentTarget;
                    const originalText = btn.innerText;
                    btn.innerText = 'è½¬æ¢ä¸­...';
                    btn.disabled = true;

                    try {
                        // ä½¿ç”¨ html2canvas æ¸²æŸ“ iframe å†…å®¹
                        // æ³¨æ„ï¼šç”±äº iframe æ˜¯ srcdoc æ¨¡å¼ï¼Œå±äºåŒæºï¼Œå¯ä»¥ç›´æ¥è®¿é—®
                        const canvas = await html2canvas(reportIframe.contentDocument.body, {
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            scale: 2 // æé«˜æ¸…æ™°åº¦
                        });
                        
                        const url = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        a.href = url;
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        a.download = `è®®äº‹æŠ¥å‘Š_${timestamp}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } catch (error) {
                        console.error('Image conversion error:', error);
                        showAlert('å›¾ç‰‡è½¬æ¢å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½ HTML æ ¼å¼', 'é”™è¯¯', 'error');
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                } else {
                    showAlert('æŠ¥å‘Šå°šæœªç”Ÿæˆï¼Œæ— æ³•ä¸‹è½½å›¾ç‰‡', 'æç¤º');
                }
            }

            // å†å²è®°å½•åŠŸèƒ½
            async function deleteWorkspace(event, sessionId) {
                event.stopPropagation(); // é˜»æ­¢è§¦å‘ loadWorkspace
                
                const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•åŠå…¶ç›¸å…³æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚', 'ç¡®è®¤åˆ é™¤');
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/delete_workspace/${sessionId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // é‡æ–°åŠ è½½å†å²åˆ—è¡¨
                        const modal = document.getElementById('history-modal');
                        modal.classList.add('hidden'); // å…ˆå…³é—­
                        toggleHistoryModal(); // å†æ‰“å¼€ä»¥è§¦å‘åˆ·æ–°
                        showAlert('å†å²è®°å½•å·²æˆåŠŸåˆ é™¤', 'æˆåŠŸ');
                    } else {
                        showAlert('åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    showAlert('åˆ é™¤å‡ºé”™: ' + error.message, 'é”™è¯¯', 'error');
                }
            }

            async function toggleHistoryModal() {
                const modal = document.getElementById('history-modal');
                const list = document.getElementById('history-list');
                
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    list.innerHTML = '<div class="text-center py-8 text-slate-400 italic">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>';
                    
                    try {
                        const response = await fetch('/api/workspaces');
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.workspaces.length > 0) {
                            list.innerHTML = '';
                            data.workspaces.forEach(ws => {
                                const item = document.createElement('div');
                                item.className = 'p-4 border border-slate-100 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 cursor-pointer transition group';
                                item.onclick = () => loadWorkspace(ws.id);
                                item.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-bold text-slate-800 group-hover:text-indigo-700">${ws.issue || 'æœªå‘½åè®®é¢˜'}</h4>
                                            <p class="text-xs text-slate-400 mt-1">ID: ${ws.id}</p>
                                        </div>
                                        <div class="flex flex-col items-end space-y-2">
                                            <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">${ws.timestamp}</span>
                                            <button onclick="deleteWorkspace(event, '${ws.id}')" 
                                                    class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition opacity-0 group-hover:opacity-100"
                                                    title="åˆ é™¤è®°å½•">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                `;
                                list.appendChild(item);
                            });
                        } else {
                            list.innerHTML = '<div class="text-center py-8 text-slate-400 italic">æš‚æ— å†å²è®°å½•</div>';
                        }
                    } catch (error) {
                        list.innerHTML = `<div class="text-center py-8 text-red-400 italic">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    }
                } else {
                    modal.classList.add('hidden');
                }
            }

            function toggleLogs() {
                const logSection = document.getElementById('log-section');
                logSection.classList.toggle('hidden');
            }

            async function loadWorkspace(sessionId) {
                const confirmed = await showConfirm('åŠ è½½å†å²è®°å½•å°†æ¸…é™¤å½“å‰è®¨è®ºå†…å®¹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ', 'ç¡®è®¤åŠ è½½');
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/load_workspace/${sessionId}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // é‡ç½®UI
                        document.getElementById('discussion-flow').innerHTML = '';
                        // æ¸…ç©ºå¹¶éšè—æŠ¥å‘Š
                        const reportIframe = document.getElementById('report-iframe');
                        reportIframe.srcdoc = "<div style='color:#94a3b8; font-style:italic; text-align:center; margin-top:100px; font-family:sans-serif;'></div>";
                        
                        // é‡ç½®è¿›åº¦æ¡
                        currentProgress = 0;
                        document.getElementById('progress-bar').style.width = '0%';
                        document.getElementById('progress-percentage').innerText = '0%';
                        
                        // æ›´æ–°è¾“å…¥æ¡†
                        document.getElementById('issue-input').value = data.issue || '';
                        if (data.rounds) {
                            document.getElementById('rounds-input').value = data.rounds;
                        }
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        toggleHistoryModal();
                        
                        // æç¤ºæˆåŠŸ
                        showAlert('å†å²è®°å½•åŠ è½½æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥è®¨è®ºæµ...', 'æˆåŠŸ');
                        
                        // é‡ç½®è®¡æ•°å™¨ä»¥å¼ºåˆ¶å…¨é‡æ‹‰å–
                        lastEventCount = 0;
                        lastLogCount = 0;
                        
                        // è§¦å‘ä¸€æ¬¡æ›´æ–°ä»¥æ‹‰å–æ‰€æœ‰å†å²äº‹ä»¶
                        fetchUpdates();
                    } else {
                        showAlert('åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    showAlert('åŠ è½½å‡ºé”™: ' + error.message, 'é”™è¯¯', 'error');
                }
            }

            // åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', () => {
                // å¯åŠ¨å®šæ—¶è½®è¯¢
                setInterval(fetchUpdates, 1000);
                
                // ç›‘å¬å…¨å±€åç«¯é€‰æ‹©
                const globalBackend = document.getElementById('backend-select');
                const globalModel = document.getElementById('global-model-input');
                const updateGlobalList = () => {
                    if (globalBackend.value === 'openrouter') {
                        globalModel.setAttribute('list', 'openrouter-models-list');
                        fetchOpenRouterModels();
                    } else if (globalBackend.value === 'deepseek') {
                        globalModel.setAttribute('list', 'deepseek-models-list');
                        fetchDeepSeekModels();
                    } else {
                        globalModel.removeAttribute('list');
                    }
                };
                globalBackend.addEventListener('change', updateGlobalList);
                updateGlobalList(); // åˆå§‹æ£€æŸ¥

                // ç›‘å¬é™æ€ Agent åç«¯é€‰æ‹© (Leader, Reporter)
                document.querySelectorAll('.agent-backend').forEach(select => {
                    const agentId = select.dataset.agent;
                    const input = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    if (input) {
                        const updateAgentList = () => {
                            if (select.value === 'openrouter') {
                                input.setAttribute('list', 'openrouter-models-list');
                                fetchOpenRouterModels();
                            } else if (select.value === 'deepseek') {
                                input.setAttribute('list', 'deepseek-models-list');
                                fetchDeepSeekModels();
                            } else {
                                input.removeAttribute('list');
                            }
                        };
                        select.addEventListener('change', updateAgentList);
                        updateAgentList(); // åˆå§‹æ£€æŸ¥
                    }
                });
            });

            function toggleAdvancedSettings() {
                const panel = document.getElementById('advanced-settings');
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden')) {
                    updateAgentConfigsUI();
                }
            }

            function updateAgentConfigsUI() {
                const container = document.getElementById('agent-configs-container');
                const plannersCount = parseInt(document.getElementById('planners-input').value) || 0;
                const auditorsCount = parseInt(document.getElementById('auditors-input').value) || 0;
                
                // ä¿ç•™ Leader å’Œ Reporterï¼Œç§»é™¤æ—§çš„ Planner å’Œ Auditor
                const staticAgents = ['leader', 'reporter'];
                const existingConfigs = Array.from(container.children);
                
                // ç§»é™¤åŠ¨æ€ç”Ÿæˆçš„é…ç½®
                existingConfigs.forEach(child => {
                    const agentType = child.querySelector('select')?.dataset.agent;
                    if (agentType && !staticAgents.includes(agentType)) {
                        container.removeChild(child);
                    }
                });

                // ç”Ÿæˆ Planner é…ç½®
                for (let i = 0; i < plannersCount; i++) {
                    const div = createAgentConfigItem(`ç­–è®ºå®¶ ${i+1}`, `planner_${i}`, 'bg-blue-50', 'bg-blue-500');
                    container.appendChild(div);
                }

                // ç”Ÿæˆ Auditor é…ç½®
                for (let i = 0; i < auditorsCount; i++) {
                    const div = createAgentConfigItem(`ç›‘å¯Ÿå®˜ ${i+1}`, `auditor_${i}`, 'bg-amber-50', 'bg-amber-500');
                    container.appendChild(div);
                }
            }

            function createAgentConfigItem(label, id, bgColor, dotColor) {
                const div = document.createElement('div');
                div.className = `p-3 ${bgColor} rounded-lg border border-slate-200`;
                div.innerHTML = `
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center">
                        <span class="w-2 h-2 ${dotColor} rounded-full mr-2"></span>${label}
                    </h4>
                    <div class="flex gap-2">
                        <select class="agent-backend flex-1 text-xs p-1 border rounded" data-agent="${id}">
                            <option value="default">é»˜è®¤åç«¯</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="aliyun">Aliyun</option>
                            <option value="ollama">Ollama</option>
                        </select>
                        <input type="text" class="agent-model flex-1 text-xs p-1 border rounded" placeholder="æ¨¡å‹åç§° (å¯é€‰)" data-agent="${id}">
                    </div>
                    <select class="agent-reasoning hidden text-[10px] p-1 border rounded mt-1 w-full" data-agent="${id}">
                        <option value="">æ¨ç†: å…³é—­</option>
                        <option value="low">æ¨ç†: Low</option>
                        <option value="medium">æ¨ç†: Medium</option>
                        <option value="high">æ¨ç†: High</option>
                    </select>
                `;
                
                // ä¸ºåç«¯é€‰æ‹©æ·»åŠ ç›‘å¬å™¨ï¼ŒåŠ¨æ€åˆ‡æ¢ datalist
                const select = div.querySelector('.agent-backend');
                const input = div.querySelector('.agent-model');
                const reasoningSelect = div.querySelector('.agent-reasoning');
                const updateList = () => {
                    if (select.value === 'openrouter') {
                        input.setAttribute('list', 'openrouter-models-list');
                        reasoningSelect.classList.remove('hidden');
                        fetchOpenRouterModels();
                    } else if (select.value === 'deepseek') {
                        input.setAttribute('list', 'deepseek-models-list');
                        reasoningSelect.classList.add('hidden');
                        fetchDeepSeekModels();
                    } else {
                        input.removeAttribute('list');
                        reasoningSelect.classList.add('hidden');
                    }
                };
                select.addEventListener('change', updateList);
                updateList(); // åˆå§‹æ£€æŸ¥
                
                return div;
            }

            async function fetchOpenRouterModels() {
                try {
                    const response = await fetch('/api/openrouter/models');
                    const models = await response.json();
                    const datalist = document.getElementById('openrouter-models-list');
                    datalist.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name || model.id;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching OpenRouter models:', error);
                }
            }

            async function fetchDeepSeekModels() {
                try {
                    const response = await fetch('/api/deepseek/models');
                    const models = await response.json();
                    const datalist = document.getElementById('deepseek-models-list');
                    datalist.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching DeepSeek models:', error);
                }
            }

            // ç›‘å¬å…¨å±€åç«¯é€‰æ‹©
            document.getElementById('backend-select').addEventListener('change', function() {
                const modelInput = document.getElementById('global-model-input');
                const reasoningContainer = document.getElementById('global-reasoning-container');
                
                if (this.value === 'openrouter') {
                    modelInput.setAttribute('list', 'openrouter-models-list');
                    reasoningContainer.classList.remove('hidden');
                    fetchOpenRouterModels();
                } else if (this.value === 'deepseek') {
                    modelInput.setAttribute('list', 'deepseek-models-list');
                    reasoningContainer.classList.add('hidden');
                    fetchDeepSeekModels();
                } else {
                    modelInput.removeAttribute('list');
                    reasoningContainer.classList.add('hidden');
                }
            });

            // ç›‘å¬ä»£ç†äººåç«¯é€‰æ‹©
            document.addEventListener('change', function(e) {
                if (e.target && e.target.classList.contains('agent-backend')) {
                    const agentId = e.target.dataset.agent;
                    const modelInput = document.querySelector(`.agent-model[data-agent="${agentId}"]`);
                    const reasoningSelect = document.querySelector(`.agent-reasoning[data-agent="${agentId}"]`);
                    
                    if (e.target.value === 'openrouter') {
                        modelInput.setAttribute('list', 'openrouter-models-list');
                        reasoningSelect.classList.remove('hidden');
                        fetchOpenRouterModels();
                    } else if (e.target.value === 'deepseek') {
                        modelInput.setAttribute('list', 'deepseek-models-list');
                        reasoningSelect.classList.add('hidden');
                        fetchDeepSeekModels();
                    } else {
                        modelInput.removeAttribute('list');
                        reasoningSelect.classList.add('hidden');
                    }
                }
            });

            async function toggleSettingsModal() {
                const modal = document.getElementById('settings-modal');
                if (modal.classList.contains('hidden')) {
                    // æ‰“å¼€æ—¶åŠ è½½å½“å‰é…ç½®
                    try {
                        const response = await fetch('/api/config');
                        const data = await response.json();
                        if (data.status === 'success') {
                            const cfg = data.config;
                            document.getElementById('settings-key-deepseek').value = cfg.DEEPSEEK_API_KEY || '';
                            document.getElementById('settings-key-openai').value = cfg.OPENAI_API_KEY || '';
                            document.getElementById('settings-key-openrouter').value = cfg.OPENROUTER_API_KEY || '';
                            document.getElementById('settings-key-aliyun').value = cfg.ALIYUN_API_KEY || '';
                            document.getElementById('settings-key-tavily').value = cfg.TAVILY_API_KEY || '';
                            
                            // å¤„ç†å¤šé€‰æœç´¢ä¾›åº”å•†
                            if (cfg.SEARCH_PROVIDER) {
                                const providers = cfg.SEARCH_PROVIDER.split(',').map(p => p.trim());
                                document.querySelectorAll('.search-provider-checkbox').forEach(cb => {
                                    cb.checked = providers.includes(cb.value);
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load config:', error);
                    }
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }

            async function saveSettings() {
                const selectedProviders = Array.from(document.querySelectorAll('.search-provider-checkbox:checked'))
                    .map(cb => cb.value)
                    .join(',');

                const keys = {
                    DEEPSEEK_API_KEY: document.getElementById('settings-key-deepseek').value.trim(),
                    OPENAI_API_KEY: document.getElementById('settings-key-openai').value.trim(),
                    OPENROUTER_API_KEY: document.getElementById('settings-key-openrouter').value.trim(),
                    ALIYUN_API_KEY: document.getElementById('settings-key-aliyun').value.trim(),
                    TAVILY_API_KEY: document.getElementById('settings-key-tavily').value.trim(),
                    SEARCH_PROVIDER: selectedProviders
                };

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(keys)
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        showAlert('è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨', 'æˆåŠŸ');
                        toggleSettingsModal();
                    } else {
                        showAlert('ä¿å­˜å¤±è´¥: ' + data.message, 'é”™è¯¯', 'error');
                    }
                } catch (error) {
                    showAlert('ä¿å­˜è¯·æ±‚å¤±è´¥: ' + error.message, 'é”™è¯¯', 'error');
                }
            }
        </script>
    </main>
</body>
</html>

