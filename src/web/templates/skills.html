<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½ç®¡ç† - AICouncil v{{ version }}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="/static/vendor/tailwindcss.js"></script>
    <script src="/static/vendor/marked.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            border-bottom: 3px solid #7c3aed;
            color: #7c3aed;
            font-weight: 600;
        }
        .tab-inactive {
            color: #6b7280;
        }
        .tab-inactive:hover {
            color: #4b5563;
        }
        .skill-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .skill-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .category-policy { background: #dbeafe; color: #1e40af; }
        .category-technology { background: #d1fae5; color: #065f46; }
        .category-stakeholder { background: #fce7f3; color: #9f1239; }
        .category-risk { background: #fed7aa; color: #92400e; }
        .category-finance { background: #e9d5ff; color: #6b21a8; }
        .category-other { background: #e5e7eb; color: #374151; }
        .markdown-preview {
            max-height: 400px;
            overflow-y: auto;
        }
        .markdown-preview h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .markdown-preview h2 { font-size: 1.25rem; font-weight: bold; margin-top: 0.75rem; }
        .markdown-preview h3 { font-size: 1.125rem; font-weight: bold; margin-top: 0.5rem; }
        .markdown-preview p { margin-bottom: 0.5rem; }
        .markdown-preview ul { list-style-type: disc; margin-left: 1.5rem; }
        .markdown-preview ol { list-style-type: decimal; margin-left: 1.5rem; }
        .markdown-preview code { background: #f3f4f6; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
        .markdown-preview pre { background: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-white mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                    </svg>
                    <h1 class="text-white text-2xl font-bold">æŠ€èƒ½ç®¡ç†</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-white text-sm" id="current-username"></span>
                    <a href="/" class="text-white hover:text-gray-200 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabå¯¼èˆª -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b overflow-x-auto">
                <button onclick="switchTab('browse')" id="tab-browse" class="flex-1 py-4 px-6 text-center transition tab-active">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    æŠ€èƒ½åº“
                </button>
                <button onclick="switchTab('subscribed')" id="tab-subscribed" class="flex-1 py-4 px-6 text-center transition tab-inactive">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                    </svg>
                    æˆ‘çš„è®¢é˜…
                </button>
                <button onclick="switchTab('create')" id="tab-create" class="flex-1 py-4 px-6 text-center transition tab-inactive">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    åˆ›å»ºæŠ€èƒ½
                </button>
                <button onclick="switchTab('stats')" id="tab-stats" class="flex-1 py-4 px-6 text-center transition tab-inactive">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    ä½¿ç”¨ç»Ÿè®¡
                </button>
                <button onclick="switchTab('import')" id="tab-import" class="flex-1 py-4 px-6 text-center transition tab-inactive">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    å¯¼å…¥æŠ€èƒ½
                </button>
                <button onclick="switchTab('generate')" id="tab-generate" class="flex-1 py-4 px-6 text-center transition tab-inactive">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                    </svg>
                    AI ç”Ÿæˆ
                </button>
                <button onclick="switchTab('marketplace')" id="tab-marketplace" class="flex-1 py-4 px-6 text-center transition tab-inactive">
                    <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"/>
                    </svg>
                    æŠ€èƒ½å¸‚åœº
                </button>
            </div>
        </div>

        <!-- æŠ€èƒ½åº“Tab -->
        <div id="panel-browse" class="tab-panel">
            <div class="bg-white rounded-lg shadow-md p-6">
                <!-- æœç´¢å’Œç­›é€‰æ  -->
                <div class="mb-6 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="search-input" placeholder="æœç´¢æŠ€èƒ½åç§°ã€æè¿°..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                    </div>
                    <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                        <option value="policy">æ”¿ç­–åˆ†æ</option>
                        <option value="technology">æŠ€æœ¯è¯„ä¼°</option>
                        <option value="stakeholder">åˆ©ç›Šç›¸å…³æ–¹</option>
                        <option value="risk">é£é™©è¯„ä¼°</option>
                        <option value="finance">è´¢åŠ¡åˆ†æ</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                    <button onclick="applyFilters()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        ç­›é€‰
                    </button>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="browse-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="text-gray-600 mt-4">åŠ è½½ä¸­...</p>
                </div>

                <!-- æŠ€èƒ½å¡ç‰‡åˆ—è¡¨ -->
                <div id="skills-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- æŠ€èƒ½å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- åˆ†é¡µ -->
                <div id="pagination" class="hidden mt-6 flex justify-center items-center space-x-2">
                    <!-- åˆ†é¡µæŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„è®¢é˜…Tab -->
        <div id="panel-subscribed" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">å·²è®¢é˜…æŠ€èƒ½</h2>
                    <button onclick="loadSubscribedSkills()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        åˆ·æ–°
                    </button>
                </div>

                <div id="subscribed-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="text-gray-600 mt-4">åŠ è½½ä¸­...</p>
                </div>

                <div id="subscribed-empty" class="hidden text-center py-12">
                    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                    </svg>
                    <p class="text-gray-600">æ‚¨è¿˜æ²¡æœ‰è®¢é˜…ä»»ä½•æŠ€èƒ½</p>
                    <button onclick="switchTab('browse')" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        æµè§ˆæŠ€èƒ½åº“
                    </button>
                </div>

                <div id="subscribed-list" class="hidden space-y-4">
                    <!-- è®¢é˜…åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- åˆ›å»ºæŠ€èƒ½Tab -->
        <div id="panel-create" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">åˆ›å»ºè‡ªå®šä¹‰æŠ€èƒ½</h2>
                
                <form id="create-skill-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æŠ€èƒ½åç§° *</label>
                        <input type="text" id="skill-name" required maxlength="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="ä¾‹å¦‚ï¼šé¡¹ç›®ç®¡ç†æ¡†æ¶">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±» *</label>
                        <select id="skill-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="policy">æ”¿ç­–åˆ†æ</option>
                            <option value="technology">æŠ€æœ¯è¯„ä¼°</option>
                            <option value="stakeholder">åˆ©ç›Šç›¸å…³æ–¹</option>
                            <option value="risk">é£é™©è¯„ä¼°</option>
                            <option value="finance">è´¢åŠ¡åˆ†æ</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç®€çŸ­æè¿°</label>
                        <input type="text" id="skill-description" maxlength="500" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="ç®€è¦è¯´æ˜è¯¥æŠ€èƒ½çš„ç”¨é€”">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‚ç”¨è§’è‰²</label>
                        <div class="flex flex-wrap gap-3">
                            <label class="flex items-center">
                                <input type="checkbox" value="ç­–è®ºå®¶" class="role-checkbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <span class="ml-2 text-sm text-gray-700">ç­–è®ºå®¶</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="ç›‘å¯Ÿå®˜" class="role-checkbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <span class="ml-2 text-sm text-gray-700">ç›‘å¯Ÿå®˜</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="è®®é•¿" class="role-checkbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <span class="ml-2 text-sm text-gray-700">è®®é•¿</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æŠ€èƒ½å†…å®¹ * <span class="text-xs text-gray-500">(æ”¯æŒMarkdownæ ¼å¼)</span></label>
                        <textarea id="skill-content" required rows="12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono text-sm" placeholder="è¯·è¾“å…¥æŠ€èƒ½çš„è¯¦ç»†å†…å®¹ï¼Œæ”¯æŒMarkdownè¯­æ³•..."></textarea>
                        <div class="mt-2 flex justify-between items-center">
                            <button type="button" onclick="togglePreview()" class="text-sm text-purple-600 hover:text-purple-800">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                é¢„è§ˆ
                            </button>
                            <span id="content-length" class="text-xs text-gray-500">0 å­—ç¬¦</span>
                        </div>
                    </div>

                    <!-- Markdowné¢„è§ˆåŒºåŸŸ -->
                    <div id="markdown-preview-panel" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢„è§ˆ</label>
                        <div id="markdown-preview-content" class="markdown-preview border border-gray-300 rounded-lg p-4 bg-gray-50"></div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="resetCreateForm()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            é‡ç½®
                        </button>
                        <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            åˆ›å»ºæŠ€èƒ½
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ä½¿ç”¨ç»Ÿè®¡Tab -->
        <div id="panel-stats" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŠ€èƒ½ä½¿ç”¨ç»Ÿè®¡</h2>

                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                <div id="stats-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">æ€»ä½¿ç”¨æ¬¡æ•°</p>
                                <p id="total-usage" class="text-3xl font-bold text-blue-900 mt-2">-</p>
                            </div>
                            <svg class="w-12 h-12 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">å¹³å‡è¯„åˆ†</p>
                                <p id="avg-rating" class="text-3xl font-bold text-green-900 mt-2">-</p>
                            </div>
                            <svg class="w-12 h-12 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-purple-600 font-medium">æœ€å¸¸ç”¨æŠ€èƒ½</p>
                                <p id="top-skill" class="text-lg font-bold text-purple-900 mt-2 truncate">-</p>
                            </div>
                            <svg class="w-12 h-12 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- çƒ­é—¨æŠ€èƒ½æ’è¡Œ -->
                <div id="top-skills-section" class="mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">çƒ­é—¨æŠ€èƒ½æ’è¡Œ</h3>
                    <div id="top-skills-list" class="space-y-3">
                        <!-- æ’è¡Œæ¦œå°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- è¯¦ç»†ä½¿ç”¨è®°å½• -->
                <div id="usage-detail-section">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">æœ€è¿‘ä½¿ç”¨è®°å½•</h3>
                    <div id="stats-loading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                    </div>
                    <div id="usage-detail-table" class="hidden overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æŠ€èƒ½åç§°</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½¿ç”¨æ¬¡æ•°</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€åä½¿ç”¨</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¹³å‡å“åº”æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="usage-detail-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- ä½¿ç”¨è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- AIç”ŸæˆæŠ€èƒ½Tab -->
        <div id="panel-generate" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                    </svg>
                    AI ç”ŸæˆæŠ€èƒ½
                </h2>
                <p class="text-gray-500 text-sm mb-6">æè¿°ä½ éœ€è¦çš„åˆ†ææ¡†æ¶ï¼ŒAI å°†è‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡çš„ SKILL.md</p>

                <!-- ç”Ÿæˆè¡¨å• -->
                <div id="generate-form-panel">
                    <form id="generate-skill-form" class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ€èƒ½ä¸»é¢˜ *</label>
                            <input type="text" id="gen-topic" required maxlength="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="ä¾‹å¦‚ï¼šä¾›åº”é“¾é£é™©è¯„ä¼°ã€ESGåˆè§„åˆ†æã€ç«å“æŠ€æœ¯å¯¹æ¯”...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è¯¦ç»†æè¿° *</label>
                            <textarea id="gen-description" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="æè¿°è¯¥æŠ€èƒ½çš„åˆ†æç»´åº¦ã€é€‚ç”¨åœºæ™¯å’ŒæœŸæœ›è¾“å‡º..."></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
                                <select id="gen-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                                    <option value="analysis">åˆ†ææ¡†æ¶</option>
                                    <option value="policy">æ”¿ç­–åˆ†æ</option>
                                    <option value="technology">æŠ€æœ¯è¯„ä¼°</option>
                                    <option value="risk">é£é™©è¯„ä¼°</option>
                                    <option value="finance">è´¢åŠ¡åˆ†æ</option>
                                    <option value="stakeholder">åˆ©ç›Šç›¸å…³æ–¹</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é€‚ç”¨è§’è‰²</label>
                                <div class="flex flex-wrap gap-3 pt-1">
                                    <label class="flex items-center"><input type="checkbox" value="ç­–è®ºå®¶" class="gen-role-checkbox w-4 h-4 text-purple-600" checked><span class="ml-2 text-sm">ç­–è®ºå®¶</span></label>
                                    <label class="flex items-center"><input type="checkbox" value="ç›‘å¯Ÿå®˜" class="gen-role-checkbox w-4 h-4 text-purple-600" checked><span class="ml-2 text-sm">ç›‘å¯Ÿå®˜</span></label>
                                    <label class="flex items-center"><input type="checkbox" value="è®®é•¿" class="gen-role-checkbox w-4 h-4 text-purple-600"><span class="ml-2 text-sm">è®®é•¿</span></label>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" id="gen-submit-btn" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition font-medium">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                å¼€å§‹ç”Ÿæˆ
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ç”Ÿæˆè¿›åº¦ -->
                <div id="generate-progress" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600"></div>
                    <p class="text-gray-600 mt-4 text-lg">AI æ­£åœ¨ç”ŸæˆæŠ€èƒ½ï¼Œè¯·ç¨å€™...</p>
                    <p class="text-gray-400 text-sm mt-2">é€šå¸¸éœ€è¦ 15-30 ç§’</p>
                </div>

                <!-- ç”Ÿæˆé¢„è§ˆ -->
                <div id="generate-preview" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">ç”Ÿæˆé¢„è§ˆ</h3>
                        <div class="flex items-center space-x-3">
                            <span id="gen-security-badge" class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700"></span>
                            <span id="gen-time-badge" class="text-sm text-gray-500"></span>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢ -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button onclick="switchGenView('edit')" id="gen-view-edit" class="px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600">ç¼–è¾‘</button>
                        <button onclick="switchGenView('preview')" id="gen-view-preview" class="px-4 py-2 font-medium text-gray-500 hover:text-gray-700">é¢„è§ˆ</button>
                    </div>

                    <div id="gen-edit-panel">
                        <textarea id="gen-skill-md" rows="20" class="w-full px-4 py-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-600 focus:border-transparent"></textarea>
                    </div>
                    <div id="gen-preview-panel" class="hidden">
                        <div id="gen-preview-content" class="markdown-preview border border-gray-300 rounded-lg p-6 bg-gray-50 min-h-[300px]"></div>
                    </div>

                    <div class="mt-6 flex justify-between">
                        <button onclick="resetGenerate()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            é‡æ–°ç”Ÿæˆ
                        </button>
                        <button onclick="confirmGeneratedSkill()" id="gen-confirm-btn" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                            <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            ç¡®è®¤ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŠ€èƒ½å¸‚åœºTab -->
        <div id="panel-marketplace" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"/>
                    </svg>
                    æŠ€èƒ½å¸‚åœº
                </h2>
                <p class="text-gray-500 text-sm mb-6">ä» GitHub å¼€æºç¤¾åŒºæµè§ˆå’Œå¯¼å…¥é«˜è´¨é‡çš„ Agent Skills</p>

                <!-- æœç´¢æ  -->
                <div class="mb-6 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="mp-search" placeholder="æœç´¢æŠ€èƒ½..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                    </div>
                    <select id="mp-category" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    </select>
                    <!-- æœç´¢æ¨¡å¼åˆ‡æ¢ -->
                    <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                        <button id="mp-mode-keyword" onclick="setSearchMode('keyword')" class="px-4 py-2 text-sm font-medium bg-purple-600 text-white transition">
                            ğŸ” å…³é”®è¯
                        </button>
                        <button id="mp-mode-ai" onclick="setSearchMode('ai')" class="px-4 py-2 text-sm font-medium bg-white text-gray-600 hover:bg-gray-50 transition">
                            ğŸ¤– æ™ºèƒ½æœç´¢
                        </button>
                    </div>
                    <button onclick="searchMarketplace()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        æœç´¢
                    </button>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="mp-loading" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="text-gray-600 mt-4">æœç´¢ä¸­...</p>
                </div>

                <!-- ç»“æœåˆ—è¡¨ -->
                <div id="mp-results" class="space-y-4">
                    <!-- åˆå§‹æç¤º -->
                    <div id="mp-initial" class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <p>è¾“å…¥å…³é”®è¯æœç´¢ç¤¾åŒºæŠ€èƒ½ï¼Œæˆ–é€‰æ‹©åˆ†ç±»æµè§ˆ</p>
                    </div>
                </div>

                <!-- åˆ†é¡µ -->
                <div id="mp-pagination" class="hidden mt-6 flex justify-center items-center space-x-2">
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥æŠ€èƒ½Tab -->
        <div id="panel-import" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    ä»å¤–éƒ¨æºå¯¼å…¥æŠ€èƒ½
                </h2>

                <!-- é€‰é¡¹å¡åˆ‡æ¢ï¼šé¢„è®¾ vs è‡ªå®šä¹‰URL -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="switchImportMode('presets')" id="import-mode-presets" class="px-6 py-3 font-medium text-purple-600 border-b-2 border-purple-600">
                        Anthropicå®˜æ–¹é¢„è®¾
                    </button>
                    <button onclick="switchImportMode('custom')" id="import-mode-custom" class="px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
                        è‡ªå®šä¹‰URLå¯¼å…¥
                    </button>
                    <button onclick="switchImportMode('pdf')" id="import-mode-pdf" class="px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
                        <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                        </svg>
                        PDF ä¸Šä¼ 
                    </button>
                </div>

                <!-- é¢„è®¾æŠ€èƒ½é€‰æ‹©å™¨ -->
                <div id="import-presets-panel">
                    <p class="text-gray-600 mb-4">
                        é€‰æ‹©Anthropicå®˜æ–¹æŠ€èƒ½åº“ä¸­çš„é¢„è®¾æŠ€èƒ½è¿›è¡Œå¯¼å…¥ï¼ˆè¿™äº›æ˜¯ç»è¿‡å®˜æ–¹éªŒè¯çš„é«˜è´¨é‡æŠ€èƒ½æ¨¡æ¿ï¼‰
                    </p>

                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div id="presets-loading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                        <p class="text-gray-600 mt-2">åŠ è½½é¢„è®¾æŠ€èƒ½...</p>
                    </div>

                    <!-- é¢„è®¾åˆ—è¡¨ -->
                    <div id="presets-list" class="hidden space-y-3 mb-6">
                        <!-- é¢„è®¾é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- æ‰¹é‡å¯¼å…¥æŒ‰é’® -->
                    <div id="presets-actions" class="hidden flex justify-end gap-3">
                        <button onclick="selectAllPresets()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            å…¨é€‰
                        </button>
                        <button onclick="deselectAllPresets()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            å–æ¶ˆå…¨é€‰
                        </button>
                        <button onclick="importSelectedPresets()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            å¯¼å…¥é€‰ä¸­é¡¹ (<span id="selected-count">0</span>)
                        </button>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰URLå¯¼å…¥ -->
                <div id="import-custom-panel" class="hidden">
                    <p class="text-gray-600 mb-4">
                        ä»ä»»æ„GitHub raw URLæˆ–å…¶ä»–å…¬å¼€Markdown URLå¯¼å…¥æŠ€èƒ½ï¼ˆæ”¯æŒYAML front matterå…ƒæ•°æ®ï¼‰
                    </p>

                    <!-- URLè¾“å…¥è¡¨å• -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Skill URL <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="custom-url-input" placeholder="https://raw.githubusercontent.com/username/repo/main/skill.md" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">
                                ç¤ºä¾‹: https://raw.githubusercontent.com/anthropics/anthropic-cookbook/main/skills/policy_analysis.md
                            </p>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="strict-security-checkbox" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <label for="strict-security-checkbox" class="ml-2 text-sm text-gray-700">
                                å¯ç”¨ä¸¥æ ¼å®‰å…¨æ¨¡å¼ï¼ˆæ›´ä¸¥æ ¼çš„å®‰å…¨æ‰«æï¼‰
                            </label>
                        </div>

                        <button onclick="importFromCustomUrl()" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                            <svg class="w-5 h-5 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            å¯¼å…¥è¯¥æŠ€èƒ½
                        </button>
                    </div>

                    <!-- æ‰¹é‡URLå¯¼å…¥ -->
                    <div class="border-t pt-6">
                        <h3 class="font-medium text-gray-800 mb-3">æ‰¹é‡å¯¼å…¥ï¼ˆå¤šä¸ªURLï¼‰</h3>
                        <textarea id="batch-urls-input" rows="5" placeholder="æ¯è¡Œä¸€ä¸ªURLï¼Œä¾‹å¦‚ï¼š&#10;https://raw.githubusercontent.com/.../skill1.md&#10;https://raw.githubusercontent.com/.../skill2.md" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent font-mono text-sm"></textarea>
                        <button onclick="importFromBatchUrls()" class="mt-3 w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                            æ‰¹é‡å¯¼å…¥
                        </button>
                    </div>
                </div>

                <!-- PDFä¸Šä¼ å¯¼å…¥ -->
                <div id="import-pdf-panel" class="hidden">
                    <p class="text-gray-600 mb-4">
                        ä¸Šä¼ ä¸“ä¸šæ–‡æ¡£ã€è®ºæ–‡ã€æŠ€æœ¯æ‰‹å†Œç­‰ PDF æ–‡ä»¶ï¼ŒAI å°†è‡ªåŠ¨æå–çŸ¥è¯†å¹¶ç”Ÿæˆç»“æ„åŒ–çš„åˆ†ææ¡†æ¶æŠ€èƒ½
                    </p>

                    <!-- PDFä¸Šä¼ è¡¨å• -->
                    <div id="pdf-upload-form">
                        <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                        <div id="pdf-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-400 transition cursor-pointer mb-5"
                             onclick="document.getElementById('pdf-file-input').click()"
                             ondragover="event.preventDefault(); this.classList.add('border-purple-500', 'bg-purple-50');"
                             ondragleave="this.classList.remove('border-purple-500', 'bg-purple-50');"
                             ondrop="handlePdfDrop(event)">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-gray-600 text-lg" id="pdf-file-label">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ– <span class="text-purple-600 font-medium">ç‚¹å‡»ä¸Šä¼ </span></p>
                            <p class="text-gray-400 text-sm mt-1">æ”¯æŒ PDF æ ¼å¼ï¼Œæœ€å¤§ 20MB</p>
                            <input type="file" id="pdf-file-input" accept=".pdf" class="hidden" onchange="handlePdfFileSelect(this)">
                        </div>

                        <!-- é€‰ä¸­æ–‡ä»¶ä¿¡æ¯ -->
                        <div id="pdf-file-info" class="hidden mb-5 p-3 bg-gray-50 rounded-lg flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-8 h-8 text-red-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <p id="pdf-file-name" class="font-medium text-gray-800"></p>
                                    <p id="pdf-file-size" class="text-sm text-gray-500"></p>
                                </div>
                            </div>
                            <button onclick="clearPdfFile()" class="text-gray-400 hover:text-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <!-- é…ç½®é€‰é¡¹ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç”Ÿæˆæ¨¡å¼</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center"><input type="radio" name="pdf-mode" value="auto" checked class="w-4 h-4 text-purple-600"><span class="ml-2 text-sm">è‡ªåŠ¨</span></label>
                                    <label class="flex items-center"><input type="radio" name="pdf-mode" value="single" class="w-4 h-4 text-purple-600"><span class="ml-2 text-sm">å•ä¸ªæŠ€èƒ½</span></label>
                                    <label class="flex items-center"><input type="radio" name="pdf-mode" value="multi" class="w-4 h-4 text-purple-600"><span class="ml-2 text-sm">å¤šä¸ªæŠ€èƒ½</span></label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
                                <select id="pdf-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent text-sm">
                                    <option value="analysis">åˆ†ææ¡†æ¶</option>
                                    <option value="policy">æ”¿ç­–åˆ†æ</option>
                                    <option value="technology">æŠ€æœ¯è¯„ä¼°</option>
                                    <option value="risk">é£é™©è¯„ä¼°</option>
                                    <option value="finance">è´¢åŠ¡åˆ†æ</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»é¢˜æç¤ºï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" id="pdf-topic-hint" maxlength="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent text-sm" placeholder="ä¾‹å¦‚ï¼šä¾›åº”é“¾ç®¡ç†ã€é£é™©è¯„ä¼°...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é€‚ç”¨è§’è‰²</label>
                                <div class="flex flex-wrap gap-3 pt-1">
                                    <label class="flex items-center"><input type="checkbox" value="ç­–è®ºå®¶" class="pdf-role-checkbox w-4 h-4 text-purple-600" checked><span class="ml-2 text-sm">ç­–è®ºå®¶</span></label>
                                    <label class="flex items-center"><input type="checkbox" value="ç›‘å¯Ÿå®˜" class="pdf-role-checkbox w-4 h-4 text-purple-600" checked><span class="ml-2 text-sm">ç›‘å¯Ÿå®˜</span></label>
                                    <label class="flex items-center"><input type="checkbox" value="è®®é•¿" class="pdf-role-checkbox w-4 h-4 text-purple-600"><span class="ml-2 text-sm">è®®é•¿</span></label>
                                </div>
                            </div>
                        </div>

                        <button onclick="uploadAndGeneratePdfSkills()" id="pdf-upload-btn" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition font-medium disabled:opacity-50" disabled>
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            ä¸Šä¼ å¹¶ç”ŸæˆæŠ€èƒ½
                        </button>
                    </div>

                    <!-- PDFå¤„ç†è¿›åº¦ -->
                    <div id="pdf-progress" class="hidden text-center py-10">
                        <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600"></div>
                        <p class="text-gray-600 mt-4 text-lg" id="pdf-progress-text">æ­£åœ¨æå– PDF å†…å®¹...</p>
                        <p class="text-gray-400 text-sm mt-2">æ ¹æ®æ–‡æ¡£å¤§å°å’Œç”Ÿæˆæ¨¡å¼ï¼Œå¯èƒ½éœ€è¦ 30ç§’ - 2åˆ†é’Ÿ</p>
                    </div>

                    <!-- PDFç”Ÿæˆç»“æœï¼ˆå¤šæŠ€èƒ½é¢„è§ˆï¼‰ -->
                    <div id="pdf-results" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">
                                ç”Ÿæˆç»“æœ
                                <span id="pdf-result-count" class="text-sm font-normal text-gray-500 ml-2"></span>
                            </h3>
                            <div class="flex items-center space-x-3">
                                <span id="pdf-info-badge" class="text-sm text-gray-500"></span>
                                <span id="pdf-time-badge" class="text-sm text-gray-500"></span>
                            </div>
                        </div>

                        <div id="pdf-skills-list" class="space-y-4 mb-6">
                            <!-- æŠ€èƒ½å¡ç‰‡ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <div class="flex justify-between">
                            <button onclick="resetPdfUpload()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                é‡æ–°ä¸Šä¼ 
                            </button>
                            <button onclick="saveAllPdfSkills()" id="pdf-save-all-btn" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                                <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                å…¨éƒ¨ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å¯¼å…¥è¿›åº¦æ˜¾ç¤º -->
                <div id="import-progress" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center mb-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                        <span class="font-medium text-blue-900">æ­£åœ¨å¯¼å…¥...</span>
                    </div>
                    <p id="import-status" class="text-sm text-blue-700">å‡†å¤‡ä¸­...</p>
                    <div class="mt-3 bg-blue-200 rounded-full h-2">
                        <div id="import-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- å¯¼å…¥ç»“æœ -->
                <div id="import-results" class="hidden mt-6">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h3 class="font-medium text-gray-800 mb-3">å¯¼å…¥ç»“æœ</h3>
                        <div class="space-y-2" id="import-results-list">
                            <!-- ç»“æœåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ€èƒ½è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="skill-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h3 id="modal-skill-name" class="text-2xl font-bold text-gray-900 mb-2"></h3>
                        <div class="flex items-center gap-3 mb-3">
                            <span id="modal-skill-category" class="category-badge"></span>
                            <span id="modal-skill-source" class="text-sm text-gray-500"></span>
                        </div>
                        <p id="modal-skill-description" class="text-gray-600 mb-4"></p>
                    </div>
                    <button onclick="closeSkillModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div id="modal-skill-roles" class="mb-4"></div>

                <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">æŠ€èƒ½å†…å®¹</h4>
                    <div id="modal-skill-content" class="markdown-preview border border-gray-200 rounded-lg p-4 bg-gray-50"></div>
                </div>

                <div class="flex justify-end gap-3">
                    <button onclick="closeSkillModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                        å…³é—­
                    </button>
                    <button id="modal-subscribe-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        è®¢é˜…
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentTab = 'browse';
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 12;
        let currentCategory = '';
        let currentSearch = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadSkills();
            
            // ç»‘å®šè¡¨å•äº‹ä»¶
            document.getElementById('create-skill-form').addEventListener('submit', handleCreateSkill);
            document.getElementById('skill-content').addEventListener('input', updateContentLength);
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        function checkAuth() {
            fetch('/api/user/profile')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('current-username').textContent = data.user.username;
                    } else {
                        window.location.href = '/login';
                    }
                })
                .catch(() => {
                    window.location.href = '/login';
                });
        }

        // Tabåˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°Tabæ ·å¼
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('tab-inactive');
            });
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('tab-inactive');

            // åˆ‡æ¢é¢æ¿
            document.querySelectorAll('[id^="panel-"]').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');

            currentTab = tabName;

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'browse') {
                loadSkills();
            } else if (tabName === 'subscribed') {
                loadSubscribedSkills();
            } else if (tabName === 'stats') {
                loadStats();
            } else if (tabName === 'import') {
                loadImportPresets();
            } else if (tabName === 'marketplace') {
                loadMarketplaceCategories();
            }
        }

        // åŠ è½½æŠ€èƒ½åˆ—è¡¨
        function loadSkills(page = 1) {
            document.getElementById('browse-loading').classList.remove('hidden');
            document.getElementById('skills-grid').classList.add('hidden');
            document.getElementById('pagination').classList.add('hidden');

            const params = new URLSearchParams({
                page: page,
                page_size: pageSize,
                include_content: 'false'
            });

            if (currentCategory) params.append('category', currentCategory);
            if (currentSearch) params.append('search', currentSearch);

            fetch(`/api/skills?${params}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('browse-loading').classList.add('hidden');
                    
                    if (data.status === 'success' && data.data) {
                        const skills = data.data.items || [];
                        displaySkills(skills);
                        currentPage = data.data.page || 1;
                        totalPages = Math.ceil((data.data.total || 0) / pageSize);
                        updatePagination();
                    } else {
                        showError('åŠ è½½æŠ€èƒ½å¤±è´¥: ' + (data.message || 'æ•°æ®æ ¼å¼é”™è¯¯'));
                        displaySkills([]);  // æ˜¾ç¤ºç©ºçŠ¶æ€
                    }
                })
                .catch(err => {
                    document.getElementById('browse-loading').classList.add('hidden');
                    showError('ç½‘ç»œé”™è¯¯: ' + err.message);
                });
        }

        // æ˜¾ç¤ºæŠ€èƒ½å¡ç‰‡
        function displaySkills(skills) {
            const grid = document.getElementById('skills-grid');
            grid.innerHTML = '';

            // ç¡®ä¿skillsæ˜¯æ•°ç»„
            if (!skills || !Array.isArray(skills)) {
                skills = [];
            }

            if (skills.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-gray-600">æœªæ‰¾åˆ°åŒ¹é…çš„æŠ€èƒ½</p>
                    </div>
                `;
            } else {
                skills.forEach(skill => {
                    const card = createSkillCard(skill);
                    grid.appendChild(card);
                });
            }

            grid.classList.remove('hidden');
        }

        // åˆ›å»ºæŠ€èƒ½å¡ç‰‡
        function createSkillCard(skill) {
            const div = document.createElement('div');
            div.className = 'skill-card bg-white rounded-lg shadow-md p-5 cursor-pointer';
            div.onclick = () => showSkillDetail(skill.id);

            const categoryClass = `category-${skill.category || 'other'}`;
            const sourceText = skill.is_builtin ? 'å†…ç½®' : 'è‡ªå®šä¹‰';
            const rolesText = skill.applicable_roles ? skill.applicable_roles.join(', ') : 'é€šç”¨';

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-gray-900">${escapeHtml(skill.name)}</h3>
                    <span class="category-badge ${categoryClass}">${getCategoryName(skill.category)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">${escapeHtml(skill.description || 'æš‚æ— æè¿°')}</p>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${sourceText}</span>
                    <span>${rolesText}</span>
                </div>
            `;

            return div;
        }

        // æ˜¾ç¤ºæŠ€èƒ½è¯¦æƒ…
        function showSkillDetail(skillId) {
            fetch(`/api/skills/${skillId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const skill = data.data;
                        document.getElementById('modal-skill-name').textContent = skill.name;
                        document.getElementById('modal-skill-category').textContent = getCategoryName(skill.category);
                        document.getElementById('modal-skill-category').className = `category-badge category-${skill.category || 'other'}`;
                        document.getElementById('modal-skill-source').textContent = skill.is_builtin ? 'å†…ç½®æŠ€èƒ½' : 'è‡ªå®šä¹‰æŠ€èƒ½';
                        document.getElementById('modal-skill-description').textContent = skill.description || 'æš‚æ— æè¿°';
                        
                        // æ˜¾ç¤ºé€‚ç”¨è§’è‰²
                        const rolesDiv = document.getElementById('modal-skill-roles');
                        if (skill.applicable_roles && skill.applicable_roles.length > 0) {
                            rolesDiv.innerHTML = `
                                <span class="text-sm text-gray-700 font-medium">é€‚ç”¨è§’è‰²ï¼š</span>
                                ${skill.applicable_roles.map(role => `<span class="text-sm text-purple-600">${role}</span>`).join(', ')}
                            `;
                        } else {
                            rolesDiv.innerHTML = '<span class="text-sm text-gray-500">é€‚ç”¨æ‰€æœ‰è§’è‰²</span>';
                        }

                        // æ¸²æŸ“Markdownå†…å®¹
                        const contentDiv = document.getElementById('modal-skill-content');
                        contentDiv.innerHTML = marked.parse(skill.content || 'æš‚æ— å†…å®¹');

                        // æ£€æŸ¥è®¢é˜…çŠ¶æ€
                        checkSubscriptionStatus(skillId);

                        document.getElementById('skill-detail-modal').classList.remove('hidden');
                    }
                })
                .catch(err => showError('åŠ è½½æŠ€èƒ½è¯¦æƒ…å¤±è´¥'));
        }

        // æ£€æŸ¥è®¢é˜…çŠ¶æ€
        function checkSubscriptionStatus(skillId) {
            fetch('/api/skills/subscriptions')
                .then(res => res.json())
                .then(data => {
                    const btn = document.getElementById('modal-subscribe-btn');
                    const isSubscribed = data.status === 'success' && 
                        data.data.subscriptions.some(sub => sub.skill_id === skillId && sub.enabled);

                    if (isSubscribed) {
                        btn.textContent = 'å·²è®¢é˜…';
                        btn.className = 'px-6 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed';
                        btn.disabled = true;
                    } else {
                        btn.textContent = 'è®¢é˜…';
                        btn.className = 'px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition';
                        btn.disabled = false;
                        btn.onclick = () => subscribeSkill(skillId);
                    }
                });
        }

        // è®¢é˜…æŠ€èƒ½
        function subscribeSkill(skillId) {
            fetch(`/api/skills/${skillId}/subscribe`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showSuccess('è®¢é˜…æˆåŠŸï¼');
                    checkSubscriptionStatus(skillId);
                } else {
                    showError('è®¢é˜…å¤±è´¥: ' + data.message);
                }
            })
            .catch(err => showError('ç½‘ç»œé”™è¯¯'));
        }

        // åŠ è½½å·²è®¢é˜…æŠ€èƒ½
        function loadSubscribedSkills() {
            document.getElementById('subscribed-loading').classList.remove('hidden');
            document.getElementById('subscribed-empty').classList.add('hidden');
            document.getElementById('subscribed-list').classList.add('hidden');

            fetch('/api/skills/subscriptions')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('subscribed-loading').classList.add('hidden');
                    
                    if (data.status === 'success' && data.data && Array.isArray(data.data)) {
                        const subs = data.data.filter(skill => !skill.is_builtin || skill.subscribed);
                        if (subs.length === 0) {
                            document.getElementById('subscribed-empty').classList.remove('hidden');
                        } else {
                            displaySubscriptions(subs);
                        }
                    }
                })
                .catch(err => {
                    document.getElementById('subscribed-loading').classList.add('hidden');
                    showError('åŠ è½½å¤±è´¥');
                });
        }

        // æ˜¾ç¤ºè®¢é˜…åˆ—è¡¨
        function displaySubscriptions(subscriptions) {
            const list = document.getElementById('subscribed-list');
            list.innerHTML = '';

            subscriptions.forEach(sub => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-md transition';
                
                const categoryClass = `category-${sub.skill.category || 'other'}`;
                
                item.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h4 class="text-lg font-bold text-gray-900">${escapeHtml(sub.skill.name)}</h4>
                            <span class="category-badge ${categoryClass}">${getCategoryName(sub.skill.category)}</span>
                        </div>
                        <p class="text-sm text-gray-600">${escapeHtml(sub.skill.description || 'æš‚æ— æè¿°')}</p>
                        <p class="text-xs text-gray-500 mt-2">è®¢é˜…æ—¶é—´: ${formatDate(sub.subscribed_at)}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="showSkillDetail(${sub.skill_id})" class="px-4 py-2 text-purple-600 hover:text-purple-800 transition">
                            æŸ¥çœ‹
                        </button>
                        <button onclick="unsubscribeSkill(${sub.skill_id})" class="px-4 py-2 text-red-600 hover:text-red-800 transition">
                            å–æ¶ˆè®¢é˜…
                        </button>
                    </div>
                `;
                
                list.appendChild(item);
            });

            list.classList.remove('hidden');
        }

        // å–æ¶ˆè®¢é˜…
        function unsubscribeSkill(skillId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè®¢é˜…è¯¥æŠ€èƒ½å—ï¼Ÿ')) return;

            fetch(`/api/skills/${skillId}/unsubscribe`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showSuccess('å·²å–æ¶ˆè®¢é˜…');
                        loadSubscribedSkills();
                    } else {
                        showError('æ“ä½œå¤±è´¥: ' + data.message);
                    }
                })
                .catch(err => showError('ç½‘ç»œé”™è¯¯'));
        }

        // åˆ›å»ºæŠ€èƒ½
        function handleCreateSkill(e) {
            e.preventDefault();

            const roles = Array.from(document.querySelectorAll('.role-checkbox:checked')).map(cb => cb.value);
            
            const data = {
                name: document.getElementById('skill-name').value.trim(),
                category: document.getElementById('skill-category').value,
                description: document.getElementById('skill-description').value.trim(),
                content: document.getElementById('skill-content').value.trim(),
                applicable_roles: roles.length > 0 ? roles : null
            };

            fetch('/api/skills', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    showSuccess('æŠ€èƒ½åˆ›å»ºæˆåŠŸï¼');
                    resetCreateForm();
                    switchTab('browse');
                } else {
                    showError('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            })
            .catch(err => showError('ç½‘ç»œé”™è¯¯'));
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            document.getElementById('stats-loading').classList.remove('hidden');

            // åŠ è½½æ¦‚è§ˆç»Ÿè®¡
            fetch('/api/skills/stats?type=summary')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('total-usage').textContent = data.data.total_usage_count || 0;
                        document.getElementById('avg-rating').textContent = (data.data.average_avg_response_time || 0).toFixed(2) + 's';
                    }
                });

            // åŠ è½½çƒ­é—¨æŠ€èƒ½
            fetch('/api/skills/stats?type=top&limit=5')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.data && Array.isArray(data.data) && data.data.length > 0) {
                        document.getElementById('top-skill').textContent = data.data[0].skill_name;
                        displayTopSkills(data.data);
                    }
                });

            // åŠ è½½è¯¦ç»†è®°å½•
            fetch('/api/skills/stats?type=detail')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('stats-loading').classList.add('hidden');
                    
                    if (data.status === 'success') {
                        displayUsageDetail(data.data);
                    }
                });
        }

        // æ˜¾ç¤ºçƒ­é—¨æŠ€èƒ½æ’è¡Œ
        function displayTopSkills(skills) {
            const list = document.getElementById('top-skills-list');
            list.innerHTML = '';

            skills.forEach((skill, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                const medal = index < 3 ? medals[index] : `${index + 1}.`;
                
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${medal}</span>
                        <div>
                            <p class="font-semibold text-gray-900">${escapeHtml(skill.skill_name)}</p>
                            <p class="text-sm text-gray-500">ä½¿ç”¨ ${skill.usage_count} æ¬¡</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">å¹³å‡å“åº”</p>
                        <p class="font-semibold text-purple-600">${(skill.avg_response_time || 0).toFixed(2)}s</p>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }

        // æ˜¾ç¤ºä½¿ç”¨è¯¦æƒ…è¡¨æ ¼
        function displayUsageDetail(details) {
            const tbody = document.getElementById('usage-detail-tbody');
            tbody.innerHTML = '';

            details.forEach(detail => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(detail.skill_name)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${detail.usage_count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(detail.last_used_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(detail.avg_response_time || 0).toFixed(2)}s</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('usage-detail-table').classList.remove('hidden');
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            currentCategory = document.getElementById('category-filter').value;
            currentSearch = document.getElementById('search-input').value.trim();
            currentPage = 1;
            loadSkills();
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            // ä¸Šä¸€é¡µ
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.className = `px-4 py-2 border rounded ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-purple-600 hover:bg-purple-50'}`;
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) loadSkills(currentPage - 1); };
            pagination.appendChild(prevBtn);

            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-4 py-2 border rounded ${i === currentPage ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 hover:bg-purple-50'}`;
                    pageBtn.onclick = () => loadSkills(i);
                    pagination.appendChild(pageBtn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 text-gray-500';
                    pagination.appendChild(ellipsis);
                }
            }

            // ä¸‹ä¸€é¡µ
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.className = `px-4 py-2 border rounded ${currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-purple-600 hover:bg-purple-50'}`;
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) loadSkills(currentPage + 1); };
            pagination.appendChild(nextBtn);

            pagination.classList.remove('hidden');
        }

        // å·¥å…·å‡½æ•°
        function closeSkillModal() {
            document.getElementById('skill-detail-modal').classList.add('hidden');
        }

        function togglePreview() {
            const panel = document.getElementById('markdown-preview-panel');
            const content = document.getElementById('skill-content').value;
            const preview = document.getElementById('markdown-preview-content');
            
            if (panel.classList.contains('hidden')) {
                preview.innerHTML = marked.parse(content || '(æš‚æ— å†…å®¹)');
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateContentLength() {
            const length = document.getElementById('skill-content').value.length;
            document.getElementById('content-length').textContent = `${length} å­—ç¬¦`;
        }

        function resetCreateForm() {
            document.getElementById('create-skill-form').reset();
            document.getElementById('content-length').textContent = '0 å­—ç¬¦';
            document.getElementById('markdown-preview-panel').classList.add('hidden');
        }

        function getCategoryName(category) {
            const names = {
                'policy': 'æ”¿ç­–åˆ†æ',
                'technology': 'æŠ€æœ¯è¯„ä¼°',
                'stakeholder': 'åˆ©ç›Šç›¸å…³æ–¹',
                'risk': 'é£é™©è¯„ä¼°',
                'finance': 'è´¢åŠ¡åˆ†æ',
                'other': 'å…¶ä»–'
            };
            return names[category] || 'å…¶ä»–';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        function showSuccess(message) {
            alert('âœ… ' + message);
        }

        function showError(message) {
            alert('âŒ ' + message);
        }

        // ========== Importç›¸å…³å‡½æ•° ==========
        
        let selectedPresets = new Set();
        let currentImportMode = 'presets';

        // åˆ‡æ¢å¯¼å…¥æ¨¡å¼ï¼ˆé¢„è®¾ vs è‡ªå®šä¹‰URL vs PDFä¸Šä¼ ï¼‰
        function switchImportMode(mode) {
            currentImportMode = mode;
            
            // æ‰€æœ‰æŒ‰é’®å’Œé¢æ¿
            const buttons = {
                presets: document.getElementById('import-mode-presets'),
                custom: document.getElementById('import-mode-custom'),
                pdf: document.getElementById('import-mode-pdf')
            };
            const panels = {
                presets: document.getElementById('import-presets-panel'),
                custom: document.getElementById('import-custom-panel'),
                pdf: document.getElementById('import-pdf-panel')
            };
            
            // æ›´æ–°æ ·å¼
            for (const [key, btn] of Object.entries(buttons)) {
                if (key === mode) {
                    btn.classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
                    btn.classList.add('text-gray-500');
                }
            }
            for (const [key, panel] of Object.entries(panels)) {
                if (key === mode) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            }
        }

        // åŠ è½½Anthropicé¢„è®¾æŠ€èƒ½
        function loadImportPresets() {
            const loading = document.getElementById('presets-loading');
            const list = document.getElementById('presets-list');
            const actions = document.getElementById('presets-actions');
            
            loading.classList.remove('hidden');
            list.classList.add('hidden');
            
            fetch('/api/skills/import/presets')
                .then(res => res.json())
                .then(data => {
                    loading.classList.add('hidden');
                    
                    if (data.status === 'success') {
                        displayPresets(data.data);
                        list.classList.remove('hidden');
                        actions.classList.remove('hidden');
                    } else {
                        showError('åŠ è½½é¢„è®¾å¤±è´¥: ' + data.message);
                    }
                })
                .catch(err => {
                    loading.classList.add('hidden');
                    showError('åŠ è½½é¢„è®¾å¤±è´¥: ' + err.message);
                });
        }

        // æ˜¾ç¤ºé¢„è®¾åˆ—è¡¨
        function displayPresets(presets) {
            const list = document.getElementById('presets-list');
            list.innerHTML = '';
            
            // ç¡®ä¿presetsæ˜¯æ•°ç»„
            if (!presets || !Array.isArray(presets)) {
                presets = [];
            }
            
            presets.forEach(preset => {
                const item = document.createElement('div');
                item.className = 'flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition';
                item.innerHTML = `
                    <input type="checkbox" id="preset-${preset.id}" value="${preset.id}" 
                           onchange="togglePresetSelection('${preset.id}')"
                           class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="preset-${preset.id}" class="ml-3 flex-1 cursor-pointer">
                        <div class="font-medium text-gray-900">${escapeHtml(preset.name)}</div>
                        <div class="text-sm text-gray-600 mt-1">${escapeHtml(preset.description)}</div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="category-badge category-${preset.category}">${getCategoryName(preset.category)}</span>
                            <span class="text-xs text-gray-500">æ¥æº: ${escapeHtml(preset.source)}</span>
                        </div>
                    </label>
                `;
                list.appendChild(item);
            });
        }

        // åˆ‡æ¢é¢„è®¾é€‰æ‹©
        function togglePresetSelection(presetId) {
            const checkbox = document.getElementById(`preset-${presetId}`);
            if (checkbox.checked) {
                selectedPresets.add(presetId);
            } else {
                selectedPresets.delete(presetId);
            }
            updateSelectedCount();
        }

        // æ›´æ–°å·²é€‰æ‹©æ•°é‡
        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedPresets.size;
        }

        // å…¨é€‰é¢„è®¾
        function selectAllPresets() {
            document.querySelectorAll('[id^="preset-"]').forEach(checkbox => {
                checkbox.checked = true;
                selectedPresets.add(checkbox.value);
            });
            updateSelectedCount();
        }

        // å–æ¶ˆå…¨é€‰
        function deselectAllPresets() {
            document.querySelectorAll('[id^="preset-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedPresets.clear();
            updateSelectedCount();
        }

        // å¯¼å…¥é€‰ä¸­çš„é¢„è®¾
        async function importSelectedPresets() {
            if (selectedPresets.size === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæŠ€èƒ½');
                return;
            }

            // è·å–é€‰ä¸­é¢„è®¾çš„URL
            const urls = [];
            try {
                const presetsResponse = await fetch('/api/skills/import/presets');
                const presetsData = await presetsResponse.json();
                
                if (presetsData.status === 'success' && presetsData.data && Array.isArray(presetsData.data)) {
                    presetsData.data.forEach(preset => {
                        if (selectedPresets.has(preset.id)) {
                            urls.push(preset.url);
                        }
                    });
                }
            } catch (err) {
                showError('è·å–é¢„è®¾URLå¤±è´¥: ' + err.message);
                return;
            }

            if (urls.length === 0) {
                showError('æœªæ‰¾åˆ°æœ‰æ•ˆçš„URL');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦
            showImportProgress(true);
            updateImportStatus('æ­£åœ¨æ‰¹é‡å¯¼å…¥...');
            updateProgressBar(0);

            const strictSecurity = false; // é¢„è®¾ä¸ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼

            // æ‰¹é‡å¯¼å…¥
            fetch('/api/skills/import/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ urls: urls, strict_security: strictSecurity })
            })
            .then(res => res.json())
            .then(data => {
                updateProgressBar(100);
                
                if (data.status === 'success') {
                    displayImportResults(data.data);
                    selectedPresets.clear();
                    updateSelectedCount();
                    deselectAllPresets();
                    
                    if (data.data.summary.succeeded > 0) {
                        showSuccess(`æˆåŠŸå¯¼å…¥ ${data.data.summary.succeeded}/${data.data.summary.total} ä¸ªæŠ€èƒ½`);
                    }
                } else {
                    showError('æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + data.message);
                }
                
                showImportProgress(false);
            })
            .catch(err => {
                updateProgressBar(100);
                showImportProgress(false);
                showError('æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + err.message);
            });
        }

        // ä»è‡ªå®šä¹‰URLå¯¼å…¥
        function importFromCustomUrl() {
            const urlInput = document.getElementById('custom-url-input');
            const url = urlInput.value.trim();
            
            if (!url) {
                showError('è¯·è¾“å…¥URL');
                return;
            }

            const strictSecurity = document.getElementById('strict-security-checkbox').checked;

            showImportProgress(true);
            updateImportStatus('æ­£åœ¨å¯¼å…¥: ' + url);
            updateProgressBar(50);

            fetch('/api/skills/import/url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url, strict_security: strictSecurity })
            })
            .then(res => res.json())
            .then(data => {
                updateProgressBar(100);
                
                if (data.status === 'success') {
                    displayImportResults({
                        created: [{ url: url, skill: data.data, security_score: data.security_score }],
                        errors: [],
                        summary: { total: 1, succeeded: 1, failed: 0 }
                    });
                    urlInput.value = '';
                    showSuccess('å¯¼å…¥æˆåŠŸ: ' + data.data.name);
                } else {
                    displayImportResults({
                        created: [],
                        errors: [{ url: url, error: data.message, security_issues: data.security_issues }],
                        summary: { total: 1, succeeded: 0, failed: 1 }
                    });
                    showError('å¯¼å…¥å¤±è´¥: ' + data.message);
                }
                
                showImportProgress(false);
            })
            .catch(err => {
                updateProgressBar(100);
                showImportProgress(false);
                showError('å¯¼å…¥å¤±è´¥: ' + err.message);
            });
        }

        // ä»æ‰¹é‡URLå¯¼å…¥
        function importFromBatchUrls() {
            const textarea = document.getElementById('batch-urls-input');
            const text = textarea.value.trim();
            
            if (!text) {
                showError('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªURL');
                return;
            }

            const urls = text.split('\n')
                .map(line => line.trim())
                .filter(line => line && line.startsWith('http'));

            if (urls.length === 0) {
                showError('æœªæ‰¾åˆ°æœ‰æ•ˆçš„URL');
                return;
            }

            const strictSecurity = document.getElementById('strict-security-checkbox').checked;

            showImportProgress(true);
            updateImportStatus(`æ­£åœ¨æ‰¹é‡å¯¼å…¥ ${urls.length} ä¸ªæŠ€èƒ½...`);
            updateProgressBar(0);

            fetch('/api/skills/import/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ urls: urls, strict_security: strictSecurity })
            })
            .then(res => res.json())
            .then(data => {
                updateProgressBar(100);
                
                if (data.status === 'success') {
                    displayImportResults(data.data);
                    textarea.value = '';
                    
                    if (data.data.summary.succeeded > 0) {
                        showSuccess(`æˆåŠŸå¯¼å…¥ ${data.data.summary.succeeded}/${data.data.summary.total} ä¸ªæŠ€èƒ½`);
                    }
                } else {
                    showError('æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + data.message);
                }
                
                showImportProgress(false);
            })
            .catch(err => {
                updateProgressBar(100);
                showImportProgress(false);
                showError('æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + err.message);
            });
        }

        // æ˜¾ç¤º/éšè—å¯¼å…¥è¿›åº¦
        function showImportProgress(show) {
            const progress = document.getElementById('import-progress');
            if (show) {
                progress.classList.remove('hidden');
                document.getElementById('import-results').classList.add('hidden');
            } else {
                progress.classList.add('hidden');
            }
        }

        // æ›´æ–°å¯¼å…¥çŠ¶æ€æ–‡æœ¬
        function updateImportStatus(message) {
            document.getElementById('import-status').textContent = message;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(percent) {
            document.getElementById('import-progress-bar').style.width = percent + '%';
        }

        // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
        function displayImportResults(data) {
            const results = document.getElementById('import-results');
            const list = document.getElementById('import-results-list');
            
            list.innerHTML = '';

            // æ˜¾ç¤ºæˆåŠŸå¯¼å…¥çš„æŠ€èƒ½
            data.created.forEach(item => {
                const resultItem = document.createElement('div');
                resultItem.className = 'flex items-start p-3 bg-green-50 border border-green-200 rounded-lg';
                resultItem.innerHTML = `
                    <svg class="w-5 h-5 text-green-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <div class="flex-1">
                        <div class="font-medium text-green-900">${escapeHtml(item.skill.name)}</div>
                        <div class="text-sm text-green-700 mt-1">å®‰å…¨è¯„åˆ†: ${item.security_score}/100</div>
                        <div class="text-xs text-green-600 mt-1 break-all">${escapeHtml(item.url)}</div>
                    </div>
                `;
                list.appendChild(resultItem);
            });

            // æ˜¾ç¤ºå¤±è´¥çš„å¯¼å…¥
            data.errors.forEach(error => {
                const resultItem = document.createElement('div');
                resultItem.className = 'flex items-start p-3 bg-red-50 border border-red-200 rounded-lg';
                resultItem.innerHTML = `
                    <svg class="w-5 h-5 text-red-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <div class="flex-1">
                        <div class="font-medium text-red-900">å¯¼å…¥å¤±è´¥</div>
                        <div class="text-sm text-red-700 mt-1">${escapeHtml(error.error)}</div>
                        <div class="text-xs text-red-600 mt-1 break-all">${escapeHtml(error.url)}</div>
                    </div>
                `;
                list.appendChild(resultItem);
            });

            // æ˜¾ç¤ºæ±‡æ€»
            const summary = document.createElement('div');
            summary.className = 'p-3 bg-gray-100 border border-gray-300 rounded-lg font-medium text-gray-800';
            summary.textContent = `æ€»è®¡: ${data.summary.total} | æˆåŠŸ: ${data.summary.succeeded} | å¤±è´¥: ${data.summary.failed}`;
            list.appendChild(summary);

            results.classList.remove('hidden');
        }

        // ====== AI ç”ŸæˆæŠ€èƒ½ ======

        document.getElementById('generate-skill-form').addEventListener('submit', function(e) {
            e.preventDefault();
            generateSkill();
        });

        async function generateSkill() {
            const topic = document.getElementById('gen-topic').value.trim();
            const description = document.getElementById('gen-description').value.trim();
            const category = document.getElementById('gen-category').value;
            const roles = Array.from(document.querySelectorAll('.gen-role-checkbox:checked')).map(cb => cb.value);

            if (!topic || !description) {
                showError('è¯·å¡«å†™ä¸»é¢˜å’Œæè¿°');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦
            document.getElementById('generate-form-panel').classList.add('hidden');
            document.getElementById('generate-progress').classList.remove('hidden');
            document.getElementById('generate-preview').classList.add('hidden');

            try {
                const resp = await fetch('/api/skills/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic, description, category,
                        applicable_roles: roles
                    })
                });
                const data = await resp.json();

                document.getElementById('generate-progress').classList.add('hidden');

                if (data.status === 'success') {
                    // æ˜¾ç¤ºé¢„è§ˆ
                    document.getElementById('gen-skill-md').value = data.data.skill_md;
                    document.getElementById('gen-security-badge').textContent =
                        `å®‰å…¨: ${data.data.security_score}/100`;
                    document.getElementById('gen-time-badge').textContent =
                        `è€—æ—¶: ${data.data.generation_time.toFixed(1)}s`;
                    document.getElementById('generate-preview').classList.remove('hidden');
                    switchGenView('edit');
                } else {
                    showError('ç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    document.getElementById('generate-form-panel').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('generate-progress').classList.add('hidden');
                document.getElementById('generate-form-panel').classList.remove('hidden');
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            }
        }

        function switchGenView(view) {
            if (view === 'edit') {
                document.getElementById('gen-edit-panel').classList.remove('hidden');
                document.getElementById('gen-preview-panel').classList.add('hidden');
                document.getElementById('gen-view-edit').className = 'px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600';
                document.getElementById('gen-view-preview').className = 'px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
            } else {
                const md = document.getElementById('gen-skill-md').value;
                document.getElementById('gen-preview-content').innerHTML = marked.parse(md);
                document.getElementById('gen-edit-panel').classList.add('hidden');
                document.getElementById('gen-preview-panel').classList.remove('hidden');
                document.getElementById('gen-view-edit').className = 'px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
                document.getElementById('gen-view-preview').className = 'px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600';
            }
        }

        function resetGenerate() {
            document.getElementById('generate-preview').classList.add('hidden');
            document.getElementById('generate-form-panel').classList.remove('hidden');
        }

        async function confirmGeneratedSkill() {
            const skillMd = document.getElementById('gen-skill-md').value.trim();
            if (!skillMd) {
                showError('å†…å®¹ä¸ºç©º');
                return;
            }

            const btn = document.getElementById('gen-confirm-btn');
            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';

            try {
                const resp = await fetch('/api/skills/generate/confirm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({skill_md: skillMd})
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    showSuccess('æŠ€èƒ½å·²ä¿å­˜ï¼');
                    // é‡ç½®å¹¶è·³è½¬åˆ°æŠ€èƒ½åº“
                    document.getElementById('gen-topic').value = '';
                    document.getElementById('gen-description').value = '';
                    document.getElementById('generate-preview').classList.add('hidden');
                    document.getElementById('generate-form-panel').classList.remove('hidden');
                    switchTab('browse');
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ç¡®è®¤ä¿å­˜';
            }
        }

        // ====== æŠ€èƒ½å¸‚åœº ======

        let mpCategoriesLoaded = false;

        function loadMarketplaceCategories() {
            if (mpCategoriesLoaded) return;
            fetch('/api/skills/marketplace/categories')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const select = document.getElementById('mp-category');
                        data.data.forEach(cat => {
                            const opt = document.createElement('option');
                            opt.value = cat.id;
                            opt.textContent = `${cat.name} (${cat.count ? cat.count.toLocaleString() : ''})`;
                            select.appendChild(opt);
                        });
                        mpCategoriesLoaded = true;
                    }
                })
                .catch(() => {});
        }

        // æœç´¢æ¡†å›è½¦
        document.getElementById('mp-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchMarketplace();
        });

        let mpSearchMode = 'keyword';  // keyword | ai

        function setSearchMode(mode) {
            mpSearchMode = mode;
            const btnKeyword = document.getElementById('mp-mode-keyword');
            const btnAi = document.getElementById('mp-mode-ai');
            if (mode === 'ai') {
                btnAi.className = 'px-4 py-2 text-sm font-medium bg-purple-600 text-white transition';
                btnKeyword.className = 'px-4 py-2 text-sm font-medium bg-white text-gray-600 hover:bg-gray-50 transition';
            } else {
                btnKeyword.className = 'px-4 py-2 text-sm font-medium bg-purple-600 text-white transition';
                btnAi.className = 'px-4 py-2 text-sm font-medium bg-white text-gray-600 hover:bg-gray-50 transition';
            }
        }

        async function searchMarketplace(page = 1) {
            const query = document.getElementById('mp-search').value.trim();
            const category = document.getElementById('mp-category').value;

            if (!query && !category) {
                showError('è¯·è¾“å…¥æœç´¢å…³é”®è¯æˆ–é€‰æ‹©åˆ†ç±»');
                return;
            }

            document.getElementById('mp-initial').classList.add('hidden');
            document.getElementById('mp-loading').classList.remove('hidden');
            document.getElementById('mp-pagination').classList.add('hidden');

            // ç§»é™¤å·²æœ‰çš„ç»“æœå¡ç‰‡
            document.querySelectorAll('#mp-results .mp-result-card').forEach(el => el.remove());

            try {
                const params = new URLSearchParams({page, page_size: 12, mode: mpSearchMode});
                if (query) params.append('q', query);
                if (category) params.append('category', category);

                const resp = await fetch(`/api/skills/marketplace/search?${params}`);
                const data = await resp.json();
                document.getElementById('mp-loading').classList.add('hidden');

                if (data.status === 'success' && data.data.items.length > 0) {
                    displayMarketplaceResults(data.data);
                } else if (data.status === 'success') {
                    document.getElementById('mp-initial').classList.remove('hidden');
                    document.getElementById('mp-initial').querySelector('p').textContent = 'æœªæ‰¾åˆ°ç›¸å…³æŠ€èƒ½';
                } else {
                    showError('æœç´¢å¤±è´¥: ' + (data.message || ''));
                }
            } catch (err) {
                document.getElementById('mp-loading').classList.add('hidden');
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            }
        }

        function displayMarketplaceResults(data) {
            const container = document.getElementById('mp-results');
            const items = data.items || [];
            const source = data.source;
            const isAI = source === 'skillsmp_ai';

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'mp-result-card flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-md transition';

                // æ¥æºæ ‡ç­¾é¢œè‰²
                const sourceBadge = source === 'skillsmp' ? 'bg-purple-100 text-purple-700'
                    : source === 'skillsmp_ai' ? 'bg-blue-100 text-blue-700'
                    : source === 'github' ? 'bg-gray-100 text-gray-600'
                    : 'bg-green-100 text-green-700';
                const sourceLabel = source === 'skillsmp_ai' ? 'AIåŒ¹é…' : escapeHtml(source);

                // æ˜Ÿæ ‡
                const starsHtml = item.stars ? `<span class="text-xs text-yellow-600">â˜… ${Number(item.stars).toLocaleString()}</span>` : '';

                // AIç›¸å…³åº¦åˆ†æ•°
                const scoreHtml = isAI && item.score ? `<span class="text-xs px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded-full">ç›¸å…³åº¦ ${(item.score * 100).toFixed(0)}%</span>` : '';

                // ä½œè€…
                const authorHtml = item.author ? `<span class="text-xs text-gray-400">by ${escapeHtml(item.author)}</span>` : '';

                // æ›´æ–°æ—¶é—´
                const dateHtml = item.updated_at ? `<span class="text-xs text-gray-400">${new Date(item.updated_at).toLocaleDateString()}</span>` : '';

                card.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <h4 class="font-medium text-gray-900 truncate">${escapeHtml(item.displayName || item.name)}</h4>
                            <span class="text-xs px-2 py-0.5 ${sourceBadge} rounded">${sourceLabel}</span>
                            ${starsHtml}
                            ${scoreHtml}
                        </div>
                        <p class="text-sm text-gray-500 mt-1 truncate">${escapeHtml(item.description || '')}</p>
                        <div class="flex items-center gap-3 mt-1">
                            ${authorHtml}
                            ${dateHtml}
                            ${item.category ? `<span class="text-xs text-purple-600">${escapeHtml(item.category)}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="importFromMarketplace('${escapeHtml(item.github_url || '')}', '${escapeHtml(item.slug || '')}')"
                        class="ml-4 px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                        å¯¼å…¥
                    </button>
                `;
                container.appendChild(card);
            });

            // åˆ†é¡µ (AIæœç´¢æ— åˆ†é¡µ)
            if (!isAI && data.total > data.page_size) {
                const totalPages = Math.ceil(data.total / data.page_size);
                const pag = document.getElementById('mp-pagination');
                pag.innerHTML = '';
                for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = `px-3 py-1 rounded ${i === data.page ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
                    btn.onclick = () => searchMarketplace(i);
                    pag.appendChild(btn);
                }
                pag.classList.remove('hidden');
            }
        }

        async function importFromMarketplace(githubUrl, slug) {
            if (!githubUrl && !slug) {
                showError('æ— æ³•è·å–æŠ€èƒ½çš„ä¸‹è½½åœ°å€');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'å¯¼å…¥ä¸­...';

            try {
                const resp = await fetch('/api/skills/marketplace/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({github_url: githubUrl, slug: slug})
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    btn.textContent = 'âœ“ å·²å¯¼å…¥';
                    btn.className = btn.className.replace('bg-purple-600', 'bg-green-600').replace('hover:bg-purple-700', '');
                    showSuccess(`å·²å¯¼å…¥æŠ€èƒ½: ${data.data.name || ''}`);
                } else {
                    showError('å¯¼å…¥å¤±è´¥: ' + (data.message || ''));
                    btn.disabled = false;
                    btn.textContent = 'å¯¼å…¥';
                }
            } catch (err) {
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'å¯¼å…¥';
            }
        }

        function showSuccess(msg) {
            // å¤ç”¨showErrorçš„é€»è¾‘ä½†ç”¨ç»¿è‰²
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // ====== PDF ä¸Šä¼ ç”ŸæˆæŠ€èƒ½ ======

        let selectedPdfFile = null;
        let pdfGeneratedSkills = [];  // å­˜å‚¨ç”Ÿæˆçš„æŠ€èƒ½æ•°æ®

        function handlePdfDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-purple-500', 'bg-purple-50');
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.pdf')) {
                setPdfFile(files[0]);
            } else {
                showError('è¯·ä¸Šä¼  PDF æ ¼å¼æ–‡ä»¶');
            }
        }

        function handlePdfFileSelect(input) {
            if (input.files.length > 0) {
                setPdfFile(input.files[0]);
            }
        }

        function setPdfFile(file) {
            if (file.size > 20 * 1024 * 1024) {
                showError('æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 20MB');
                return;
            }
            selectedPdfFile = file;

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('pdf-file-name').textContent = file.name;
            document.getElementById('pdf-file-size').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
            document.getElementById('pdf-file-info').classList.remove('hidden');
            document.getElementById('pdf-file-label').textContent = file.name;
            document.getElementById('pdf-upload-btn').disabled = false;
        }

        function clearPdfFile() {
            selectedPdfFile = null;
            document.getElementById('pdf-file-input').value = '';
            document.getElementById('pdf-file-info').classList.add('hidden');
            document.getElementById('pdf-file-label').innerHTML = 'æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ– <span class="text-purple-600 font-medium">ç‚¹å‡»ä¸Šä¼ </span>';
            document.getElementById('pdf-upload-btn').disabled = true;
        }

        async function uploadAndGeneratePdfSkills() {
            if (!selectedPdfFile) {
                showError('è¯·å…ˆé€‰æ‹© PDF æ–‡ä»¶');
                return;
            }

            const mode = document.querySelector('input[name="pdf-mode"]:checked').value;
            const category = document.getElementById('pdf-category').value;
            const topicHint = document.getElementById('pdf-topic-hint').value.trim();
            const roles = Array.from(document.querySelectorAll('.pdf-role-checkbox:checked')).map(cb => cb.value);

            // æ„å»º FormData
            const formData = new FormData();
            formData.append('file', selectedPdfFile);
            formData.append('mode', mode);
            formData.append('category', category);
            formData.append('topic_hint', topicHint);
            formData.append('applicable_roles', JSON.stringify(roles));

            // åˆ‡æ¢åˆ°è¿›åº¦è§†å›¾
            document.getElementById('pdf-upload-form').classList.add('hidden');
            document.getElementById('pdf-progress').classList.remove('hidden');
            document.getElementById('pdf-results').classList.add('hidden');

            try {
                const resp = await fetch('/api/skills/import/pdf', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();

                document.getElementById('pdf-progress').classList.add('hidden');

                if (data.status === 'success') {
                    pdfGeneratedSkills = data.data.skills;
                    displayPdfResults(data.data);
                } else {
                    showError('ç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    document.getElementById('pdf-upload-form').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('pdf-progress').classList.add('hidden');
                document.getElementById('pdf-upload-form').classList.remove('hidden');
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            }
        }

        function displayPdfResults(data) {
            const skills = data.skills || [];
            const pdfInfo = data.pdf_info || {};

            // ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('pdf-result-count').textContent = `ï¼ˆ${skills.length} ä¸ªæŠ€èƒ½ï¼‰`;
            document.getElementById('pdf-info-badge').textContent =
                `${pdfInfo.pages || '?'} é¡µ / ${((pdfInfo.chars || 0) / 1000).toFixed(1)}K å­—ç¬¦` +
                (pdfInfo.truncated ? ' (å·²æˆªæ–­)' : '');
            document.getElementById('pdf-time-badge').textContent =
                `è€—æ—¶: ${(data.generation_time || 0).toFixed(1)}s`;

            // æ¸²æŸ“æŠ€èƒ½å¡ç‰‡
            const container = document.getElementById('pdf-skills-list');
            container.innerHTML = '';

            skills.forEach((skill, index) => {
                const skillData = skill.skill_data || {};
                const name = skillData.displayName || skillData.name || skill.topic || `æŠ€èƒ½ ${index + 1}`;
                const secScore = skill.security_score;
                const secBadge = secScore != null
                    ? `<span class="text-sm px-2 py-0.5 rounded-full ${secScore >= 70 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">å®‰å…¨: ${secScore}</span>`
                    : '';
                const warning = skillData.warning
                    ? `<span class="text-sm text-yellow-600">âš  ${escapeHtml(skillData.warning)}</span>`
                    : '';

                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg overflow-hidden';
                card.innerHTML = `
                    <div class="flex items-center justify-between px-4 py-3 bg-gray-50 cursor-pointer" onclick="togglePdfSkillCard(${index})">
                        <div class="flex items-center gap-3">
                            <span class="font-medium text-gray-800">${escapeHtml(name)}</span>
                            ${secBadge}
                            ${warning}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">${(skill.skill_md || '').split('\\n').length} è¡Œ</span>
                            <svg id="pdf-skill-arrow-${index}" class="w-5 h-5 text-gray-400 transform transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                    </div>
                    <div id="pdf-skill-body-${index}" class="hidden p-4">
                        <div class="flex border-b border-gray-200 mb-3">
                            <button onclick="switchPdfSkillView(${index}, 'edit')" id="pdf-view-edit-${index}" class="px-3 py-1.5 text-sm font-medium text-purple-600 border-b-2 border-purple-600">ç¼–è¾‘</button>
                            <button onclick="switchPdfSkillView(${index}, 'preview')" id="pdf-view-preview-${index}" class="px-3 py-1.5 text-sm font-medium text-gray-500 hover:text-gray-700">é¢„è§ˆ</button>
                        </div>
                        <div id="pdf-edit-${index}">
                            <textarea id="pdf-skill-md-${index}" rows="15" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-600 focus:border-transparent">${escapeHtml(skill.skill_md || '')}</textarea>
                        </div>
                        <div id="pdf-preview-${index}" class="hidden">
                            <div class="markdown-preview border border-gray-200 rounded-lg p-4 bg-gray-50 min-h-[200px] text-sm"></div>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button onclick="saveSinglePdfSkill(${index})" class="px-4 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition">
                                ä¿å­˜æ­¤æŠ€èƒ½
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('pdf-results').classList.remove('hidden');
        }

        function togglePdfSkillCard(index) {
            const body = document.getElementById(`pdf-skill-body-${index}`);
            const arrow = document.getElementById(`pdf-skill-arrow-${index}`);
            body.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        function switchPdfSkillView(index, view) {
            const editPanel = document.getElementById(`pdf-edit-${index}`);
            const previewPanel = document.getElementById(`pdf-preview-${index}`);
            const editBtn = document.getElementById(`pdf-view-edit-${index}`);
            const previewBtn = document.getElementById(`pdf-view-preview-${index}`);

            if (view === 'edit') {
                editPanel.classList.remove('hidden');
                previewPanel.classList.add('hidden');
                editBtn.className = 'px-3 py-1.5 text-sm font-medium text-purple-600 border-b-2 border-purple-600';
                previewBtn.className = 'px-3 py-1.5 text-sm font-medium text-gray-500 hover:text-gray-700';
            } else {
                const md = document.getElementById(`pdf-skill-md-${index}`).value;
                previewPanel.querySelector('.markdown-preview').innerHTML = marked.parse(md);
                editPanel.classList.add('hidden');
                previewPanel.classList.remove('hidden');
                editBtn.className = 'px-3 py-1.5 text-sm font-medium text-gray-500 hover:text-gray-700';
                previewBtn.className = 'px-3 py-1.5 text-sm font-medium text-purple-600 border-b-2 border-purple-600';
            }
        }

        async function saveSinglePdfSkill(index) {
            const skillMd = document.getElementById(`pdf-skill-md-${index}`).value.trim();
            if (!skillMd) {
                showError('æŠ€èƒ½å†…å®¹ä¸ºç©º');
                return;
            }

            try {
                const resp = await fetch('/api/skills/generate/confirm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({skill_md: skillMd})
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    showSuccess(`æŠ€èƒ½å·²ä¿å­˜: ${data.data.display_name || data.data.name || ''}`);
                    // æ ‡è®°å·²ä¿å­˜
                    const card = document.getElementById(`pdf-skill-body-${index}`).parentElement;
                    card.querySelector('.bg-gray-50').classList.add('bg-green-50');
                    card.querySelector('.font-medium').innerHTML += ' <span class="text-green-600 text-xs">âœ“ å·²ä¿å­˜</span>';
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + (data.message || ''));
                }
            } catch (err) {
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            }
        }

        async function saveAllPdfSkills() {
            const btn = document.getElementById('pdf-save-all-btn');
            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';

            let saved = 0, failed = 0;
            for (let i = 0; i < pdfGeneratedSkills.length; i++) {
                const skillMd = document.getElementById(`pdf-skill-md-${i}`).value.trim();
                if (!skillMd) continue;

                try {
                    const resp = await fetch('/api/skills/generate/confirm', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({skill_md: skillMd})
                    });
                    const data = await resp.json();
                    if (data.status === 'success') {
                        saved++;
                        const card = document.getElementById(`pdf-skill-body-${i}`).parentElement;
                        card.querySelector('.bg-gray-50').classList.add('bg-green-50');
                    } else {
                        failed++;
                    }
                } catch {
                    failed++;
                }
            }

            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> å…¨éƒ¨ä¿å­˜';

            if (failed === 0) {
                showSuccess(`å…¨éƒ¨ ${saved} ä¸ªæŠ€èƒ½å·²ä¿å­˜ï¼`);
            } else {
                showSuccess(`å·²ä¿å­˜ ${saved} ä¸ªæŠ€èƒ½ï¼Œ${failed} ä¸ªå¤±è´¥`);
            }
        }

        function resetPdfUpload() {
            clearPdfFile();
            pdfGeneratedSkills = [];
            document.getElementById('pdf-results').classList.add('hidden');
            document.getElementById('pdf-upload-form').classList.remove('hidden');
        }
    </script>
</body>
</html>
